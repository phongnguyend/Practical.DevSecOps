{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.37.4.10188",
      "templateHash": "17844529776973520179"
    }
  },
  "parameters": {
    "general": {
      "type": "object",
      "defaultValue": {
        "location": "southeastasia",
        "environment": "dev"
      }
    },
    "featureFlags": {
      "type": "object",
      "defaultValue": {
        "enablePrivateEndpoints": false,
        "enableVNetIntegration": false,
        "enableTestVM": false,
        "enableSqlServer": false,
        "enableKeyVault": false,
        "enableAppConfiguration": false,
        "enableStorageAccount": false,
        "enableCosmosDb": false,
        "enableFunctionApps": false,
        "enableServiceBus": false,
        "enableApplicationInsights": false
      }
    },
    "networking": {
      "type": "object",
      "defaultValue": {
        "vnetName": "PracticalMultipleResourceGroups-vnet",
        "resourceGroup": "practical-pe-networking-rg",
        "privateDnsZones": {
          "appConfig": "privatelink.azconfig.io",
          "blobStorage": "privatelink.blob.core.windows.net",
          "cosmos": "privatelink.documents.azure.com",
          "serviceBus": "privatelink.servicebus.windows.net",
          "appService": "privatelink.azurewebsites.net",
          "keyVault": "privatelink.vaultcore.azure.net"
        }
      }
    },
    "sql": {
      "type": "object",
      "defaultValue": {
        "serverName": "PracticalMultipleResourceGroups",
        "adminUsername": "PracticalMultipleResourceGroups",
        "databases": {
          "customerDb": "PracticalMultipleResourceGroups-CUSTOMER-DB",
          "adminDb": "PracticalMultipleResourceGroups-ADMIN-DB",
          "videoDb": "PracticalMultipleResourceGroups-VIDEO-DB",
          "musicDb": "PracticalMultipleResourceGroups-MUSIC-DB"
        }
      }
    },
    "webApps": {
      "type": "object",
      "defaultValue": {
        "appServicePlanName": "PracticalMultipleResourceGroups",
        "apps": {
          "customerPublic": "PracticalMultipleResourceGroups-CUSTOMER-PUBLIC",
          "customerSite": "PracticalMultipleResourceGroups-CUSTOMER-SITE",
          "adminPublic": "PracticalMultipleResourceGroups-ADMIN-PUBLIC",
          "adminSite": "PracticalMultipleResourceGroups-ADMIN-SITE",
          "videoApi": "PracticalMultipleResourceGroups-VIDEO-API",
          "musicApi": "PracticalMultipleResourceGroups-MUSIC-API"
        }
      }
    },
    "storage": {
      "type": "object",
      "defaultValue": {
        "mainAccount": {
          "name": "practicalmrgblob",
          "type": "Standard_LRS",
          "containers": [
            "documents",
            "images",
            "backups",
            "logs"
          ]
        },
        "functionApps": {
          "name": "practicalmrgfuncappsst",
          "type": "Standard_LRS"
        }
      }
    },
    "cosmos": {
      "type": "object",
      "defaultValue": {
        "accountName": "[format('practicalmrg-cosmos-{0}', uniqueString(resourceGroup().id))]",
        "consistencyLevel": "Session",
        "enableAutomaticFailover": true,
        "databases": {
          "adminDb": "PracticalMultipleResourceGroups-ADMIN-COSMOS-DB",
          "customerDb": "PracticalMultipleResourceGroups-CUSTOMER-COSMOS-DB",
          "musicDb": "PracticalMultipleResourceGroups-MUSIC-COSMOS-DB",
          "videoDb": "PracticalMultipleResourceGroups-VIDEO-COSMOS-DB"
        }
      }
    },
    "functions": {
      "type": "object",
      "defaultValue": {
        "apps": {
          "admin": "PracticalMultipleResourceGroups-ADMIN-FUNC",
          "customer": "PracticalMultipleResourceGroups-CUSTOMER-FUNC",
          "music": "PracticalMultipleResourceGroups-MUSIC-FUNC",
          "video": "PracticalMultipleResourceGroups-VIDEO-FUNC"
        }
      }
    },
    "serviceBus": {
      "type": "object",
      "defaultValue": {
        "namespaceName": "[format('PracticalMultipleResourceGroups-sb-{0}', uniqueString(resourceGroup().id))]",
        "sku": "Premium",
        "capacity": 1,
        "topicNames": [
          "customer-events",
          "admin-events",
          "video-events",
          "music-events"
        ],
        "queueNames": [
          "customer-queue",
          "admin-queue",
          "video-queue",
          "music-queue"
        ],
        "subscriptions": [
          {
            "topicName": "customer-events",
            "subscriptionName": "customer-subscription"
          },
          {
            "topicName": "admin-events",
            "subscriptionName": "admin-subscription"
          },
          {
            "topicName": "video-events",
            "subscriptionName": "video-subscription"
          },
          {
            "topicName": "music-events",
            "subscriptionName": "music-subscription"
          }
        ]
      }
    },
    "applicationInsights": {
      "type": "object",
      "defaultValue": {
        "workspaceName": "PracticalMultipleResourceGroups-law",
        "retentionInDays": 30
      }
    },
    "testVm": {
      "type": "object",
      "defaultValue": {
        "adminUsername": "testadmin"
      }
    },
    "keyVault": {
      "type": "object",
      "defaultValue": {
        "name": "practicalmrgkv"
      }
    },
    "appConfiguration": {
      "type": "object",
      "defaultValue": {
        "name": "PracticalMultipleResourceGroups-config"
      }
    },
    "adminPassword": {
      "type": "securestring",
      "defaultValue": ""
    },
    "vmAdminPassword": {
      "type": "securestring",
      "defaultValue": ""
    },
    "networkingLayerResourceGroup": {
      "type": "string",
      "defaultValue": "[parameters('networking').resourceGroup]",
      "metadata": {
        "description": "Resource group of the networking-layer deployment"
      }
    }
  },
  "variables": {
    "commonTags": {
      "Environment": "[parameters('general').environment]",
      "Project": "PracticalMultipleResourceGroups"
    }
  },
  "resources": [
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "privateDnsZonesDeployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "privateDnsZonesResourceGroup": {
            "value": "[parameters('networking').resourceGroup]"
          },
          "appConfigPrivateDnsZoneName": {
            "value": "[parameters('networking').privateDnsZones.appConfig]"
          },
          "blobStoragePrivateDnsZoneName": {
            "value": "[parameters('networking').privateDnsZones.blobStorage]"
          },
          "cosmosPrivateDnsZoneName": {
            "value": "[parameters('networking').privateDnsZones.cosmos]"
          },
          "serviceBusPrivateDnsZoneName": {
            "value": "[parameters('networking').privateDnsZones.serviceBus]"
          },
          "appServicePrivateDnsZoneName": {
            "value": "[parameters('networking').privateDnsZones.appService]"
          },
          "keyVaultPrivateDnsZoneName": {
            "value": "[parameters('networking').privateDnsZones.keyVault]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.37.4.10188",
              "templateHash": "16649808160997836346"
            }
          },
          "parameters": {
            "privateDnsZonesResourceGroup": {
              "type": "string",
              "metadata": {
                "description": "Resource group of the networking-layer deployment"
              }
            },
            "appConfigPrivateDnsZoneName": {
              "type": "string",
              "defaultValue": "privatelink.azconfig.io",
              "metadata": {
                "description": "Private DNS Zone Name for App Configuration"
              }
            },
            "blobStoragePrivateDnsZoneName": {
              "type": "string",
              "defaultValue": "[format('privatelink.blob.{0}', environment().suffixes.storage)]",
              "metadata": {
                "description": "Private DNS Zone Name for Blob Storage"
              }
            },
            "fileStoragePrivateDnsZoneName": {
              "type": "string",
              "defaultValue": "[format('privatelink.file.{0}', environment().suffixes.storage)]",
              "metadata": {
                "description": "Private DNS Zone Name for File Storage"
              }
            },
            "queueStoragePrivateDnsZoneName": {
              "type": "string",
              "defaultValue": "[format('privatelink.queue.{0}', environment().suffixes.storage)]",
              "metadata": {
                "description": "Private DNS Zone Name for Queue Storage"
              }
            },
            "tableStoragePrivateDnsZoneName": {
              "type": "string",
              "defaultValue": "[format('privatelink.table.{0}', environment().suffixes.storage)]",
              "metadata": {
                "description": "Private DNS Zone Name for Table Storage"
              }
            },
            "cosmosPrivateDnsZoneName": {
              "type": "string",
              "defaultValue": "privatelink.documents.azure.com",
              "metadata": {
                "description": "Private DNS Zone Name for Cosmos DB"
              }
            },
            "serviceBusPrivateDnsZoneName": {
              "type": "string",
              "defaultValue": "privatelink.servicebus.windows.net",
              "metadata": {
                "description": "Private DNS Zone Name for Service Bus"
              }
            },
            "appServicePrivateDnsZoneName": {
              "type": "string",
              "defaultValue": "privatelink.azurewebsites.net",
              "metadata": {
                "description": "Private DNS Zone Name for App Service"
              }
            },
            "keyVaultPrivateDnsZoneName": {
              "type": "string",
              "defaultValue": "privatelink.vaultcore.azure.net",
              "metadata": {
                "description": "Private DNS Zone Name for Key Vault"
              }
            }
          },
          "variables": {
            "appConfigPrivateDnsZoneId": "[resourceId(parameters('privateDnsZonesResourceGroup'), 'Microsoft.Network/privateDnsZones', parameters('appConfigPrivateDnsZoneName'))]",
            "blobStoragePrivateDnsZoneId": "[resourceId(parameters('privateDnsZonesResourceGroup'), 'Microsoft.Network/privateDnsZones', parameters('blobStoragePrivateDnsZoneName'))]",
            "fileStoragePrivateDnsZoneId": "[resourceId(parameters('privateDnsZonesResourceGroup'), 'Microsoft.Network/privateDnsZones', parameters('fileStoragePrivateDnsZoneName'))]",
            "queueStoragePrivateDnsZoneId": "[resourceId(parameters('privateDnsZonesResourceGroup'), 'Microsoft.Network/privateDnsZones', parameters('queueStoragePrivateDnsZoneName'))]",
            "tableStoragePrivateDnsZoneId": "[resourceId(parameters('privateDnsZonesResourceGroup'), 'Microsoft.Network/privateDnsZones', parameters('tableStoragePrivateDnsZoneName'))]",
            "cosmosPrivateDnsZoneId": "[resourceId(parameters('privateDnsZonesResourceGroup'), 'Microsoft.Network/privateDnsZones', parameters('cosmosPrivateDnsZoneName'))]",
            "serviceBusPrivateDnsZoneId": "[resourceId(parameters('privateDnsZonesResourceGroup'), 'Microsoft.Network/privateDnsZones', parameters('serviceBusPrivateDnsZoneName'))]",
            "appServicePrivateDnsZoneId": "[resourceId(parameters('privateDnsZonesResourceGroup'), 'Microsoft.Network/privateDnsZones', parameters('appServicePrivateDnsZoneName'))]",
            "keyVaultPrivateDnsZoneId": "[resourceId(parameters('privateDnsZonesResourceGroup'), 'Microsoft.Network/privateDnsZones', parameters('keyVaultPrivateDnsZoneName'))]"
          },
          "resources": [],
          "outputs": {
            "appConfigPrivateDnsZoneId": {
              "type": "string",
              "metadata": {
                "description": "Private DNS Zone ID for App Configuration"
              },
              "value": "[variables('appConfigPrivateDnsZoneId')]"
            },
            "blobStoragePrivateDnsZoneId": {
              "type": "string",
              "metadata": {
                "description": "Private DNS Zone ID for Blob Storage"
              },
              "value": "[variables('blobStoragePrivateDnsZoneId')]"
            },
            "fileStoragePrivateDnsZoneId": {
              "type": "string",
              "metadata": {
                "description": "Private DNS Zone ID for File Storage"
              },
              "value": "[variables('fileStoragePrivateDnsZoneId')]"
            },
            "queueStoragePrivateDnsZoneId": {
              "type": "string",
              "metadata": {
                "description": "Private DNS Zone ID for Queue Storage"
              },
              "value": "[variables('queueStoragePrivateDnsZoneId')]"
            },
            "tableStoragePrivateDnsZoneId": {
              "type": "string",
              "metadata": {
                "description": "Private DNS Zone ID for Table Storage"
              },
              "value": "[variables('tableStoragePrivateDnsZoneId')]"
            },
            "cosmosPrivateDnsZoneId": {
              "type": "string",
              "metadata": {
                "description": "Private DNS Zone ID for Cosmos DB"
              },
              "value": "[variables('cosmosPrivateDnsZoneId')]"
            },
            "serviceBusPrivateDnsZoneId": {
              "type": "string",
              "metadata": {
                "description": "Private DNS Zone ID for Service Bus"
              },
              "value": "[variables('serviceBusPrivateDnsZoneId')]"
            },
            "appServicePrivateDnsZoneId": {
              "type": "string",
              "metadata": {
                "description": "Private DNS Zone ID for App Service"
              },
              "value": "[variables('appServicePrivateDnsZoneId')]"
            },
            "keyVaultPrivateDnsZoneId": {
              "type": "string",
              "metadata": {
                "description": "Private DNS Zone ID for Key Vault"
              },
              "value": "[variables('keyVaultPrivateDnsZoneId')]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "virtualNetworkDeployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "vnetResourceGroup": {
            "value": "[parameters('networkingLayerResourceGroup')]"
          },
          "vnetName": {
            "value": "[parameters('networking').vnetName]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.37.4.10188",
              "templateHash": "15553570294851252553"
            }
          },
          "parameters": {
            "vnetResourceGroup": {
              "type": "string",
              "metadata": {
                "description": "Resource group of the existing virtual network (from networking-layer)"
              }
            },
            "vnetName": {
              "type": "string",
              "metadata": {
                "description": "Name of the existing virtual network (from networking-layer)"
              }
            }
          },
          "resources": [],
          "outputs": {
            "vnetId": {
              "type": "string",
              "value": "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('vnetResourceGroup')), 'Microsoft.Network/virtualNetworks', parameters('vnetName'))]"
            },
            "vnetName": {
              "type": "string",
              "value": "[parameters('vnetName')]"
            },
            "appGatewaySubnetId": {
              "type": "string",
              "value": "[format('{0}/subnets/AppGatewaySubnet', extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('vnetResourceGroup')), 'Microsoft.Network/virtualNetworks', parameters('vnetName')))]"
            },
            "privateEndpointSubnetId": {
              "type": "string",
              "value": "[format('{0}/subnets/PrivateEndpointSubnet', extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('vnetResourceGroup')), 'Microsoft.Network/virtualNetworks', parameters('vnetName')))]"
            },
            "testVMSubnetId": {
              "type": "string",
              "value": "[format('{0}/subnets/TestVMSubnet', extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('vnetResourceGroup')), 'Microsoft.Network/virtualNetworks', parameters('vnetName')))]"
            },
            "apiManagementSubnetId": {
              "type": "string",
              "value": "[format('{0}/subnets/APIManagementSubnet', extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('vnetResourceGroup')), 'Microsoft.Network/virtualNetworks', parameters('vnetName')))]"
            },
            "vnetIntegrationSubnetId": {
              "type": "string",
              "value": "[format('{0}/subnets/VNetIntegrationSubnet', extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('vnetResourceGroup')), 'Microsoft.Network/virtualNetworks', parameters('vnetName')))]"
            }
          }
        }
      }
    },
    {
      "condition": "[parameters('featureFlags').enableSqlServer]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "sqlServerDeployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('general').location]"
          },
          "sqlServerName": {
            "value": "[parameters('sql').serverName]"
          },
          "adminUsername": {
            "value": "[parameters('sql').adminUsername]"
          },
          "adminPassword": {
            "value": "[parameters('adminPassword')]"
          },
          "allowedSubnets": "[if(parameters('featureFlags').enableVNetIntegration, createObject('value', createArray(reference(resourceId('Microsoft.Resources/deployments', 'virtualNetworkDeployment'), '2022-09-01').outputs.vnetIntegrationSubnetId.value)), createObject('value', createArray()))]",
          "tags": {
            "value": "[variables('commonTags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.37.4.10188",
              "templateHash": "4344293760013373700"
            }
          },
          "parameters": {
            "location": {
              "type": "string"
            },
            "sqlServerName": {
              "type": "string"
            },
            "adminUsername": {
              "type": "string"
            },
            "adminPassword": {
              "type": "securestring"
            },
            "tags": {
              "type": "object",
              "defaultValue": {}
            },
            "allowedSubnets": {
              "type": "array",
              "defaultValue": []
            }
          },
          "resources": [
            {
              "type": "Microsoft.Sql/servers",
              "apiVersion": "2023-08-01",
              "name": "[parameters('sqlServerName')]",
              "location": "[parameters('location')]",
              "properties": {
                "administratorLogin": "[parameters('adminUsername')]",
                "administratorLoginPassword": "[parameters('adminPassword')]",
                "version": "12.0"
              },
              "tags": "[parameters('tags')]"
            },
            {
              "type": "Microsoft.Sql/servers/firewallRules",
              "apiVersion": "2023-08-01",
              "name": "[format('{0}/{1}', parameters('sqlServerName'), 'AllowAllAzureIPs')]",
              "properties": {
                "startIpAddress": "0.0.0.0",
                "endIpAddress": "0.0.0.0"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Sql/servers', parameters('sqlServerName'))]"
              ]
            },
            {
              "copy": {
                "name": "virtualNetworkRules",
                "count": "[length(parameters('allowedSubnets'))]"
              },
              "condition": "[not(empty(parameters('allowedSubnets')))]",
              "type": "Microsoft.Sql/servers/virtualNetworkRules",
              "apiVersion": "2023-08-01",
              "name": "[format('{0}/{1}', parameters('sqlServerName'), format('VNetIntegrationRule-{0}', copyIndex()))]",
              "properties": {
                "virtualNetworkSubnetId": "[parameters('allowedSubnets')[copyIndex()]]",
                "ignoreMissingVnetServiceEndpoint": false
              },
              "dependsOn": [
                "[resourceId('Microsoft.Sql/servers', parameters('sqlServerName'))]"
              ]
            }
          ],
          "outputs": {
            "sqlServerId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Sql/servers', parameters('sqlServerName'))]"
            },
            "sqlServerName": {
              "type": "string",
              "value": "[parameters('sqlServerName')]"
            },
            "sqlServerFqdn": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Sql/servers', parameters('sqlServerName')), '2023-08-01').fullyQualifiedDomainName]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'virtualNetworkDeployment')]"
      ]
    },
    {
      "condition": "[parameters('featureFlags').enableSqlServer]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "customerDatabaseDeployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('general').location]"
          },
          "sqlServerName": {
            "value": "[parameters('sql').serverName]"
          },
          "databaseName": {
            "value": "[parameters('sql').databases.customerDb]"
          },
          "tags": {
            "value": "[variables('commonTags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.37.4.10188",
              "templateHash": "5443413848528150338"
            }
          },
          "parameters": {
            "location": {
              "type": "string"
            },
            "sqlServerName": {
              "type": "string"
            },
            "databaseName": {
              "type": "string"
            },
            "collation": {
              "type": "string",
              "defaultValue": "SQL_Latin1_General_CP1_CI_AS"
            },
            "maxSizeBytes": {
              "type": "int",
              "defaultValue": 2147483648
            },
            "backupStorageRedundancy": {
              "type": "string",
              "defaultValue": "Local"
            },
            "skuName": {
              "type": "string",
              "defaultValue": "Basic"
            },
            "skuTier": {
              "type": "string",
              "defaultValue": "Basic"
            },
            "tags": {
              "type": "object",
              "defaultValue": {}
            }
          },
          "resources": [
            {
              "type": "Microsoft.Sql/servers/databases",
              "apiVersion": "2023-08-01",
              "name": "[format('{0}/{1}', parameters('sqlServerName'), parameters('databaseName'))]",
              "location": "[parameters('location')]",
              "properties": {
                "collation": "[parameters('collation')]",
                "maxSizeBytes": "[parameters('maxSizeBytes')]",
                "requestedBackupStorageRedundancy": "[parameters('backupStorageRedundancy')]"
              },
              "sku": {
                "name": "[parameters('skuName')]",
                "tier": "[parameters('skuTier')]"
              },
              "tags": "[parameters('tags')]"
            }
          ],
          "outputs": {
            "databaseId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Sql/servers/databases', parameters('sqlServerName'), parameters('databaseName'))]"
            },
            "databaseName": {
              "type": "string",
              "value": "[parameters('databaseName')]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'sqlServerDeployment')]"
      ]
    },
    {
      "condition": "[parameters('featureFlags').enableSqlServer]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "adminDatabaseDeployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('general').location]"
          },
          "sqlServerName": {
            "value": "[parameters('sql').serverName]"
          },
          "databaseName": {
            "value": "[parameters('sql').databases.adminDb]"
          },
          "tags": {
            "value": "[variables('commonTags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.37.4.10188",
              "templateHash": "5443413848528150338"
            }
          },
          "parameters": {
            "location": {
              "type": "string"
            },
            "sqlServerName": {
              "type": "string"
            },
            "databaseName": {
              "type": "string"
            },
            "collation": {
              "type": "string",
              "defaultValue": "SQL_Latin1_General_CP1_CI_AS"
            },
            "maxSizeBytes": {
              "type": "int",
              "defaultValue": 2147483648
            },
            "backupStorageRedundancy": {
              "type": "string",
              "defaultValue": "Local"
            },
            "skuName": {
              "type": "string",
              "defaultValue": "Basic"
            },
            "skuTier": {
              "type": "string",
              "defaultValue": "Basic"
            },
            "tags": {
              "type": "object",
              "defaultValue": {}
            }
          },
          "resources": [
            {
              "type": "Microsoft.Sql/servers/databases",
              "apiVersion": "2023-08-01",
              "name": "[format('{0}/{1}', parameters('sqlServerName'), parameters('databaseName'))]",
              "location": "[parameters('location')]",
              "properties": {
                "collation": "[parameters('collation')]",
                "maxSizeBytes": "[parameters('maxSizeBytes')]",
                "requestedBackupStorageRedundancy": "[parameters('backupStorageRedundancy')]"
              },
              "sku": {
                "name": "[parameters('skuName')]",
                "tier": "[parameters('skuTier')]"
              },
              "tags": "[parameters('tags')]"
            }
          ],
          "outputs": {
            "databaseId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Sql/servers/databases', parameters('sqlServerName'), parameters('databaseName'))]"
            },
            "databaseName": {
              "type": "string",
              "value": "[parameters('databaseName')]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'sqlServerDeployment')]"
      ]
    },
    {
      "condition": "[parameters('featureFlags').enableSqlServer]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "videoDatabaseDeployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('general').location]"
          },
          "sqlServerName": {
            "value": "[parameters('sql').serverName]"
          },
          "databaseName": {
            "value": "[parameters('sql').databases.videoDb]"
          },
          "tags": {
            "value": "[variables('commonTags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.37.4.10188",
              "templateHash": "5443413848528150338"
            }
          },
          "parameters": {
            "location": {
              "type": "string"
            },
            "sqlServerName": {
              "type": "string"
            },
            "databaseName": {
              "type": "string"
            },
            "collation": {
              "type": "string",
              "defaultValue": "SQL_Latin1_General_CP1_CI_AS"
            },
            "maxSizeBytes": {
              "type": "int",
              "defaultValue": 2147483648
            },
            "backupStorageRedundancy": {
              "type": "string",
              "defaultValue": "Local"
            },
            "skuName": {
              "type": "string",
              "defaultValue": "Basic"
            },
            "skuTier": {
              "type": "string",
              "defaultValue": "Basic"
            },
            "tags": {
              "type": "object",
              "defaultValue": {}
            }
          },
          "resources": [
            {
              "type": "Microsoft.Sql/servers/databases",
              "apiVersion": "2023-08-01",
              "name": "[format('{0}/{1}', parameters('sqlServerName'), parameters('databaseName'))]",
              "location": "[parameters('location')]",
              "properties": {
                "collation": "[parameters('collation')]",
                "maxSizeBytes": "[parameters('maxSizeBytes')]",
                "requestedBackupStorageRedundancy": "[parameters('backupStorageRedundancy')]"
              },
              "sku": {
                "name": "[parameters('skuName')]",
                "tier": "[parameters('skuTier')]"
              },
              "tags": "[parameters('tags')]"
            }
          ],
          "outputs": {
            "databaseId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Sql/servers/databases', parameters('sqlServerName'), parameters('databaseName'))]"
            },
            "databaseName": {
              "type": "string",
              "value": "[parameters('databaseName')]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'sqlServerDeployment')]"
      ]
    },
    {
      "condition": "[parameters('featureFlags').enableSqlServer]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "musicDatabaseDeployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('general').location]"
          },
          "sqlServerName": {
            "value": "[parameters('sql').serverName]"
          },
          "databaseName": {
            "value": "[parameters('sql').databases.musicDb]"
          },
          "tags": {
            "value": "[variables('commonTags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.37.4.10188",
              "templateHash": "5443413848528150338"
            }
          },
          "parameters": {
            "location": {
              "type": "string"
            },
            "sqlServerName": {
              "type": "string"
            },
            "databaseName": {
              "type": "string"
            },
            "collation": {
              "type": "string",
              "defaultValue": "SQL_Latin1_General_CP1_CI_AS"
            },
            "maxSizeBytes": {
              "type": "int",
              "defaultValue": 2147483648
            },
            "backupStorageRedundancy": {
              "type": "string",
              "defaultValue": "Local"
            },
            "skuName": {
              "type": "string",
              "defaultValue": "Basic"
            },
            "skuTier": {
              "type": "string",
              "defaultValue": "Basic"
            },
            "tags": {
              "type": "object",
              "defaultValue": {}
            }
          },
          "resources": [
            {
              "type": "Microsoft.Sql/servers/databases",
              "apiVersion": "2023-08-01",
              "name": "[format('{0}/{1}', parameters('sqlServerName'), parameters('databaseName'))]",
              "location": "[parameters('location')]",
              "properties": {
                "collation": "[parameters('collation')]",
                "maxSizeBytes": "[parameters('maxSizeBytes')]",
                "requestedBackupStorageRedundancy": "[parameters('backupStorageRedundancy')]"
              },
              "sku": {
                "name": "[parameters('skuName')]",
                "tier": "[parameters('skuTier')]"
              },
              "tags": "[parameters('tags')]"
            }
          ],
          "outputs": {
            "databaseId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Sql/servers/databases', parameters('sqlServerName'), parameters('databaseName'))]"
            },
            "databaseName": {
              "type": "string",
              "value": "[parameters('databaseName')]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'sqlServerDeployment')]"
      ]
    },
    {
      "condition": "[parameters('featureFlags').enableKeyVault]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "keyVaultDeployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('general').location]"
          },
          "keyVaultName": {
            "value": "[parameters('keyVault').name]"
          },
          "allowedSubnets": "[if(parameters('featureFlags').enableVNetIntegration, createObject('value', createArray(reference(resourceId('Microsoft.Resources/deployments', 'virtualNetworkDeployment'), '2022-09-01').outputs.vnetIntegrationSubnetId.value)), createObject('value', createArray()))]",
          "createPrivateEndpoint": {
            "value": "[parameters('featureFlags').enablePrivateEndpoints]"
          },
          "privateEndpointSubnetId": "[if(parameters('featureFlags').enablePrivateEndpoints, createObject('value', reference(resourceId('Microsoft.Resources/deployments', 'virtualNetworkDeployment'), '2022-09-01').outputs.privateEndpointSubnetId.value), createObject('value', ''))]",
          "privateDnsZoneId": "[if(and(parameters('featureFlags').enablePrivateEndpoints, parameters('featureFlags').enableKeyVault), createObject('value', reference(resourceId('Microsoft.Resources/deployments', 'privateDnsZonesDeployment'), '2022-09-01').outputs.keyVaultPrivateDnsZoneId.value), createObject('value', ''))]",
          "roleAssignments": "[if(parameters('featureFlags').enableKeyVault, createObject('value', concat(createArray(createObject('principalId', reference(resourceId('Microsoft.Resources/deployments', 'customerPublicWebAppDeployment'), '2022-09-01').outputs.principalId.value, 'roleDefinitionId', '4633458b-17de-408a-b874-0445c86b69e6'), createObject('principalId', reference(resourceId('Microsoft.Resources/deployments', 'customerSiteWebAppDeployment'), '2022-09-01').outputs.principalId.value, 'roleDefinitionId', '4633458b-17de-408a-b874-0445c86b69e6'), createObject('principalId', reference(resourceId('Microsoft.Resources/deployments', 'adminPublicWebAppDeployment'), '2022-09-01').outputs.principalId.value, 'roleDefinitionId', '4633458b-17de-408a-b874-0445c86b69e6'), createObject('principalId', reference(resourceId('Microsoft.Resources/deployments', 'adminSiteWebAppDeployment'), '2022-09-01').outputs.principalId.value, 'roleDefinitionId', '4633458b-17de-408a-b874-0445c86b69e6'), createObject('principalId', reference(resourceId('Microsoft.Resources/deployments', 'videoApiWebAppDeployment'), '2022-09-01').outputs.principalId.value, 'roleDefinitionId', '4633458b-17de-408a-b874-0445c86b69e6'), createObject('principalId', reference(resourceId('Microsoft.Resources/deployments', 'musicApiWebAppDeployment'), '2022-09-01').outputs.principalId.value, 'roleDefinitionId', '4633458b-17de-408a-b874-0445c86b69e6')), if(parameters('featureFlags').enableFunctionApps, createArray(createObject('principalId', reference(resourceId('Microsoft.Resources/deployments', 'adminFunctionAppDeployment'), '2022-09-01').outputs.principalId.value, 'roleDefinitionId', '4633458b-17de-408a-b874-0445c86b69e6'), createObject('principalId', reference(resourceId('Microsoft.Resources/deployments', 'customerFunctionAppDeployment'), '2022-09-01').outputs.principalId.value, 'roleDefinitionId', '4633458b-17de-408a-b874-0445c86b69e6'), createObject('principalId', reference(resourceId('Microsoft.Resources/deployments', 'musicFunctionAppDeployment'), '2022-09-01').outputs.principalId.value, 'roleDefinitionId', '4633458b-17de-408a-b874-0445c86b69e6'), createObject('principalId', reference(resourceId('Microsoft.Resources/deployments', 'videoFunctionAppDeployment'), '2022-09-01').outputs.principalId.value, 'roleDefinitionId', '4633458b-17de-408a-b874-0445c86b69e6')), createArray()))), createObject('value', createArray()))]",
          "tags": {
            "value": "[variables('commonTags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.37.4.10188",
              "templateHash": "12467477331663881522"
            }
          },
          "parameters": {
            "location": {
              "type": "string"
            },
            "keyVaultName": {
              "type": "string"
            },
            "tenantId": {
              "type": "string",
              "defaultValue": "[tenant().tenantId]"
            },
            "enableSoftDelete": {
              "type": "bool",
              "defaultValue": true
            },
            "softDeleteRetentionInDays": {
              "type": "int",
              "defaultValue": 90
            },
            "enablePurgeProtection": {
              "type": "bool",
              "defaultValue": true
            },
            "tags": {
              "type": "object",
              "defaultValue": {}
            },
            "allowedSubnets": {
              "type": "array",
              "defaultValue": []
            },
            "roleAssignments": {
              "type": "array",
              "defaultValue": []
            },
            "createPrivateEndpoint": {
              "type": "bool"
            },
            "privateEndpointSubnetId": {
              "type": "string"
            },
            "privateDnsZoneId": {
              "type": "string"
            }
          },
          "variables": {
            "copy": [
              {
                "name": "virtualNetworkRules",
                "count": "[length(parameters('allowedSubnets'))]",
                "input": {
                  "id": "[parameters('allowedSubnets')[copyIndex('virtualNetworkRules')]]"
                }
              }
            ]
          },
          "resources": [
            {
              "type": "Microsoft.KeyVault/vaults",
              "apiVersion": "2023-07-01",
              "name": "[parameters('keyVaultName')]",
              "location": "[parameters('location')]",
              "properties": {
                "enabledForDeployment": false,
                "enabledForDiskEncryption": false,
                "enabledForTemplateDeployment": true,
                "tenantId": "[parameters('tenantId')]",
                "enableSoftDelete": "[parameters('enableSoftDelete')]",
                "softDeleteRetentionInDays": "[parameters('softDeleteRetentionInDays')]",
                "enablePurgeProtection": "[parameters('enablePurgeProtection')]",
                "enableRbacAuthorization": true,
                "sku": {
                  "family": "A",
                  "name": "standard"
                },
                "networkAcls": {
                  "defaultAction": "[if(greater(length(parameters('allowedSubnets')), 0), 'Deny', 'Allow')]",
                  "bypass": "AzureServices",
                  "virtualNetworkRules": "[if(greater(length(parameters('allowedSubnets')), 0), variables('virtualNetworkRules'), createArray())]"
                }
              },
              "tags": "[parameters('tags')]"
            },
            {
              "copy": {
                "name": "keyVaultRoleAssignments",
                "count": "[length(parameters('roleAssignments'))]"
              },
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.KeyVault/vaults/{0}', parameters('keyVaultName'))]",
              "name": "[guid(resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName')), parameters('roleAssignments')[copyIndex()].principalId, parameters('roleAssignments')[copyIndex()].roleDefinitionId)]",
              "properties": {
                "principalId": "[parameters('roleAssignments')[copyIndex()].principalId]",
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', parameters('roleAssignments')[copyIndex()].roleDefinitionId)]",
                "principalType": "ServicePrincipal"
              },
              "dependsOn": [
                "[resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName'))]"
              ]
            },
            {
              "condition": "[and(parameters('createPrivateEndpoint'), not(empty(parameters('privateEndpointSubnetId'))))]",
              "type": "Microsoft.Network/privateEndpoints",
              "apiVersion": "2023-09-01",
              "name": "[format('{0}-pe', parameters('keyVaultName'))]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "subnet": {
                  "id": "[parameters('privateEndpointSubnetId')]"
                },
                "privateLinkServiceConnections": [
                  {
                    "name": "[format('{0}-pe-connection', parameters('keyVaultName'))]",
                    "properties": {
                      "privateLinkServiceId": "[resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName'))]",
                      "groupIds": [
                        "vault"
                      ]
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName'))]"
              ]
            },
            {
              "condition": "[and(parameters('createPrivateEndpoint'), not(empty(parameters('privateDnsZoneId'))))]",
              "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
              "apiVersion": "2023-09-01",
              "name": "[format('{0}/{1}', format('{0}-pe', parameters('keyVaultName')), format('{0}-pe-dns-group', parameters('keyVaultName')))]",
              "properties": {
                "privateDnsZoneConfigs": [
                  {
                    "name": "keyvault-config",
                    "properties": {
                      "privateDnsZoneId": "[parameters('privateDnsZoneId')]"
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/privateEndpoints', format('{0}-pe', parameters('keyVaultName')))]"
              ]
            },
            {
              "type": "Microsoft.KeyVault/vaults/secrets",
              "apiVersion": "2023-07-01",
              "name": "[format('{0}/{1}', parameters('keyVaultName'), 'SqlConnectionString')]",
              "properties": {
                "value": "[format('Server=tcp:{0}.{1};Initial Catalog=SampleDB;Persist Security Info=False;User ID=sampleuser;Password=SamplePassword123!;MultipleActiveResultSets=False;Encrypt=True;TrustServerCertificate=False;Connection Timeout=30;', parameters('keyVaultName'), environment().suffixes.sqlServerHostname)]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName'))]"
              ]
            },
            {
              "type": "Microsoft.KeyVault/vaults/secrets",
              "apiVersion": "2023-07-01",
              "name": "[format('{0}/{1}', parameters('keyVaultName'), 'ApiKey')]",
              "properties": {
                "value": "sample-api-key-value"
              },
              "dependsOn": [
                "[resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName'))]"
              ]
            }
          ],
          "outputs": {
            "keyVaultId": {
              "type": "string",
              "value": "[resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName'))]"
            },
            "keyVaultName": {
              "type": "string",
              "value": "[parameters('keyVaultName')]"
            },
            "keyVaultUri": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName')), '2023-07-01').vaultUri]"
            },
            "keyVaultResourceGroup": {
              "type": "string",
              "value": "[resourceGroup().name]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'adminFunctionAppDeployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'adminPublicWebAppDeployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'adminSiteWebAppDeployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'customerFunctionAppDeployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'customerPublicWebAppDeployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'customerSiteWebAppDeployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'musicApiWebAppDeployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'musicFunctionAppDeployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'privateDnsZonesDeployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'videoApiWebAppDeployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'videoFunctionAppDeployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'virtualNetworkDeployment')]"
      ]
    },
    {
      "condition": "[parameters('featureFlags').enableAppConfiguration]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "appConfigurationDeployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('general').location]"
          },
          "appConfigName": {
            "value": "[parameters('appConfiguration').name]"
          },
          "createPrivateEndpoint": {
            "value": "[parameters('featureFlags').enablePrivateEndpoints]"
          },
          "privateEndpointSubnetId": "[if(parameters('featureFlags').enablePrivateEndpoints, createObject('value', reference(resourceId('Microsoft.Resources/deployments', 'virtualNetworkDeployment'), '2022-09-01').outputs.privateEndpointSubnetId.value), createObject('value', ''))]",
          "privateDnsZoneId": "[if(and(parameters('featureFlags').enablePrivateEndpoints, parameters('featureFlags').enableAppConfiguration), createObject('value', reference(resourceId('Microsoft.Resources/deployments', 'privateDnsZonesDeployment'), '2022-09-01').outputs.appConfigPrivateDnsZoneId.value), createObject('value', ''))]",
          "roleAssignments": "[if(parameters('featureFlags').enableAppConfiguration, createObject('value', concat(createArray(createObject('principalId', reference(resourceId('Microsoft.Resources/deployments', 'customerPublicWebAppDeployment'), '2022-09-01').outputs.principalId.value, 'roleDefinitionId', '516239f1-63e1-4d78-a4de-a74fb236a071'), createObject('principalId', reference(resourceId('Microsoft.Resources/deployments', 'customerSiteWebAppDeployment'), '2022-09-01').outputs.principalId.value, 'roleDefinitionId', '516239f1-63e1-4d78-a4de-a74fb236a071'), createObject('principalId', reference(resourceId('Microsoft.Resources/deployments', 'adminPublicWebAppDeployment'), '2022-09-01').outputs.principalId.value, 'roleDefinitionId', '516239f1-63e1-4d78-a4de-a74fb236a071'), createObject('principalId', reference(resourceId('Microsoft.Resources/deployments', 'adminSiteWebAppDeployment'), '2022-09-01').outputs.principalId.value, 'roleDefinitionId', '516239f1-63e1-4d78-a4de-a74fb236a071'), createObject('principalId', reference(resourceId('Microsoft.Resources/deployments', 'videoApiWebAppDeployment'), '2022-09-01').outputs.principalId.value, 'roleDefinitionId', '516239f1-63e1-4d78-a4de-a74fb236a071'), createObject('principalId', reference(resourceId('Microsoft.Resources/deployments', 'musicApiWebAppDeployment'), '2022-09-01').outputs.principalId.value, 'roleDefinitionId', '516239f1-63e1-4d78-a4de-a74fb236a071')), if(parameters('featureFlags').enableFunctionApps, createArray(createObject('principalId', reference(resourceId('Microsoft.Resources/deployments', 'adminFunctionAppDeployment'), '2022-09-01').outputs.principalId.value, 'roleDefinitionId', '516239f1-63e1-4d78-a4de-a74fb236a071'), createObject('principalId', reference(resourceId('Microsoft.Resources/deployments', 'customerFunctionAppDeployment'), '2022-09-01').outputs.principalId.value, 'roleDefinitionId', '516239f1-63e1-4d78-a4de-a74fb236a071'), createObject('principalId', reference(resourceId('Microsoft.Resources/deployments', 'musicFunctionAppDeployment'), '2022-09-01').outputs.principalId.value, 'roleDefinitionId', '516239f1-63e1-4d78-a4de-a74fb236a071'), createObject('principalId', reference(resourceId('Microsoft.Resources/deployments', 'videoFunctionAppDeployment'), '2022-09-01').outputs.principalId.value, 'roleDefinitionId', '516239f1-63e1-4d78-a4de-a74fb236a071')), createArray()))), createObject('value', createArray()))]"
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.37.4.10188",
              "templateHash": "18038650829524547888"
            }
          },
          "parameters": {
            "location": {
              "type": "string"
            },
            "appConfigName": {
              "type": "string"
            },
            "skuName": {
              "type": "string",
              "defaultValue": "standard"
            },
            "createPrivateEndpoint": {
              "type": "bool",
              "defaultValue": false
            },
            "privateEndpointSubnetId": {
              "type": "string",
              "defaultValue": ""
            },
            "privateDnsZoneId": {
              "type": "string",
              "defaultValue": ""
            },
            "tags": {
              "type": "object",
              "defaultValue": {}
            },
            "roleAssignments": {
              "type": "array",
              "defaultValue": []
            }
          },
          "resources": [
            {
              "type": "Microsoft.AppConfiguration/configurationStores",
              "apiVersion": "2023-03-01",
              "name": "[parameters('appConfigName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "sku": {
                "name": "[parameters('skuName')]"
              },
              "identity": {
                "type": "SystemAssigned"
              },
              "properties": {
                "encryption": {
                  "keyVaultProperties": null
                },
                "disableLocalAuth": false,
                "softDeleteRetentionInDays": 1,
                "enablePurgeProtection": false,
                "publicNetworkAccess": "[if(parameters('createPrivateEndpoint'), 'Disabled', 'Enabled')]"
              }
            },
            {
              "condition": "[parameters('createPrivateEndpoint')]",
              "type": "Microsoft.Network/privateEndpoints",
              "apiVersion": "2023-09-01",
              "name": "[format('{0}-pe', parameters('appConfigName'))]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "subnet": {
                  "id": "[parameters('privateEndpointSubnetId')]"
                },
                "privateLinkServiceConnections": [
                  {
                    "name": "[format('{0}-pe-connection', parameters('appConfigName'))]",
                    "properties": {
                      "privateLinkServiceId": "[resourceId('Microsoft.AppConfiguration/configurationStores', parameters('appConfigName'))]",
                      "groupIds": [
                        "configurationStores"
                      ]
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.AppConfiguration/configurationStores', parameters('appConfigName'))]"
              ]
            },
            {
              "condition": "[parameters('createPrivateEndpoint')]",
              "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
              "apiVersion": "2023-09-01",
              "name": "[format('{0}/{1}', format('{0}-pe', parameters('appConfigName')), format('{0}-pe-dns-group', parameters('appConfigName')))]",
              "properties": {
                "privateDnsZoneConfigs": [
                  {
                    "name": "privatelink-azconfig-io",
                    "properties": {
                      "privateDnsZoneId": "[parameters('privateDnsZoneId')]"
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/privateEndpoints', format('{0}-pe', parameters('appConfigName')))]"
              ]
            },
            {
              "copy": {
                "name": "appConfigRoleAssignments",
                "count": "[length(parameters('roleAssignments'))]"
              },
              "condition": "[not(empty(parameters('roleAssignments')[copyIndex()].principalId))]",
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.AppConfiguration/configurationStores/{0}', parameters('appConfigName'))]",
              "name": "[guid(resourceId('Microsoft.AppConfiguration/configurationStores', parameters('appConfigName')), parameters('roleAssignments')[copyIndex()].principalId, parameters('roleAssignments')[copyIndex()].roleDefinitionId)]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', parameters('roleAssignments')[copyIndex()].roleDefinitionId)]",
                "principalId": "[parameters('roleAssignments')[copyIndex()].principalId]",
                "principalType": "[coalesce(tryGet(parameters('roleAssignments')[copyIndex()], 'principalType'), 'ServicePrincipal')]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.AppConfiguration/configurationStores', parameters('appConfigName'))]"
              ]
            }
          ],
          "outputs": {
            "appConfigId": {
              "type": "string",
              "value": "[resourceId('Microsoft.AppConfiguration/configurationStores', parameters('appConfigName'))]"
            },
            "appConfigName": {
              "type": "string",
              "value": "[parameters('appConfigName')]"
            },
            "endpoint": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.AppConfiguration/configurationStores', parameters('appConfigName')), '2023-03-01').endpoint]"
            },
            "principalId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.AppConfiguration/configurationStores', parameters('appConfigName')), '2023-03-01', 'full').identity.principalId]"
            },
            "hasPrivateEndpoint": {
              "type": "bool",
              "value": "[parameters('createPrivateEndpoint')]"
            },
            "privateEndpointId": {
              "type": "string",
              "value": "[if(parameters('createPrivateEndpoint'), resourceId('Microsoft.Network/privateEndpoints', format('{0}-pe', parameters('appConfigName'))), '')]"
            },
            "privateEndpointName": {
              "type": "string",
              "value": "[if(parameters('createPrivateEndpoint'), format('{0}-pe', parameters('appConfigName')), '')]"
            },
            "appConfigDataOwnerRoleId": {
              "type": "string",
              "value": "5ae67dd6-50cb-40e7-96ff-dc2bfa4b606b"
            },
            "appConfigDataReaderRoleId": {
              "type": "string",
              "value": "516239f1-63e1-4d78-a4de-a74fb236a071"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'adminFunctionAppDeployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'adminPublicWebAppDeployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'adminSiteWebAppDeployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'customerFunctionAppDeployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'customerPublicWebAppDeployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'customerSiteWebAppDeployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'musicApiWebAppDeployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'musicFunctionAppDeployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'privateDnsZonesDeployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'videoApiWebAppDeployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'videoFunctionAppDeployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'virtualNetworkDeployment')]"
      ]
    },
    {
      "condition": "[parameters('featureFlags').enableStorageAccount]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "blobStorageDeployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('general').location]"
          },
          "storageAccountName": {
            "value": "[parameters('storage').mainAccount.name]"
          },
          "storageAccountType": {
            "value": "[parameters('storage').mainAccount.type]"
          },
          "containerNames": {
            "value": "[parameters('storage').mainAccount.containers]"
          },
          "createPrivateEndpoint": {
            "value": "[parameters('featureFlags').enablePrivateEndpoints]"
          },
          "privateEndpointSubnetId": "[if(parameters('featureFlags').enablePrivateEndpoints, createObject('value', reference(resourceId('Microsoft.Resources/deployments', 'virtualNetworkDeployment'), '2022-09-01').outputs.privateEndpointSubnetId.value), createObject('value', ''))]",
          "privateDnsZoneIds": {
            "value": {
              "blob": "[if(and(parameters('featureFlags').enablePrivateEndpoints, parameters('featureFlags').enableStorageAccount), reference(resourceId('Microsoft.Resources/deployments', 'privateDnsZonesDeployment'), '2022-09-01').outputs.blobStoragePrivateDnsZoneId.value, '')]",
              "file": "[if(and(parameters('featureFlags').enablePrivateEndpoints, parameters('featureFlags').enableStorageAccount), reference(resourceId('Microsoft.Resources/deployments', 'privateDnsZonesDeployment'), '2022-09-01').outputs.fileStoragePrivateDnsZoneId.value, '')]",
              "queue": "[if(and(parameters('featureFlags').enablePrivateEndpoints, parameters('featureFlags').enableStorageAccount), reference(resourceId('Microsoft.Resources/deployments', 'privateDnsZonesDeployment'), '2022-09-01').outputs.queueStoragePrivateDnsZoneId.value, '')]",
              "table": "[if(and(parameters('featureFlags').enablePrivateEndpoints, parameters('featureFlags').enableStorageAccount), reference(resourceId('Microsoft.Resources/deployments', 'privateDnsZonesDeployment'), '2022-09-01').outputs.tableStoragePrivateDnsZoneId.value, '')]"
            }
          },
          "allowedSubnets": "[if(parameters('featureFlags').enableVNetIntegration, createObject('value', createArray(reference(resourceId('Microsoft.Resources/deployments', 'virtualNetworkDeployment'), '2022-09-01').outputs.vnetIntegrationSubnetId.value)), createObject('value', createArray()))]",
          "allowBlobPublicAccess": {
            "value": "[not(parameters('featureFlags').enablePrivateEndpoints)]"
          },
          "roleAssignments": "[if(parameters('featureFlags').enableStorageAccount, createObject('value', concat(createArray(createObject('principalId', reference(resourceId('Microsoft.Resources/deployments', 'customerPublicWebAppDeployment'), '2022-09-01').outputs.principalId.value, 'roleDefinitionId', 'ba92f5b4-2d11-453d-a403-e96b0029c9fe'), createObject('principalId', reference(resourceId('Microsoft.Resources/deployments', 'customerSiteWebAppDeployment'), '2022-09-01').outputs.principalId.value, 'roleDefinitionId', 'ba92f5b4-2d11-453d-a403-e96b0029c9fe'), createObject('principalId', reference(resourceId('Microsoft.Resources/deployments', 'adminPublicWebAppDeployment'), '2022-09-01').outputs.principalId.value, 'roleDefinitionId', 'ba92f5b4-2d11-453d-a403-e96b0029c9fe'), createObject('principalId', reference(resourceId('Microsoft.Resources/deployments', 'adminSiteWebAppDeployment'), '2022-09-01').outputs.principalId.value, 'roleDefinitionId', 'ba92f5b4-2d11-453d-a403-e96b0029c9fe'), createObject('principalId', reference(resourceId('Microsoft.Resources/deployments', 'videoApiWebAppDeployment'), '2022-09-01').outputs.principalId.value, 'roleDefinitionId', 'ba92f5b4-2d11-453d-a403-e96b0029c9fe'), createObject('principalId', reference(resourceId('Microsoft.Resources/deployments', 'musicApiWebAppDeployment'), '2022-09-01').outputs.principalId.value, 'roleDefinitionId', 'ba92f5b4-2d11-453d-a403-e96b0029c9fe')), if(parameters('featureFlags').enableFunctionApps, createArray(createObject('principalId', reference(resourceId('Microsoft.Resources/deployments', 'adminFunctionAppDeployment'), '2022-09-01').outputs.principalId.value, 'roleDefinitionId', 'ba92f5b4-2d11-453d-a403-e96b0029c9fe'), createObject('principalId', reference(resourceId('Microsoft.Resources/deployments', 'customerFunctionAppDeployment'), '2022-09-01').outputs.principalId.value, 'roleDefinitionId', 'ba92f5b4-2d11-453d-a403-e96b0029c9fe'), createObject('principalId', reference(resourceId('Microsoft.Resources/deployments', 'musicFunctionAppDeployment'), '2022-09-01').outputs.principalId.value, 'roleDefinitionId', 'ba92f5b4-2d11-453d-a403-e96b0029c9fe'), createObject('principalId', reference(resourceId('Microsoft.Resources/deployments', 'videoFunctionAppDeployment'), '2022-09-01').outputs.principalId.value, 'roleDefinitionId', 'ba92f5b4-2d11-453d-a403-e96b0029c9fe')), createArray()))), createObject('value', createArray()))]",
          "tags": {
            "value": "[variables('commonTags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.37.4.10188",
              "templateHash": "14850371271327244740"
            }
          },
          "parameters": {
            "location": {
              "type": "string"
            },
            "storageAccountName": {
              "type": "string"
            },
            "storageAccountType": {
              "type": "string",
              "defaultValue": "Standard_LRS"
            },
            "accessTier": {
              "type": "string",
              "defaultValue": "Hot"
            },
            "allowBlobPublicAccess": {
              "type": "bool",
              "defaultValue": false
            },
            "minimumTlsVersion": {
              "type": "string",
              "defaultValue": "TLS1_2"
            },
            "containerNames": {
              "type": "array",
              "defaultValue": [
                "documents",
                "images",
                "backups"
              ]
            },
            "containerPublicAccess": {
              "type": "string",
              "defaultValue": "None"
            },
            "createPrivateEndpoint": {
              "type": "bool",
              "defaultValue": false
            },
            "privateEndpointSubnetId": {
              "type": "string",
              "defaultValue": ""
            },
            "privateDnsZoneIds": {
              "type": "object",
              "defaultValue": {
                "blob": "",
                "file": "",
                "queue": "",
                "table": ""
              }
            },
            "allowedSubnets": {
              "type": "array",
              "defaultValue": []
            },
            "allowedIpRanges": {
              "type": "array",
              "defaultValue": []
            },
            "bypassAzureServices": {
              "type": "bool",
              "defaultValue": true
            },
            "tags": {
              "type": "object",
              "defaultValue": {}
            },
            "roleAssignments": {
              "type": "array",
              "defaultValue": []
            },
            "enableDefenderForStorage": {
              "type": "bool",
              "defaultValue": true
            }
          },
          "variables": {
            "copy": [
              {
                "name": "virtualNetworkRules",
                "count": "[length(parameters('allowedSubnets'))]",
                "input": {
                  "id": "[parameters('allowedSubnets')[copyIndex('virtualNetworkRules')]]",
                  "action": "Allow"
                }
              }
            ],
            "storageServices": [
              {
                "name": "blob",
                "dnsZoneId": "[parameters('privateDnsZoneIds').blob]"
              },
              {
                "name": "file",
                "dnsZoneId": "[parameters('privateDnsZoneIds').file]"
              },
              {
                "name": "queue",
                "dnsZoneId": "[parameters('privateDnsZoneIds').queue]"
              },
              {
                "name": "table",
                "dnsZoneId": "[parameters('privateDnsZoneIds').table]"
              }
            ]
          },
          "resources": [
            {
              "type": "Microsoft.Storage/storageAccounts",
              "apiVersion": "2023-01-01",
              "name": "[parameters('storageAccountName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "sku": {
                "name": "[parameters('storageAccountType')]"
              },
              "kind": "StorageV2",
              "identity": {
                "type": "SystemAssigned"
              },
              "properties": {
                "accessTier": "[parameters('accessTier')]",
                "allowBlobPublicAccess": "[parameters('allowBlobPublicAccess')]",
                "allowSharedKeyAccess": true,
                "defaultToOAuthAuthentication": false,
                "minimumTlsVersion": "[parameters('minimumTlsVersion')]",
                "supportsHttpsTrafficOnly": true,
                "publicNetworkAccess": "[if(parameters('createPrivateEndpoint'), 'Disabled', 'Enabled')]",
                "networkAcls": {
                  "copy": [
                    {
                      "name": "ipRules",
                      "count": "[length(parameters('allowedIpRanges'))]",
                      "input": {
                        "value": "[parameters('allowedIpRanges')[copyIndex('ipRules')]]",
                        "action": "Allow"
                      }
                    }
                  ],
                  "bypass": "[if(parameters('bypassAzureServices'), 'AzureServices', 'None')]",
                  "defaultAction": "[if(or(greater(length(parameters('allowedIpRanges')), 0), greater(length(parameters('allowedSubnets')), 0)), 'Deny', 'Allow')]",
                  "virtualNetworkRules": "[if(greater(length(parameters('allowedSubnets')), 0), variables('virtualNetworkRules'), createArray())]"
                }
              }
            },
            {
              "type": "Microsoft.Storage/storageAccounts/blobServices",
              "apiVersion": "2023-01-01",
              "name": "[format('{0}/{1}', parameters('storageAccountName'), 'default')]",
              "properties": {
                "cors": {
                  "corsRules": []
                },
                "deleteRetentionPolicy": {
                  "enabled": true,
                  "days": 7
                },
                "containerDeleteRetentionPolicy": {
                  "enabled": true,
                  "days": 7
                },
                "changeFeed": {
                  "enabled": false
                },
                "restorePolicy": {
                  "enabled": false
                },
                "isVersioningEnabled": false
              },
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName'))]"
              ]
            },
            {
              "type": "Microsoft.Storage/storageAccounts/fileServices",
              "apiVersion": "2023-01-01",
              "name": "[format('{0}/{1}', parameters('storageAccountName'), 'default')]",
              "properties": {
                "cors": {
                  "corsRules": []
                },
                "shareDeleteRetentionPolicy": {
                  "enabled": true,
                  "days": 7
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName'))]"
              ]
            },
            {
              "type": "Microsoft.Storage/storageAccounts/queueServices",
              "apiVersion": "2023-01-01",
              "name": "[format('{0}/{1}', parameters('storageAccountName'), 'default')]",
              "properties": {
                "cors": {
                  "corsRules": []
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName'))]"
              ]
            },
            {
              "type": "Microsoft.Storage/storageAccounts/tableServices",
              "apiVersion": "2023-01-01",
              "name": "[format('{0}/{1}', parameters('storageAccountName'), 'default')]",
              "properties": {
                "cors": {
                  "corsRules": []
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName'))]"
              ]
            },
            {
              "copy": {
                "name": "blobContainers",
                "count": "[length(parameters('containerNames'))]"
              },
              "type": "Microsoft.Storage/storageAccounts/blobServices/containers",
              "apiVersion": "2023-01-01",
              "name": "[format('{0}/{1}/{2}', parameters('storageAccountName'), 'default', parameters('containerNames')[copyIndex()])]",
              "properties": {
                "publicAccess": "[parameters('containerPublicAccess')]",
                "metadata": {}
              },
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts/blobServices', parameters('storageAccountName'), 'default')]"
              ]
            },
            {
              "condition": "[parameters('enableDefenderForStorage')]",
              "type": "Microsoft.Security/defenderForStorageSettings",
              "apiVersion": "2025-02-01-preview",
              "scope": "[format('Microsoft.Storage/storageAccounts/{0}', parameters('storageAccountName'))]",
              "name": "current",
              "properties": {
                "isEnabled": true,
                "malwareScanning": {
                  "blobScanResultsOptions": "blobIndexTags",
                  "onUpload": {
                    "isEnabled": true,
                    "capGBPerMonth": 10000
                  }
                },
                "sensitiveDataDiscovery": {
                  "isEnabled": true
                },
                "overrideSubscriptionLevelSettings": true
              },
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName'))]"
              ]
            },
            {
              "type": "Microsoft.Storage/storageAccounts/managementPolicies",
              "apiVersion": "2023-01-01",
              "name": "[format('{0}/{1}', parameters('storageAccountName'), 'default')]",
              "properties": {
                "policy": {
                  "rules": [
                    {
                      "enabled": true,
                      "name": "DocumentsRetentionPolicy",
                      "type": "Lifecycle",
                      "definition": {
                        "filters": {
                          "blobTypes": [
                            "blockBlob"
                          ],
                          "prefixMatch": [
                            "documents/"
                          ]
                        },
                        "actions": {
                          "baseBlob": {
                            "delete": {
                              "daysAfterModificationGreaterThan": 30
                            }
                          }
                        }
                      }
                    }
                  ]
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName'))]"
              ]
            },
            {
              "copy": {
                "name": "privateEndpoints",
                "count": "[length(variables('storageServices'))]"
              },
              "condition": "[and(parameters('createPrivateEndpoint'), not(empty(variables('storageServices')[copyIndex()].dnsZoneId)))]",
              "type": "Microsoft.Network/privateEndpoints",
              "apiVersion": "2023-09-01",
              "name": "[format('{0}-{1}-pe', parameters('storageAccountName'), variables('storageServices')[copyIndex()].name)]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "subnet": {
                  "id": "[parameters('privateEndpointSubnetId')]"
                },
                "privateLinkServiceConnections": [
                  {
                    "name": "[format('{0}-{1}-pe-connection', parameters('storageAccountName'), variables('storageServices')[copyIndex()].name)]",
                    "properties": {
                      "privateLinkServiceId": "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName'))]",
                      "groupIds": [
                        "[variables('storageServices')[copyIndex()].name]"
                      ]
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName'))]"
              ]
            },
            {
              "copy": {
                "name": "privateDnsZoneGroups",
                "count": "[length(variables('storageServices'))]"
              },
              "condition": "[and(parameters('createPrivateEndpoint'), not(empty(variables('storageServices')[copyIndex()].dnsZoneId)))]",
              "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
              "apiVersion": "2023-09-01",
              "name": "[format('{0}/{1}', format('{0}-{1}-pe', parameters('storageAccountName'), variables('storageServices')[copyIndex()].name), 'default')]",
              "properties": {
                "privateDnsZoneConfigs": [
                  {
                    "name": "[format('{0}-config', variables('storageServices')[copyIndex()].name)]",
                    "properties": {
                      "privateDnsZoneId": "[variables('storageServices')[copyIndex()].dnsZoneId]"
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/privateEndpoints', format('{0}-{1}-pe', parameters('storageAccountName'), variables('storageServices')[copyIndex()].name))]"
              ]
            },
            {
              "copy": {
                "name": "storageRoleAssignments",
                "count": "[length(parameters('roleAssignments'))]"
              },
              "condition": "[not(empty(parameters('roleAssignments')[copyIndex()].principalId))]",
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Storage/storageAccounts/{0}', parameters('storageAccountName'))]",
              "name": "[guid(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName')), parameters('roleAssignments')[copyIndex()].principalId, parameters('roleAssignments')[copyIndex()].roleDefinitionId)]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', parameters('roleAssignments')[copyIndex()].roleDefinitionId)]",
                "principalId": "[parameters('roleAssignments')[copyIndex()].principalId]",
                "principalType": "ServicePrincipal"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName'))]"
              ]
            }
          ],
          "outputs": {
            "storageAccountId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName'))]"
            },
            "storageAccountName": {
              "type": "string",
              "value": "[parameters('storageAccountName')]"
            },
            "storageAccountPrimaryEndpoints": {
              "type": "object",
              "value": "[reference(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName')), '2023-01-01').primaryEndpoints]"
            },
            "storageAccountPrimaryBlobEndpoint": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName')), '2023-01-01').primaryEndpoints.blob]"
            },
            "principalId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName')), '2023-01-01', 'full').identity.principalId]"
            },
            "containerNames": {
              "type": "array",
              "value": "[parameters('containerNames')]"
            },
            "hasPrivateEndpoint": {
              "type": "bool",
              "value": "[parameters('createPrivateEndpoint')]"
            },
            "privateEndpoints": {
              "type": "array",
              "copy": {
                "count": "[length(variables('storageServices'))]",
                "input": {
                  "name": "[variables('storageServices')[copyIndex()].name]",
                  "id": "[if(and(parameters('createPrivateEndpoint'), not(empty(variables('storageServices')[copyIndex()].dnsZoneId))), resourceId('Microsoft.Network/privateEndpoints', format('{0}-{1}-pe', parameters('storageAccountName'), variables('storageServices')[copyIndex()].name)), '')]",
                  "hasPrivateEndpoint": "[and(parameters('createPrivateEndpoint'), not(empty(variables('storageServices')[copyIndex()].dnsZoneId)))]"
                }
              }
            },
            "storageAccountContributorRoleId": {
              "type": "string",
              "value": "17d1049b-9a84-46fb-8f53-869881c3d3ab"
            },
            "storageBlobDataOwnerRoleId": {
              "type": "string",
              "value": "b7e6dc6d-f1e8-4753-8033-0f276bb0955b"
            },
            "storageBlobDataContributorRoleId": {
              "type": "string",
              "value": "ba92f5b4-2d11-453d-a403-e96b0029c9fe"
            },
            "storageBlobDataReaderRoleId": {
              "type": "string",
              "value": "2a2b9908-6ea1-4ae2-8e65-a410df84e7d1"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'adminFunctionAppDeployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'adminPublicWebAppDeployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'adminSiteWebAppDeployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'customerFunctionAppDeployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'customerPublicWebAppDeployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'customerSiteWebAppDeployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'musicApiWebAppDeployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'musicFunctionAppDeployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'privateDnsZonesDeployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'videoApiWebAppDeployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'videoFunctionAppDeployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'virtualNetworkDeployment')]"
      ]
    },
    {
      "condition": "[parameters('featureFlags').enableCosmosDb]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "cosmosDbAccountDeployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('general').location]"
          },
          "cosmosAccountName": {
            "value": "[parameters('cosmos').accountName]"
          },
          "consistencyLevel": {
            "value": "[parameters('cosmos').consistencyLevel]"
          },
          "enableAutomaticFailover": {
            "value": "[parameters('cosmos').enableAutomaticFailover]"
          },
          "createPrivateEndpoint": {
            "value": "[parameters('featureFlags').enablePrivateEndpoints]"
          },
          "privateEndpointSubnetId": "[if(parameters('featureFlags').enablePrivateEndpoints, createObject('value', reference(resourceId('Microsoft.Resources/deployments', 'virtualNetworkDeployment'), '2022-09-01').outputs.privateEndpointSubnetId.value), createObject('value', ''))]",
          "privateDnsZoneId": "[if(and(parameters('featureFlags').enablePrivateEndpoints, parameters('featureFlags').enableCosmosDb), createObject('value', reference(resourceId('Microsoft.Resources/deployments', 'privateDnsZonesDeployment'), '2022-09-01').outputs.cosmosPrivateDnsZoneId.value), createObject('value', ''))]",
          "allowedSubnets": "[if(parameters('featureFlags').enableVNetIntegration, createObject('value', createArray(reference(resourceId('Microsoft.Resources/deployments', 'virtualNetworkDeployment'), '2022-09-01').outputs.vnetIntegrationSubnetId.value)), createObject('value', createArray()))]",
          "enablePublicNetworkAccess": {
            "value": "[not(parameters('featureFlags').enablePrivateEndpoints)]"
          },
          "tags": {
            "value": "[variables('commonTags')]"
          },
          "roleAssignments": "[if(parameters('featureFlags').enableCosmosDb, createObject('value', concat(createArray(createObject('principalId', reference(resourceId('Microsoft.Resources/deployments', 'customerPublicWebAppDeployment'), '2022-09-01').outputs.principalId.value, 'roleDefinitionId', '5bd9cd88-fe45-4216-938b-f97437e15450'), createObject('principalId', reference(resourceId('Microsoft.Resources/deployments', 'customerSiteWebAppDeployment'), '2022-09-01').outputs.principalId.value, 'roleDefinitionId', '5bd9cd88-fe45-4216-938b-f97437e15450'), createObject('principalId', reference(resourceId('Microsoft.Resources/deployments', 'adminPublicWebAppDeployment'), '2022-09-01').outputs.principalId.value, 'roleDefinitionId', '5bd9cd88-fe45-4216-938b-f97437e15450'), createObject('principalId', reference(resourceId('Microsoft.Resources/deployments', 'adminSiteWebAppDeployment'), '2022-09-01').outputs.principalId.value, 'roleDefinitionId', '5bd9cd88-fe45-4216-938b-f97437e15450'), createObject('principalId', reference(resourceId('Microsoft.Resources/deployments', 'videoApiWebAppDeployment'), '2022-09-01').outputs.principalId.value, 'roleDefinitionId', '5bd9cd88-fe45-4216-938b-f97437e15450'), createObject('principalId', reference(resourceId('Microsoft.Resources/deployments', 'musicApiWebAppDeployment'), '2022-09-01').outputs.principalId.value, 'roleDefinitionId', '5bd9cd88-fe45-4216-938b-f97437e15450')), if(parameters('featureFlags').enableFunctionApps, createArray(createObject('principalId', reference(resourceId('Microsoft.Resources/deployments', 'adminFunctionAppDeployment'), '2022-09-01').outputs.principalId.value, 'roleDefinitionId', '5bd9cd88-fe45-4216-938b-f97437e15450'), createObject('principalId', reference(resourceId('Microsoft.Resources/deployments', 'customerFunctionAppDeployment'), '2022-09-01').outputs.principalId.value, 'roleDefinitionId', '5bd9cd88-fe45-4216-938b-f97437e15450'), createObject('principalId', reference(resourceId('Microsoft.Resources/deployments', 'musicFunctionAppDeployment'), '2022-09-01').outputs.principalId.value, 'roleDefinitionId', '5bd9cd88-fe45-4216-938b-f97437e15450'), createObject('principalId', reference(resourceId('Microsoft.Resources/deployments', 'videoFunctionAppDeployment'), '2022-09-01').outputs.principalId.value, 'roleDefinitionId', '5bd9cd88-fe45-4216-938b-f97437e15450')), createArray()))), createObject('value', createArray()))]",
          "sqlRoleAssignments": "[if(parameters('featureFlags').enableCosmosDb, createObject('value', concat(createArray(createObject('principalId', reference(resourceId('Microsoft.Resources/deployments', 'customerPublicWebAppDeployment'), '2022-09-01').outputs.principalId.value, 'roleDefinitionId', '00000000-0000-0000-0000-000000000002'), createObject('principalId', reference(resourceId('Microsoft.Resources/deployments', 'customerSiteWebAppDeployment'), '2022-09-01').outputs.principalId.value, 'roleDefinitionId', '00000000-0000-0000-0000-000000000002'), createObject('principalId', reference(resourceId('Microsoft.Resources/deployments', 'adminPublicWebAppDeployment'), '2022-09-01').outputs.principalId.value, 'roleDefinitionId', '00000000-0000-0000-0000-000000000002'), createObject('principalId', reference(resourceId('Microsoft.Resources/deployments', 'adminSiteWebAppDeployment'), '2022-09-01').outputs.principalId.value, 'roleDefinitionId', '00000000-0000-0000-0000-000000000002'), createObject('principalId', reference(resourceId('Microsoft.Resources/deployments', 'videoApiWebAppDeployment'), '2022-09-01').outputs.principalId.value, 'roleDefinitionId', '00000000-0000-0000-0000-000000000002'), createObject('principalId', reference(resourceId('Microsoft.Resources/deployments', 'musicApiWebAppDeployment'), '2022-09-01').outputs.principalId.value, 'roleDefinitionId', '00000000-0000-0000-0000-000000000002')), if(parameters('featureFlags').enableFunctionApps, createArray(createObject('principalId', reference(resourceId('Microsoft.Resources/deployments', 'adminFunctionAppDeployment'), '2022-09-01').outputs.principalId.value, 'roleDefinitionId', '00000000-0000-0000-0000-000000000002'), createObject('principalId', reference(resourceId('Microsoft.Resources/deployments', 'customerFunctionAppDeployment'), '2022-09-01').outputs.principalId.value, 'roleDefinitionId', '00000000-0000-0000-0000-000000000002'), createObject('principalId', reference(resourceId('Microsoft.Resources/deployments', 'musicFunctionAppDeployment'), '2022-09-01').outputs.principalId.value, 'roleDefinitionId', '00000000-0000-0000-0000-000000000002'), createObject('principalId', reference(resourceId('Microsoft.Resources/deployments', 'videoFunctionAppDeployment'), '2022-09-01').outputs.principalId.value, 'roleDefinitionId', '00000000-0000-0000-0000-000000000002')), createArray()))), createObject('value', createArray()))]"
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.37.4.10188",
              "templateHash": "5472737496610447202"
            }
          },
          "parameters": {
            "location": {
              "type": "string"
            },
            "cosmosAccountName": {
              "type": "string"
            },
            "consistencyLevel": {
              "type": "string",
              "defaultValue": "Session"
            },
            "enableAutomaticFailover": {
              "type": "bool",
              "defaultValue": true
            },
            "enableMultipleWriteLocations": {
              "type": "bool",
              "defaultValue": false
            },
            "createPrivateEndpoint": {
              "type": "bool",
              "defaultValue": false
            },
            "privateEndpointSubnetId": {
              "type": "string",
              "defaultValue": ""
            },
            "privateDnsZoneId": {
              "type": "string",
              "defaultValue": ""
            },
            "allowedSubnets": {
              "type": "array",
              "defaultValue": []
            },
            "allowedIpRanges": {
              "type": "array",
              "defaultValue": []
            },
            "enablePublicNetworkAccess": {
              "type": "bool",
              "defaultValue": true
            },
            "backupIntervalInMinutes": {
              "type": "int",
              "defaultValue": 240
            },
            "backupRetentionIntervalInHours": {
              "type": "int",
              "defaultValue": 8
            },
            "backupStorageRedundancy": {
              "type": "string",
              "defaultValue": "Local"
            },
            "tags": {
              "type": "object",
              "defaultValue": {}
            },
            "roleAssignments": {
              "type": "array",
              "defaultValue": []
            },
            "sqlRoleAssignments": {
              "type": "array",
              "defaultValue": []
            }
          },
          "variables": {
            "copy": [
              {
                "name": "virtualNetworkRules",
                "count": "[length(parameters('allowedSubnets'))]",
                "input": {
                  "id": "[parameters('allowedSubnets')[copyIndex('virtualNetworkRules')]]",
                  "ignoreMissingVNetServiceEndpoint": false
                }
              }
            ]
          },
          "resources": [
            {
              "type": "Microsoft.DocumentDB/databaseAccounts",
              "apiVersion": "2023-04-15",
              "name": "[parameters('cosmosAccountName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "kind": "GlobalDocumentDB",
              "identity": {
                "type": "SystemAssigned"
              },
              "properties": {
                "copy": [
                  {
                    "name": "ipRules",
                    "count": "[length(parameters('allowedIpRanges'))]",
                    "input": {
                      "ipAddressOrRange": "[parameters('allowedIpRanges')[copyIndex('ipRules')]]"
                    }
                  }
                ],
                "databaseAccountOfferType": "Standard",
                "consistencyPolicy": {
                  "defaultConsistencyLevel": "[parameters('consistencyLevel')]",
                  "maxIntervalInSeconds": 86400,
                  "maxStalenessPrefix": 1000000
                },
                "locations": [
                  {
                    "locationName": "[parameters('location')]",
                    "failoverPriority": 0,
                    "isZoneRedundant": false
                  }
                ],
                "enableAutomaticFailover": "[parameters('enableAutomaticFailover')]",
                "enableMultipleWriteLocations": "[parameters('enableMultipleWriteLocations')]",
                "isVirtualNetworkFilterEnabled": "[or(or(not(empty(parameters('allowedIpRanges'))), parameters('createPrivateEndpoint')), greater(length(parameters('allowedSubnets')), 0))]",
                "virtualNetworkRules": "[if(greater(length(parameters('allowedSubnets')), 0), variables('virtualNetworkRules'), createArray())]",
                "publicNetworkAccess": "[if(parameters('enablePublicNetworkAccess'), 'Enabled', 'Disabled')]",
                "networkAclBypass": "AzureServices",
                "backupPolicy": {
                  "type": "Periodic",
                  "periodicModeProperties": {
                    "backupIntervalInMinutes": "[parameters('backupIntervalInMinutes')]",
                    "backupRetentionIntervalInHours": "[parameters('backupRetentionIntervalInHours')]",
                    "backupStorageRedundancy": "[parameters('backupStorageRedundancy')]"
                  }
                },
                "analyticalStorageConfiguration": {
                  "schemaType": "WellDefined"
                }
              }
            },
            {
              "condition": "[parameters('createPrivateEndpoint')]",
              "type": "Microsoft.Network/privateEndpoints",
              "apiVersion": "2023-09-01",
              "name": "[format('{0}-pe', parameters('cosmosAccountName'))]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "subnet": {
                  "id": "[parameters('privateEndpointSubnetId')]"
                },
                "privateLinkServiceConnections": [
                  {
                    "name": "[format('{0}-pe-connection', parameters('cosmosAccountName'))]",
                    "properties": {
                      "privateLinkServiceId": "[resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('cosmosAccountName'))]",
                      "groupIds": [
                        "Sql"
                      ]
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('cosmosAccountName'))]"
              ]
            },
            {
              "condition": "[parameters('createPrivateEndpoint')]",
              "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
              "apiVersion": "2023-09-01",
              "name": "[format('{0}/{1}', format('{0}-pe', parameters('cosmosAccountName')), format('{0}-pe-dns-group', parameters('cosmosAccountName')))]",
              "properties": {
                "privateDnsZoneConfigs": [
                  {
                    "name": "privatelink-documents-azure-com",
                    "properties": {
                      "privateDnsZoneId": "[parameters('privateDnsZoneId')]"
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/privateEndpoints', format('{0}-pe', parameters('cosmosAccountName')))]"
              ]
            },
            {
              "copy": {
                "name": "cosmosRoleAssignments",
                "count": "[length(parameters('roleAssignments'))]"
              },
              "condition": "[not(empty(parameters('roleAssignments')[copyIndex()].principalId))]",
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.DocumentDB/databaseAccounts/{0}', parameters('cosmosAccountName'))]",
              "name": "[guid(resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('cosmosAccountName')), parameters('roleAssignments')[copyIndex()].principalId, parameters('roleAssignments')[copyIndex()].roleDefinitionId)]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', parameters('roleAssignments')[copyIndex()].roleDefinitionId)]",
                "principalId": "[parameters('roleAssignments')[copyIndex()].principalId]",
                "principalType": "ServicePrincipal"
              },
              "dependsOn": [
                "[resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('cosmosAccountName'))]"
              ]
            },
            {
              "copy": {
                "name": "cosmosSqlRoleAssignments",
                "count": "[length(parameters('sqlRoleAssignments'))]"
              },
              "condition": "[not(empty(parameters('sqlRoleAssignments')[copyIndex()].principalId))]",
              "type": "Microsoft.DocumentDB/databaseAccounts/sqlRoleAssignments",
              "apiVersion": "2023-04-15",
              "name": "[format('{0}/{1}', parameters('cosmosAccountName'), guid(resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('cosmosAccountName')), parameters('sqlRoleAssignments')[copyIndex()].principalId, parameters('sqlRoleAssignments')[copyIndex()].roleDefinitionId))]",
              "properties": {
                "roleDefinitionId": "[format('{0}/sqlRoleDefinitions/{1}', resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('cosmosAccountName')), parameters('sqlRoleAssignments')[copyIndex()].roleDefinitionId)]",
                "principalId": "[parameters('sqlRoleAssignments')[copyIndex()].principalId]",
                "scope": "[resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('cosmosAccountName'))]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('cosmosAccountName'))]"
              ]
            }
          ],
          "outputs": {
            "cosmosAccountId": {
              "type": "string",
              "value": "[resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('cosmosAccountName'))]"
            },
            "cosmosAccountName": {
              "type": "string",
              "value": "[parameters('cosmosAccountName')]"
            },
            "cosmosAccountEndpoint": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('cosmosAccountName')), '2023-04-15').documentEndpoint]"
            },
            "principalId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('cosmosAccountName')), '2023-04-15', 'full').identity.principalId]"
            },
            "hasPrivateEndpoint": {
              "type": "bool",
              "value": "[parameters('createPrivateEndpoint')]"
            },
            "privateEndpointId": {
              "type": "string",
              "value": "[if(parameters('createPrivateEndpoint'), resourceId('Microsoft.Network/privateEndpoints', format('{0}-pe', parameters('cosmosAccountName'))), '')]"
            },
            "privateEndpointName": {
              "type": "string",
              "value": "[if(parameters('createPrivateEndpoint'), format('{0}-pe', parameters('cosmosAccountName')), '')]"
            },
            "cosmosDataOwnerRoleId": {
              "type": "string",
              "value": "b24988ac-6180-42a0-ab88-20f7382dd24c"
            },
            "cosmosDataContributorRoleId": {
              "type": "string",
              "value": "5bd9cd88-fe45-4216-938b-f97437e15450"
            },
            "cosmosDataReaderRoleId": {
              "type": "string",
              "value": "fbdf93bf-df7d-467e-a4d2-9458aa1360c8"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'adminFunctionAppDeployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'adminPublicWebAppDeployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'adminSiteWebAppDeployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'customerFunctionAppDeployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'customerPublicWebAppDeployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'customerSiteWebAppDeployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'musicApiWebAppDeployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'musicFunctionAppDeployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'privateDnsZonesDeployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'videoApiWebAppDeployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'videoFunctionAppDeployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'virtualNetworkDeployment')]"
      ]
    },
    {
      "condition": "[parameters('featureFlags').enableCosmosDb]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "cosmosAdminDatabaseDeployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "cosmosAccountName": {
            "value": "[parameters('cosmos').accountName]"
          },
          "cosmosAdminDbName": {
            "value": "[parameters('cosmos').databases.adminDb]"
          },
          "tags": {
            "value": "[variables('commonTags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.37.4.10188",
              "templateHash": "2695042256800091037"
            }
          },
          "parameters": {
            "cosmosAccountName": {
              "type": "string"
            },
            "cosmosAdminDbName": {
              "type": "string"
            },
            "tags": {
              "type": "object",
              "defaultValue": {}
            }
          },
          "resources": [
            {
              "type": "Microsoft.DocumentDB/databaseAccounts/sqlDatabases",
              "apiVersion": "2023-09-15",
              "name": "[format('{0}/{1}', parameters('cosmosAccountName'), parameters('cosmosAdminDbName'))]",
              "properties": {
                "resource": {
                  "id": "[parameters('cosmosAdminDbName')]"
                },
                "options": {
                  "throughput": 400
                }
              }
            },
            {
              "type": "Microsoft.DocumentDB/databaseAccounts/sqlDatabases/containers",
              "apiVersion": "2023-09-15",
              "name": "[format('{0}/{1}/{2}', parameters('cosmosAccountName'), parameters('cosmosAdminDbName'), 'admin')]",
              "properties": {
                "resource": {
                  "id": "admin",
                  "partitionKey": {
                    "paths": [
                      "/adminId"
                    ],
                    "kind": "Hash"
                  },
                  "indexingPolicy": {
                    "indexingMode": "consistent",
                    "includedPaths": [
                      {
                        "path": "/*"
                      }
                    ],
                    "excludedPaths": [
                      {
                        "path": "/\"_etag\"/?"
                      }
                    ]
                  }
                },
                "options": {
                  "throughput": 400
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.DocumentDB/databaseAccounts/sqlDatabases', parameters('cosmosAccountName'), parameters('cosmosAdminDbName'))]"
              ]
            }
          ],
          "outputs": {
            "databaseId": {
              "type": "string",
              "value": "[resourceId('Microsoft.DocumentDB/databaseAccounts/sqlDatabases', parameters('cosmosAccountName'), parameters('cosmosAdminDbName'))]"
            },
            "databaseName": {
              "type": "string",
              "value": "[parameters('cosmosAdminDbName')]"
            },
            "adminContainerId": {
              "type": "string",
              "value": "[resourceId('Microsoft.DocumentDB/databaseAccounts/sqlDatabases/containers', parameters('cosmosAccountName'), parameters('cosmosAdminDbName'), 'admin')]"
            },
            "adminContainerName": {
              "type": "string",
              "value": "admin"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'cosmosDbAccountDeployment')]"
      ]
    },
    {
      "condition": "[parameters('featureFlags').enableCosmosDb]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "cosmosCustomerDatabaseDeployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "cosmosAccountName": {
            "value": "[parameters('cosmos').accountName]"
          },
          "cosmosCustomerDbName": {
            "value": "[parameters('cosmos').databases.customerDb]"
          },
          "tags": {
            "value": "[variables('commonTags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.37.4.10188",
              "templateHash": "1609996073151783901"
            }
          },
          "parameters": {
            "cosmosAccountName": {
              "type": "string"
            },
            "cosmosCustomerDbName": {
              "type": "string"
            },
            "tags": {
              "type": "object",
              "defaultValue": {}
            }
          },
          "resources": [
            {
              "type": "Microsoft.DocumentDB/databaseAccounts/sqlDatabases",
              "apiVersion": "2023-09-15",
              "name": "[format('{0}/{1}', parameters('cosmosAccountName'), parameters('cosmosCustomerDbName'))]",
              "properties": {
                "resource": {
                  "id": "[parameters('cosmosCustomerDbName')]"
                },
                "options": {
                  "throughput": 400
                }
              }
            },
            {
              "type": "Microsoft.DocumentDB/databaseAccounts/sqlDatabases/containers",
              "apiVersion": "2023-09-15",
              "name": "[format('{0}/{1}/{2}', parameters('cosmosAccountName'), parameters('cosmosCustomerDbName'), 'customers')]",
              "properties": {
                "resource": {
                  "id": "customers",
                  "partitionKey": {
                    "paths": [
                      "/customerId"
                    ],
                    "kind": "Hash"
                  },
                  "indexingPolicy": {
                    "indexingMode": "consistent",
                    "includedPaths": [
                      {
                        "path": "/*"
                      }
                    ],
                    "excludedPaths": [
                      {
                        "path": "/\"_etag\"/?"
                      }
                    ]
                  }
                },
                "options": {
                  "throughput": 400
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.DocumentDB/databaseAccounts/sqlDatabases', parameters('cosmosAccountName'), parameters('cosmosCustomerDbName'))]"
              ]
            }
          ],
          "outputs": {
            "databaseId": {
              "type": "string",
              "value": "[resourceId('Microsoft.DocumentDB/databaseAccounts/sqlDatabases', parameters('cosmosAccountName'), parameters('cosmosCustomerDbName'))]"
            },
            "databaseName": {
              "type": "string",
              "value": "[parameters('cosmosCustomerDbName')]"
            },
            "customerContainerId": {
              "type": "string",
              "value": "[resourceId('Microsoft.DocumentDB/databaseAccounts/sqlDatabases/containers', parameters('cosmosAccountName'), parameters('cosmosCustomerDbName'), 'customers')]"
            },
            "customerContainerName": {
              "type": "string",
              "value": "customers"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'cosmosDbAccountDeployment')]"
      ]
    },
    {
      "condition": "[parameters('featureFlags').enableCosmosDb]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "cosmosMusicDatabaseDeployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "cosmosAccountName": {
            "value": "[parameters('cosmos').accountName]"
          },
          "cosmosMusicDbName": {
            "value": "[parameters('cosmos').databases.musicDb]"
          },
          "tags": {
            "value": "[variables('commonTags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.37.4.10188",
              "templateHash": "8581565091043130850"
            }
          },
          "parameters": {
            "cosmosAccountName": {
              "type": "string"
            },
            "cosmosMusicDbName": {
              "type": "string"
            },
            "tags": {
              "type": "object",
              "defaultValue": {}
            }
          },
          "resources": [
            {
              "type": "Microsoft.DocumentDB/databaseAccounts/sqlDatabases",
              "apiVersion": "2023-09-15",
              "name": "[format('{0}/{1}', parameters('cosmosAccountName'), parameters('cosmosMusicDbName'))]",
              "properties": {
                "resource": {
                  "id": "[parameters('cosmosMusicDbName')]"
                },
                "options": {
                  "throughput": 400
                }
              }
            },
            {
              "type": "Microsoft.DocumentDB/databaseAccounts/sqlDatabases/containers",
              "apiVersion": "2023-09-15",
              "name": "[format('{0}/{1}/{2}', parameters('cosmosAccountName'), parameters('cosmosMusicDbName'), 'music')]",
              "properties": {
                "resource": {
                  "id": "music",
                  "partitionKey": {
                    "paths": [
                      "/musicId"
                    ],
                    "kind": "Hash"
                  },
                  "indexingPolicy": {
                    "indexingMode": "consistent",
                    "includedPaths": [
                      {
                        "path": "/*"
                      }
                    ],
                    "excludedPaths": [
                      {
                        "path": "/\"_etag\"/?"
                      }
                    ]
                  }
                },
                "options": {
                  "throughput": 400
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.DocumentDB/databaseAccounts/sqlDatabases', parameters('cosmosAccountName'), parameters('cosmosMusicDbName'))]"
              ]
            }
          ],
          "outputs": {
            "databaseId": {
              "type": "string",
              "value": "[resourceId('Microsoft.DocumentDB/databaseAccounts/sqlDatabases', parameters('cosmosAccountName'), parameters('cosmosMusicDbName'))]"
            },
            "databaseName": {
              "type": "string",
              "value": "[parameters('cosmosMusicDbName')]"
            },
            "musicContainerId": {
              "type": "string",
              "value": "[resourceId('Microsoft.DocumentDB/databaseAccounts/sqlDatabases/containers', parameters('cosmosAccountName'), parameters('cosmosMusicDbName'), 'music')]"
            },
            "musicContainerName": {
              "type": "string",
              "value": "music"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'cosmosDbAccountDeployment')]"
      ]
    },
    {
      "condition": "[parameters('featureFlags').enableCosmosDb]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "cosmosVideoDatabaseDeployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "cosmosAccountName": {
            "value": "[parameters('cosmos').accountName]"
          },
          "cosmosVideoDbName": {
            "value": "[parameters('cosmos').databases.videoDb]"
          },
          "tags": {
            "value": "[variables('commonTags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.37.4.10188",
              "templateHash": "5831842424708410695"
            }
          },
          "parameters": {
            "cosmosAccountName": {
              "type": "string"
            },
            "cosmosVideoDbName": {
              "type": "string"
            },
            "tags": {
              "type": "object",
              "defaultValue": {}
            }
          },
          "resources": [
            {
              "type": "Microsoft.DocumentDB/databaseAccounts/sqlDatabases",
              "apiVersion": "2023-09-15",
              "name": "[format('{0}/{1}', parameters('cosmosAccountName'), parameters('cosmosVideoDbName'))]",
              "properties": {
                "resource": {
                  "id": "[parameters('cosmosVideoDbName')]"
                },
                "options": {
                  "throughput": 400
                }
              }
            },
            {
              "type": "Microsoft.DocumentDB/databaseAccounts/sqlDatabases/containers",
              "apiVersion": "2023-09-15",
              "name": "[format('{0}/{1}/{2}', parameters('cosmosAccountName'), parameters('cosmosVideoDbName'), 'videos')]",
              "properties": {
                "resource": {
                  "id": "videos",
                  "partitionKey": {
                    "paths": [
                      "/videoId"
                    ],
                    "kind": "Hash"
                  },
                  "indexingPolicy": {
                    "indexingMode": "consistent",
                    "includedPaths": [
                      {
                        "path": "/*"
                      }
                    ],
                    "excludedPaths": [
                      {
                        "path": "/\"_etag\"/?"
                      }
                    ]
                  }
                },
                "options": {
                  "throughput": 400
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.DocumentDB/databaseAccounts/sqlDatabases', parameters('cosmosAccountName'), parameters('cosmosVideoDbName'))]"
              ]
            }
          ],
          "outputs": {
            "databaseId": {
              "type": "string",
              "value": "[resourceId('Microsoft.DocumentDB/databaseAccounts/sqlDatabases', parameters('cosmosAccountName'), parameters('cosmosVideoDbName'))]"
            },
            "databaseName": {
              "type": "string",
              "value": "[parameters('cosmosVideoDbName')]"
            },
            "videoContainerId": {
              "type": "string",
              "value": "[resourceId('Microsoft.DocumentDB/databaseAccounts/sqlDatabases/containers', parameters('cosmosAccountName'), parameters('cosmosVideoDbName'), 'videos')]"
            },
            "videoContainerName": {
              "type": "string",
              "value": "videos"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'cosmosDbAccountDeployment')]"
      ]
    },
    {
      "condition": "[parameters('featureFlags').enableServiceBus]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "serviceBusNamespaceDeployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('general').location]"
          },
          "namespaceName": {
            "value": "[parameters('serviceBus').namespaceName]"
          },
          "sku": {
            "value": "[parameters('serviceBus').sku]"
          },
          "capacity": {
            "value": "[parameters('serviceBus').capacity]"
          },
          "zoneRedundant": "[if(equals(parameters('serviceBus').sku, 'Premium'), createObject('value', true()), createObject('value', false()))]",
          "createPrivateEndpoint": {
            "value": "[parameters('featureFlags').enablePrivateEndpoints]"
          },
          "privateEndpointSubnetId": "[if(parameters('featureFlags').enablePrivateEndpoints, createObject('value', reference(resourceId('Microsoft.Resources/deployments', 'virtualNetworkDeployment'), '2022-09-01').outputs.privateEndpointSubnetId.value), createObject('value', ''))]",
          "privateDnsZoneId": "[if(and(parameters('featureFlags').enablePrivateEndpoints, parameters('featureFlags').enableServiceBus), createObject('value', reference(resourceId('Microsoft.Resources/deployments', 'privateDnsZonesDeployment'), '2022-09-01').outputs.serviceBusPrivateDnsZoneId.value), createObject('value', ''))]",
          "allowedSubnetIds": "[if(parameters('featureFlags').enableVNetIntegration, createObject('value', createArray(reference(resourceId('Microsoft.Resources/deployments', 'virtualNetworkDeployment'), '2022-09-01').outputs.vnetIntegrationSubnetId.value)), createObject('value', createArray()))]",
          "allowedIpRanges": {
            "value": []
          },
          "topicNames": {
            "value": "[parameters('serviceBus').topicNames]"
          },
          "queueNames": {
            "value": "[parameters('serviceBus').queueNames]"
          },
          "subscriptions": {
            "value": "[parameters('serviceBus').subscriptions]"
          },
          "roleAssignments": {
            "value": "[concat(createArray(createObject('principalId', reference(resourceId('Microsoft.Resources/deployments', 'customerPublicWebAppDeployment'), '2022-09-01').outputs.principalId.value, 'roleDefinitionId', '8d3b2e04-d1a1-4c5b-90ae-ff1c3a4de2f6'), createObject('principalId', reference(resourceId('Microsoft.Resources/deployments', 'customerSiteWebAppDeployment'), '2022-09-01').outputs.principalId.value, 'roleDefinitionId', '8d3b2e04-d1a1-4c5b-90ae-ff1c3a4de2f6'), createObject('principalId', reference(resourceId('Microsoft.Resources/deployments', 'adminPublicWebAppDeployment'), '2022-09-01').outputs.principalId.value, 'roleDefinitionId', '8d3b2e04-d1a1-4c5b-90ae-ff1c3a4de2f6'), createObject('principalId', reference(resourceId('Microsoft.Resources/deployments', 'adminSiteWebAppDeployment'), '2022-09-01').outputs.principalId.value, 'roleDefinitionId', '8d3b2e04-d1a1-4c5b-90ae-ff1c3a4de2f6'), createObject('principalId', reference(resourceId('Microsoft.Resources/deployments', 'videoApiWebAppDeployment'), '2022-09-01').outputs.principalId.value, 'roleDefinitionId', '8d3b2e04-d1a1-4c5b-90ae-ff1c3a4de2f6'), createObject('principalId', reference(resourceId('Microsoft.Resources/deployments', 'musicApiWebAppDeployment'), '2022-09-01').outputs.principalId.value, 'roleDefinitionId', '8d3b2e04-d1a1-4c5b-90ae-ff1c3a4de2f6')), if(parameters('featureFlags').enableFunctionApps, createArray(createObject('principalId', reference(resourceId('Microsoft.Resources/deployments', 'adminFunctionAppDeployment'), '2022-09-01').outputs.principalId.value, 'roleDefinitionId', '8d3b2e04-d1a1-4c5b-90ae-ff1c3a4de2f6'), createObject('principalId', reference(resourceId('Microsoft.Resources/deployments', 'customerFunctionAppDeployment'), '2022-09-01').outputs.principalId.value, 'roleDefinitionId', '8d3b2e04-d1a1-4c5b-90ae-ff1c3a4de2f6'), createObject('principalId', reference(resourceId('Microsoft.Resources/deployments', 'musicFunctionAppDeployment'), '2022-09-01').outputs.principalId.value, 'roleDefinitionId', '8d3b2e04-d1a1-4c5b-90ae-ff1c3a4de2f6'), createObject('principalId', reference(resourceId('Microsoft.Resources/deployments', 'videoFunctionAppDeployment'), '2022-09-01').outputs.principalId.value, 'roleDefinitionId', '8d3b2e04-d1a1-4c5b-90ae-ff1c3a4de2f6')), createArray()))]"
          },
          "tags": {
            "value": "[variables('commonTags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.37.4.10188",
              "templateHash": "9356063441876143143"
            }
          },
          "parameters": {
            "location": {
              "type": "string"
            },
            "namespaceName": {
              "type": "string"
            },
            "sku": {
              "type": "string"
            },
            "capacity": {
              "type": "int"
            },
            "zoneRedundant": {
              "type": "bool"
            },
            "createPrivateEndpoint": {
              "type": "bool"
            },
            "privateEndpointSubnetId": {
              "type": "string"
            },
            "privateDnsZoneId": {
              "type": "string"
            },
            "tags": {
              "type": "object"
            },
            "topicNames": {
              "type": "array"
            },
            "queueNames": {
              "type": "array"
            },
            "subscriptions": {
              "type": "array"
            },
            "roleAssignments": {
              "type": "array"
            },
            "allowedSubnetIds": {
              "type": "array"
            },
            "allowedIpRanges": {
              "type": "array"
            }
          },
          "resources": [
            {
              "type": "Microsoft.ServiceBus/namespaces",
              "apiVersion": "2022-10-01-preview",
              "name": "[parameters('namespaceName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "sku": {
                "name": "[parameters('sku')]",
                "tier": "[parameters('sku')]",
                "capacity": "[parameters('capacity')]"
              },
              "properties": {
                "minimumTlsVersion": "1.2",
                "publicNetworkAccess": "[if(parameters('createPrivateEndpoint'), 'Disabled', 'Enabled')]",
                "zoneRedundant": "[parameters('zoneRedundant')]",
                "disableLocalAuth": false
              }
            },
            {
              "condition": "[or(greater(length(parameters('allowedSubnetIds')), 0), greater(length(parameters('allowedIpRanges')), 0))]",
              "type": "Microsoft.ServiceBus/namespaces/networkRuleSets",
              "apiVersion": "2022-10-01-preview",
              "name": "[format('{0}/{1}', parameters('namespaceName'), 'default')]",
              "properties": {
                "copy": [
                  {
                    "name": "virtualNetworkRules",
                    "count": "[length(parameters('allowedSubnetIds'))]",
                    "input": {
                      "subnet": {
                        "id": "[parameters('allowedSubnetIds')[copyIndex('virtualNetworkRules')]]"
                      },
                      "ignoreMissingVnetServiceEndpoint": false
                    }
                  },
                  {
                    "name": "ipRules",
                    "count": "[length(parameters('allowedIpRanges'))]",
                    "input": {
                      "ipMask": "[parameters('allowedIpRanges')[copyIndex('ipRules')]]",
                      "action": "Allow"
                    }
                  }
                ],
                "defaultAction": "Deny",
                "trustedServiceAccessEnabled": true
              },
              "dependsOn": [
                "[resourceId('Microsoft.ServiceBus/namespaces', parameters('namespaceName'))]"
              ]
            },
            {
              "copy": {
                "name": "serviceBusTopics",
                "count": "[length(parameters('topicNames'))]"
              },
              "type": "Microsoft.ServiceBus/namespaces/topics",
              "apiVersion": "2022-10-01-preview",
              "name": "[format('{0}/{1}', parameters('namespaceName'), parameters('topicNames')[copyIndex()])]",
              "properties": {
                "maxMessageSizeInKilobytes": 256,
                "defaultMessageTimeToLive": "P14D",
                "maxSizeInMegabytes": 1024,
                "requiresDuplicateDetection": false,
                "duplicateDetectionHistoryTimeWindow": "PT10M",
                "enableBatchedOperations": true,
                "status": "Active",
                "supportOrdering": false,
                "autoDeleteOnIdle": "P10675199DT2H48M5.4775807S",
                "enablePartitioning": false,
                "enableExpress": false
              },
              "dependsOn": [
                "[resourceId('Microsoft.ServiceBus/namespaces', parameters('namespaceName'))]"
              ]
            },
            {
              "copy": {
                "name": "serviceBusQueues",
                "count": "[length(parameters('queueNames'))]"
              },
              "type": "Microsoft.ServiceBus/namespaces/queues",
              "apiVersion": "2022-10-01-preview",
              "name": "[format('{0}/{1}', parameters('namespaceName'), parameters('queueNames')[copyIndex()])]",
              "properties": {
                "maxSizeInMegabytes": 1024,
                "maxDeliveryCount": 10,
                "defaultMessageTimeToLive": "P14D",
                "duplicateDetectionHistoryTimeWindow": "PT10M",
                "lockDuration": "PT1M",
                "enableBatchedOperations": true,
                "enablePartitioning": false,
                "requiresDuplicateDetection": false,
                "requiresSession": false,
                "deadLetteringOnMessageExpiration": false,
                "autoDeleteOnIdle": "P10675199DT2H48M5.4775807S"
              },
              "dependsOn": [
                "[resourceId('Microsoft.ServiceBus/namespaces', parameters('namespaceName'))]"
              ]
            },
            {
              "copy": {
                "name": "serviceBusSubscriptions",
                "count": "[length(parameters('subscriptions'))]"
              },
              "type": "Microsoft.ServiceBus/namespaces/topics/subscriptions",
              "apiVersion": "2022-10-01-preview",
              "name": "[format('{0}/{1}/{2}', parameters('namespaceName'), parameters('topicNames')[indexOf(parameters('topicNames'), parameters('subscriptions')[copyIndex()].topicName)], parameters('subscriptions')[copyIndex()].subscriptionName)]",
              "properties": {
                "isClientAffine": false,
                "lockDuration": "PT1M",
                "requiresSession": "[parameters('subscriptions')[copyIndex()].requiresSession]",
                "defaultMessageTimeToLive": "P14D",
                "deadLetteringOnMessageExpiration": false,
                "deadLetteringOnFilterEvaluationExceptions": false,
                "maxDeliveryCount": 10,
                "status": "Active",
                "enableBatchedOperations": true,
                "autoDeleteOnIdle": "P10675198DT2H48M5S"
              },
              "dependsOn": [
                "[resourceId('Microsoft.ServiceBus/namespaces/topics', parameters('namespaceName'), parameters('topicNames')[indexOf(parameters('topicNames'), parameters('subscriptions')[copyIndex()].topicName)])]"
              ]
            },
            {
              "copy": {
                "name": "serviceBusRoleAssignments",
                "count": "[length(parameters('roleAssignments'))]"
              },
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.ServiceBus/namespaces/{0}', parameters('namespaceName'))]",
              "name": "[guid(resourceId('Microsoft.ServiceBus/namespaces', parameters('namespaceName')), parameters('roleAssignments')[copyIndex()].principalId, parameters('roleAssignments')[copyIndex()].roleDefinitionId)]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', parameters('roleAssignments')[copyIndex()].roleDefinitionId)]",
                "principalId": "[parameters('roleAssignments')[copyIndex()].principalId]",
                "principalType": "ServicePrincipal"
              },
              "dependsOn": [
                "[resourceId('Microsoft.ServiceBus/namespaces', parameters('namespaceName'))]"
              ]
            },
            {
              "condition": "[and(parameters('createPrivateEndpoint'), not(empty(parameters('privateEndpointSubnetId'))))]",
              "type": "Microsoft.Network/privateEndpoints",
              "apiVersion": "2023-09-01",
              "name": "[format('{0}-pe', parameters('namespaceName'))]",
              "location": "[parameters('location')]",
              "properties": {
                "subnet": {
                  "id": "[parameters('privateEndpointSubnetId')]"
                },
                "privateLinkServiceConnections": [
                  {
                    "name": "[format('{0}-psc', parameters('namespaceName'))]",
                    "properties": {
                      "privateLinkServiceId": "[resourceId('Microsoft.ServiceBus/namespaces', parameters('namespaceName'))]",
                      "groupIds": [
                        "namespace"
                      ]
                    }
                  }
                ]
              },
              "tags": "[parameters('tags')]",
              "dependsOn": [
                "[resourceId('Microsoft.ServiceBus/namespaces', parameters('namespaceName'))]"
              ]
            },
            {
              "condition": "[and(parameters('createPrivateEndpoint'), not(empty(parameters('privateDnsZoneId'))))]",
              "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
              "apiVersion": "2023-09-01",
              "name": "[format('{0}/{1}', format('{0}-pe', parameters('namespaceName')), 'default')]",
              "properties": {
                "privateDnsZoneConfigs": [
                  {
                    "name": "servicebus-config",
                    "properties": {
                      "privateDnsZoneId": "[parameters('privateDnsZoneId')]"
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/privateEndpoints', format('{0}-pe', parameters('namespaceName')))]"
              ]
            }
          ],
          "outputs": {
            "serviceBusNamespaceId": {
              "type": "string",
              "value": "[resourceId('Microsoft.ServiceBus/namespaces', parameters('namespaceName'))]"
            },
            "serviceBusNamespaceName": {
              "type": "string",
              "value": "[parameters('namespaceName')]"
            },
            "serviceBusNamespaceHostName": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.ServiceBus/namespaces', parameters('namespaceName')), '2022-10-01-preview').serviceBusEndpoint]"
            },
            "hasPrivateEndpoint": {
              "type": "bool",
              "value": "[and(parameters('createPrivateEndpoint'), not(empty(parameters('privateEndpointSubnetId'))))]"
            },
            "privateEndpointId": {
              "type": "string",
              "value": "[if(parameters('createPrivateEndpoint'), resourceId('Microsoft.Network/privateEndpoints', format('{0}-pe', parameters('namespaceName'))), '')]"
            },
            "privateEndpointName": {
              "type": "string",
              "value": "[if(parameters('createPrivateEndpoint'), format('{0}-pe', parameters('namespaceName')), '')]"
            },
            "serviceBusDataOwnerRoleId": {
              "type": "string",
              "value": "090c5cfd-751d-490a-894a-3ce6f1109419"
            },
            "serviceBusDataReceiverRoleId": {
              "type": "string",
              "value": "4f6d3b9b-027b-4f4c-9142-0e5a2a2247e0"
            },
            "serviceBusDataSenderRoleId": {
              "type": "string",
              "value": "69a216fc-b8fb-44d8-bc22-1f3c2cd27a39"
            },
            "serviceBusDataContributorRoleId": {
              "type": "string",
              "value": "8d3b2e04-d1a1-4c5b-90ae-ff1c3a4de2f6"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'adminFunctionAppDeployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'adminPublicWebAppDeployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'adminSiteWebAppDeployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'customerFunctionAppDeployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'customerPublicWebAppDeployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'customerSiteWebAppDeployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'musicApiWebAppDeployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'musicFunctionAppDeployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'privateDnsZonesDeployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'videoApiWebAppDeployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'videoFunctionAppDeployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'virtualNetworkDeployment')]"
      ]
    },
    {
      "condition": "[parameters('featureFlags').enableApplicationInsights]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "logAnalyticsWorkspaceDeployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('general').location]"
          },
          "workspaceName": {
            "value": "[parameters('applicationInsights').workspaceName]"
          },
          "retentionInDays": {
            "value": "[parameters('applicationInsights').retentionInDays]"
          },
          "tags": {
            "value": "[variables('commonTags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.37.4.10188",
              "templateHash": "12707922034714590925"
            }
          },
          "parameters": {
            "location": {
              "type": "string"
            },
            "workspaceName": {
              "type": "string"
            },
            "retentionInDays": {
              "type": "int",
              "defaultValue": 30
            },
            "tags": {
              "type": "object",
              "defaultValue": {}
            }
          },
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/workspaces",
              "apiVersion": "2023-09-01",
              "name": "[parameters('workspaceName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "sku": {
                  "name": "PerGB2018"
                },
                "retentionInDays": "[parameters('retentionInDays')]",
                "features": {
                  "enableLogAccessUsingOnlyResourcePermissions": true
                }
              }
            }
          ],
          "outputs": {
            "workspaceId": {
              "type": "string",
              "value": "[resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspaceName'))]"
            },
            "workspaceName": {
              "type": "string",
              "value": "[parameters('workspaceName')]"
            }
          }
        }
      }
    },
    {
      "condition": "[parameters('featureFlags').enableApplicationInsights]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "applicationInsightsDeployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('general').location]"
          },
          "logAnalyticsWorkspaceId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'logAnalyticsWorkspaceDeployment'), '2022-09-01').outputs.workspaceId.value]"
          },
          "customerAppInsightsName": {
            "value": "[format('{0}-ai', parameters('webApps').apps.customerSite)]"
          },
          "adminAppInsightsName": {
            "value": "[format('{0}-ai', parameters('webApps').apps.adminSite)]"
          },
          "videoAppInsightsName": {
            "value": "[format('{0}-ai', parameters('webApps').apps.videoApi)]"
          },
          "musicAppInsightsName": {
            "value": "[format('{0}-ai', parameters('webApps').apps.musicApi)]"
          },
          "tags": {
            "value": "[variables('commonTags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.37.4.10188",
              "templateHash": "17807967071039463811"
            }
          },
          "parameters": {
            "location": {
              "type": "string"
            },
            "logAnalyticsWorkspaceId": {
              "type": "string"
            },
            "tags": {
              "type": "object",
              "defaultValue": {}
            },
            "customerAppInsightsName": {
              "type": "string"
            },
            "adminAppInsightsName": {
              "type": "string"
            },
            "videoAppInsightsName": {
              "type": "string"
            },
            "musicAppInsightsName": {
              "type": "string"
            }
          },
          "resources": [
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2022-09-01",
              "name": "customerAppInsightsDeployment",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "name": {
                    "value": "[parameters('customerAppInsightsName')]"
                  },
                  "logAnalyticsWorkspaceId": {
                    "value": "[parameters('logAnalyticsWorkspaceId')]"
                  },
                  "tags": {
                    "value": "[parameters('tags')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.37.4.10188",
                      "templateHash": "11327439259216109659"
                    }
                  },
                  "parameters": {
                    "location": {
                      "type": "string"
                    },
                    "name": {
                      "type": "string"
                    },
                    "logAnalyticsWorkspaceId": {
                      "type": "string"
                    },
                    "tags": {
                      "type": "object",
                      "defaultValue": {}
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Insights/components",
                      "apiVersion": "2020-02-02",
                      "name": "[parameters('name')]",
                      "location": "[parameters('location')]",
                      "tags": "[parameters('tags')]",
                      "kind": "web",
                      "properties": {
                        "Application_Type": "web",
                        "WorkspaceResourceId": "[parameters('logAnalyticsWorkspaceId')]",
                        "IngestionMode": "LogAnalytics",
                        "publicNetworkAccessForIngestion": "Enabled",
                        "publicNetworkAccessForQuery": "Enabled"
                      }
                    }
                  ],
                  "outputs": {
                    "appInsightsId": {
                      "type": "string",
                      "value": "[resourceId('Microsoft.Insights/components', parameters('name'))]"
                    },
                    "appInsightsName": {
                      "type": "string",
                      "value": "[parameters('name')]"
                    },
                    "appInsightsInstrumentationKey": {
                      "type": "string",
                      "value": "[reference(resourceId('Microsoft.Insights/components', parameters('name')), '2020-02-02').InstrumentationKey]"
                    },
                    "appInsightsConnectionString": {
                      "type": "string",
                      "value": "[reference(resourceId('Microsoft.Insights/components', parameters('name')), '2020-02-02').ConnectionString]"
                    }
                  }
                }
              }
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2022-09-01",
              "name": "adminAppInsightsDeployment",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "name": {
                    "value": "[parameters('adminAppInsightsName')]"
                  },
                  "logAnalyticsWorkspaceId": {
                    "value": "[parameters('logAnalyticsWorkspaceId')]"
                  },
                  "tags": {
                    "value": "[parameters('tags')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.37.4.10188",
                      "templateHash": "11327439259216109659"
                    }
                  },
                  "parameters": {
                    "location": {
                      "type": "string"
                    },
                    "name": {
                      "type": "string"
                    },
                    "logAnalyticsWorkspaceId": {
                      "type": "string"
                    },
                    "tags": {
                      "type": "object",
                      "defaultValue": {}
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Insights/components",
                      "apiVersion": "2020-02-02",
                      "name": "[parameters('name')]",
                      "location": "[parameters('location')]",
                      "tags": "[parameters('tags')]",
                      "kind": "web",
                      "properties": {
                        "Application_Type": "web",
                        "WorkspaceResourceId": "[parameters('logAnalyticsWorkspaceId')]",
                        "IngestionMode": "LogAnalytics",
                        "publicNetworkAccessForIngestion": "Enabled",
                        "publicNetworkAccessForQuery": "Enabled"
                      }
                    }
                  ],
                  "outputs": {
                    "appInsightsId": {
                      "type": "string",
                      "value": "[resourceId('Microsoft.Insights/components', parameters('name'))]"
                    },
                    "appInsightsName": {
                      "type": "string",
                      "value": "[parameters('name')]"
                    },
                    "appInsightsInstrumentationKey": {
                      "type": "string",
                      "value": "[reference(resourceId('Microsoft.Insights/components', parameters('name')), '2020-02-02').InstrumentationKey]"
                    },
                    "appInsightsConnectionString": {
                      "type": "string",
                      "value": "[reference(resourceId('Microsoft.Insights/components', parameters('name')), '2020-02-02').ConnectionString]"
                    }
                  }
                }
              }
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2022-09-01",
              "name": "videoAppInsightsDeployment",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "name": {
                    "value": "[parameters('videoAppInsightsName')]"
                  },
                  "logAnalyticsWorkspaceId": {
                    "value": "[parameters('logAnalyticsWorkspaceId')]"
                  },
                  "tags": {
                    "value": "[parameters('tags')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.37.4.10188",
                      "templateHash": "11327439259216109659"
                    }
                  },
                  "parameters": {
                    "location": {
                      "type": "string"
                    },
                    "name": {
                      "type": "string"
                    },
                    "logAnalyticsWorkspaceId": {
                      "type": "string"
                    },
                    "tags": {
                      "type": "object",
                      "defaultValue": {}
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Insights/components",
                      "apiVersion": "2020-02-02",
                      "name": "[parameters('name')]",
                      "location": "[parameters('location')]",
                      "tags": "[parameters('tags')]",
                      "kind": "web",
                      "properties": {
                        "Application_Type": "web",
                        "WorkspaceResourceId": "[parameters('logAnalyticsWorkspaceId')]",
                        "IngestionMode": "LogAnalytics",
                        "publicNetworkAccessForIngestion": "Enabled",
                        "publicNetworkAccessForQuery": "Enabled"
                      }
                    }
                  ],
                  "outputs": {
                    "appInsightsId": {
                      "type": "string",
                      "value": "[resourceId('Microsoft.Insights/components', parameters('name'))]"
                    },
                    "appInsightsName": {
                      "type": "string",
                      "value": "[parameters('name')]"
                    },
                    "appInsightsInstrumentationKey": {
                      "type": "string",
                      "value": "[reference(resourceId('Microsoft.Insights/components', parameters('name')), '2020-02-02').InstrumentationKey]"
                    },
                    "appInsightsConnectionString": {
                      "type": "string",
                      "value": "[reference(resourceId('Microsoft.Insights/components', parameters('name')), '2020-02-02').ConnectionString]"
                    }
                  }
                }
              }
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2022-09-01",
              "name": "musicAppInsightsDeployment",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "name": {
                    "value": "[parameters('musicAppInsightsName')]"
                  },
                  "logAnalyticsWorkspaceId": {
                    "value": "[parameters('logAnalyticsWorkspaceId')]"
                  },
                  "tags": {
                    "value": "[parameters('tags')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.37.4.10188",
                      "templateHash": "11327439259216109659"
                    }
                  },
                  "parameters": {
                    "location": {
                      "type": "string"
                    },
                    "name": {
                      "type": "string"
                    },
                    "logAnalyticsWorkspaceId": {
                      "type": "string"
                    },
                    "tags": {
                      "type": "object",
                      "defaultValue": {}
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Insights/components",
                      "apiVersion": "2020-02-02",
                      "name": "[parameters('name')]",
                      "location": "[parameters('location')]",
                      "tags": "[parameters('tags')]",
                      "kind": "web",
                      "properties": {
                        "Application_Type": "web",
                        "WorkspaceResourceId": "[parameters('logAnalyticsWorkspaceId')]",
                        "IngestionMode": "LogAnalytics",
                        "publicNetworkAccessForIngestion": "Enabled",
                        "publicNetworkAccessForQuery": "Enabled"
                      }
                    }
                  ],
                  "outputs": {
                    "appInsightsId": {
                      "type": "string",
                      "value": "[resourceId('Microsoft.Insights/components', parameters('name'))]"
                    },
                    "appInsightsName": {
                      "type": "string",
                      "value": "[parameters('name')]"
                    },
                    "appInsightsInstrumentationKey": {
                      "type": "string",
                      "value": "[reference(resourceId('Microsoft.Insights/components', parameters('name')), '2020-02-02').InstrumentationKey]"
                    },
                    "appInsightsConnectionString": {
                      "type": "string",
                      "value": "[reference(resourceId('Microsoft.Insights/components', parameters('name')), '2020-02-02').ConnectionString]"
                    }
                  }
                }
              }
            }
          ],
          "outputs": {
            "customerAppInsights": {
              "type": "object",
              "value": {
                "applicationInsightsId": "[reference(resourceId('Microsoft.Resources/deployments', 'customerAppInsightsDeployment'), '2022-09-01').outputs.appInsightsId.value]",
                "applicationInsightsName": "[reference(resourceId('Microsoft.Resources/deployments', 'customerAppInsightsDeployment'), '2022-09-01').outputs.appInsightsName.value]",
                "instrumentationKey": "[reference(resourceId('Microsoft.Resources/deployments', 'customerAppInsightsDeployment'), '2022-09-01').outputs.appInsightsInstrumentationKey.value]",
                "connectionString": "[reference(resourceId('Microsoft.Resources/deployments', 'customerAppInsightsDeployment'), '2022-09-01').outputs.appInsightsConnectionString.value]"
              }
            },
            "adminAppInsights": {
              "type": "object",
              "value": {
                "applicationInsightsId": "[reference(resourceId('Microsoft.Resources/deployments', 'adminAppInsightsDeployment'), '2022-09-01').outputs.appInsightsId.value]",
                "applicationInsightsName": "[reference(resourceId('Microsoft.Resources/deployments', 'adminAppInsightsDeployment'), '2022-09-01').outputs.appInsightsName.value]",
                "instrumentationKey": "[reference(resourceId('Microsoft.Resources/deployments', 'adminAppInsightsDeployment'), '2022-09-01').outputs.appInsightsInstrumentationKey.value]",
                "connectionString": "[reference(resourceId('Microsoft.Resources/deployments', 'adminAppInsightsDeployment'), '2022-09-01').outputs.appInsightsConnectionString.value]"
              }
            },
            "videoAppInsights": {
              "type": "object",
              "value": {
                "applicationInsightsId": "[reference(resourceId('Microsoft.Resources/deployments', 'videoAppInsightsDeployment'), '2022-09-01').outputs.appInsightsId.value]",
                "applicationInsightsName": "[reference(resourceId('Microsoft.Resources/deployments', 'videoAppInsightsDeployment'), '2022-09-01').outputs.appInsightsName.value]",
                "instrumentationKey": "[reference(resourceId('Microsoft.Resources/deployments', 'videoAppInsightsDeployment'), '2022-09-01').outputs.appInsightsInstrumentationKey.value]",
                "connectionString": "[reference(resourceId('Microsoft.Resources/deployments', 'videoAppInsightsDeployment'), '2022-09-01').outputs.appInsightsConnectionString.value]"
              }
            },
            "musicAppInsights": {
              "type": "object",
              "value": {
                "applicationInsightsId": "[reference(resourceId('Microsoft.Resources/deployments', 'musicAppInsightsDeployment'), '2022-09-01').outputs.appInsightsId.value]",
                "applicationInsightsName": "[reference(resourceId('Microsoft.Resources/deployments', 'musicAppInsightsDeployment'), '2022-09-01').outputs.appInsightsName.value]",
                "instrumentationKey": "[reference(resourceId('Microsoft.Resources/deployments', 'musicAppInsightsDeployment'), '2022-09-01').outputs.appInsightsInstrumentationKey.value]",
                "connectionString": "[reference(resourceId('Microsoft.Resources/deployments', 'musicAppInsightsDeployment'), '2022-09-01').outputs.appInsightsConnectionString.value]"
              }
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'logAnalyticsWorkspaceDeployment')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "appServicePlanDeployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('general').location]"
          },
          "appServicePlanName": {
            "value": "[parameters('webApps').appServicePlanName]"
          },
          "tags": {
            "value": "[variables('commonTags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.37.4.10188",
              "templateHash": "17853232572779206144"
            }
          },
          "parameters": {
            "location": {
              "type": "string"
            },
            "appServicePlanName": {
              "type": "string"
            },
            "skuName": {
              "type": "string",
              "defaultValue": "B1"
            },
            "skuTier": {
              "type": "string",
              "defaultValue": "Basic"
            },
            "tags": {
              "type": "object",
              "defaultValue": {}
            }
          },
          "resources": [
            {
              "type": "Microsoft.Web/serverfarms",
              "apiVersion": "2023-01-01",
              "name": "[parameters('appServicePlanName')]",
              "location": "[parameters('location')]",
              "kind": "linux",
              "tags": "[parameters('tags')]",
              "sku": {
                "name": "[parameters('skuName')]",
                "tier": "[parameters('skuTier')]"
              },
              "properties": {
                "reserved": true
              }
            }
          ],
          "outputs": {
            "appServicePlanId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Web/serverfarms', parameters('appServicePlanName'))]"
            },
            "appServicePlanName": {
              "type": "string",
              "value": "[parameters('appServicePlanName')]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "customerPublicWebAppDeployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('general').location]"
          },
          "webAppName": {
            "value": "[parameters('webApps').apps.customerPublic]"
          },
          "appServicePlanId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'appServicePlanDeployment'), '2022-09-01').outputs.appServicePlanId.value]"
          },
          "enableVNetIntegration": {
            "value": "[parameters('featureFlags').enableVNetIntegration]"
          },
          "vnetIntegrationSubnetId": "[if(parameters('featureFlags').enableVNetIntegration, createObject('value', reference(resourceId('Microsoft.Resources/deployments', 'virtualNetworkDeployment'), '2022-09-01').outputs.vnetIntegrationSubnetId.value), createObject('value', ''))]",
          "tags": {
            "value": "[variables('commonTags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.37.4.10188",
              "templateHash": "8311683706504308824"
            }
          },
          "parameters": {
            "location": {
              "type": "string"
            },
            "webAppName": {
              "type": "string"
            },
            "appServicePlanId": {
              "type": "string"
            },
            "tags": {
              "type": "object",
              "defaultValue": {}
            },
            "enableVNetIntegration": {
              "type": "bool",
              "defaultValue": false
            },
            "vnetIntegrationSubnetId": {
              "type": "string",
              "defaultValue": ""
            },
            "linuxFxVersion": {
              "type": "string",
              "defaultValue": "DOTNET|8.0"
            },
            "alwaysOn": {
              "type": "bool",
              "defaultValue": true
            },
            "httpsOnly": {
              "type": "bool",
              "defaultValue": true
            },
            "minTlsVersion": {
              "type": "string",
              "defaultValue": "1.2"
            },
            "ftpsState": {
              "type": "string",
              "defaultValue": "Disabled"
            }
          },
          "resources": [
            {
              "type": "Microsoft.Web/sites",
              "apiVersion": "2023-01-01",
              "name": "[parameters('webAppName')]",
              "location": "[parameters('location')]",
              "kind": "app",
              "tags": "[parameters('tags')]",
              "identity": {
                "type": "SystemAssigned"
              },
              "properties": {
                "serverFarmId": "[parameters('appServicePlanId')]",
                "siteConfig": {
                  "linuxFxVersion": "[parameters('linuxFxVersion')]",
                  "alwaysOn": "[parameters('alwaysOn')]",
                  "ftpsState": "[parameters('ftpsState')]",
                  "minTlsVersion": "[parameters('minTlsVersion')]"
                },
                "publicNetworkAccess": "Enabled",
                "httpsOnly": "[parameters('httpsOnly')]",
                "virtualNetworkSubnetId": "[if(parameters('enableVNetIntegration'), parameters('vnetIntegrationSubnetId'), null())]"
              }
            }
          ],
          "outputs": {
            "webAppId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Web/sites', parameters('webAppName'))]"
            },
            "webAppName": {
              "type": "string",
              "value": "[parameters('webAppName')]"
            },
            "defaultHostName": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Web/sites', parameters('webAppName')), '2023-01-01').defaultHostName]"
            },
            "principalId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Web/sites', parameters('webAppName')), '2023-01-01', 'full').identity.principalId]"
            },
            "hasPrivateEndpoint": {
              "type": "bool",
              "value": false
            },
            "privateEndpointId": {
              "type": "string",
              "value": ""
            },
            "privateEndpointName": {
              "type": "string",
              "value": ""
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'appServicePlanDeployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'virtualNetworkDeployment')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "customerSiteWebAppDeployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('general').location]"
          },
          "webAppName": {
            "value": "[parameters('webApps').apps.customerSite]"
          },
          "appServicePlanId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'appServicePlanDeployment'), '2022-09-01').outputs.appServicePlanId.value]"
          },
          "createPrivateEndpoint": {
            "value": "[parameters('featureFlags').enablePrivateEndpoints]"
          },
          "privateEndpointSubnetId": "[if(parameters('featureFlags').enablePrivateEndpoints, createObject('value', reference(resourceId('Microsoft.Resources/deployments', 'virtualNetworkDeployment'), '2022-09-01').outputs.privateEndpointSubnetId.value), createObject('value', ''))]",
          "privateDnsZoneId": "[if(parameters('featureFlags').enablePrivateEndpoints, createObject('value', reference(resourceId('Microsoft.Resources/deployments', 'privateDnsZonesDeployment'), '2022-09-01').outputs.appServicePrivateDnsZoneId.value), createObject('value', ''))]",
          "enableVNetIntegration": {
            "value": "[parameters('featureFlags').enableVNetIntegration]"
          },
          "vnetIntegrationSubnetId": "[if(parameters('featureFlags').enableVNetIntegration, createObject('value', reference(resourceId('Microsoft.Resources/deployments', 'virtualNetworkDeployment'), '2022-09-01').outputs.vnetIntegrationSubnetId.value), createObject('value', ''))]",
          "tags": {
            "value": "[variables('commonTags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.37.4.10188",
              "templateHash": "9192107508098413117"
            }
          },
          "parameters": {
            "location": {
              "type": "string"
            },
            "webAppName": {
              "type": "string"
            },
            "appServicePlanId": {
              "type": "string"
            },
            "tags": {
              "type": "object",
              "defaultValue": {}
            },
            "enableVNetIntegration": {
              "type": "bool",
              "defaultValue": false
            },
            "vnetIntegrationSubnetId": {
              "type": "string",
              "defaultValue": ""
            },
            "linuxFxVersion": {
              "type": "string",
              "defaultValue": "DOTNET|8.0"
            },
            "alwaysOn": {
              "type": "bool",
              "defaultValue": true
            },
            "httpsOnly": {
              "type": "bool",
              "defaultValue": true
            },
            "minTlsVersion": {
              "type": "string",
              "defaultValue": "1.2"
            },
            "ftpsState": {
              "type": "string",
              "defaultValue": "Disabled"
            },
            "createPrivateEndpoint": {
              "type": "bool",
              "defaultValue": false
            },
            "privateEndpointSubnetId": {
              "type": "string",
              "defaultValue": ""
            },
            "privateDnsZoneId": {
              "type": "string",
              "defaultValue": ""
            }
          },
          "resources": [
            {
              "type": "Microsoft.Web/sites",
              "apiVersion": "2023-01-01",
              "name": "[parameters('webAppName')]",
              "location": "[parameters('location')]",
              "kind": "app",
              "tags": "[parameters('tags')]",
              "identity": {
                "type": "SystemAssigned"
              },
              "properties": {
                "serverFarmId": "[parameters('appServicePlanId')]",
                "siteConfig": {
                  "linuxFxVersion": "[parameters('linuxFxVersion')]",
                  "alwaysOn": "[parameters('alwaysOn')]",
                  "ftpsState": "[parameters('ftpsState')]",
                  "minTlsVersion": "[parameters('minTlsVersion')]"
                },
                "publicNetworkAccess": "[if(parameters('createPrivateEndpoint'), 'Disabled', 'Enabled')]",
                "httpsOnly": "[parameters('httpsOnly')]",
                "virtualNetworkSubnetId": "[if(parameters('enableVNetIntegration'), parameters('vnetIntegrationSubnetId'), null())]"
              }
            },
            {
              "condition": "[parameters('createPrivateEndpoint')]",
              "type": "Microsoft.Network/privateEndpoints",
              "apiVersion": "2023-09-01",
              "name": "[format('{0}-pe', parameters('webAppName'))]",
              "location": "[parameters('location')]",
              "properties": {
                "subnet": {
                  "id": "[parameters('privateEndpointSubnetId')]"
                },
                "privateLinkServiceConnections": [
                  {
                    "name": "[format('{0}-pe-connection', parameters('webAppName'))]",
                    "properties": {
                      "privateLinkServiceId": "[resourceId('Microsoft.Web/sites', parameters('webAppName'))]",
                      "groupIds": [
                        "sites"
                      ]
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Web/sites', parameters('webAppName'))]"
              ]
            },
            {
              "condition": "[parameters('createPrivateEndpoint')]",
              "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
              "apiVersion": "2023-09-01",
              "name": "[format('{0}/{1}', format('{0}-pe', parameters('webAppName')), format('{0}-pe-dns-group', parameters('webAppName')))]",
              "properties": {
                "privateDnsZoneConfigs": [
                  {
                    "name": "config",
                    "properties": {
                      "privateDnsZoneId": "[parameters('privateDnsZoneId')]"
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/privateEndpoints', format('{0}-pe', parameters('webAppName')))]"
              ]
            }
          ],
          "outputs": {
            "webAppId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Web/sites', parameters('webAppName'))]"
            },
            "webAppName": {
              "type": "string",
              "value": "[parameters('webAppName')]"
            },
            "defaultHostName": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Web/sites', parameters('webAppName')), '2023-01-01').defaultHostName]"
            },
            "principalId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Web/sites', parameters('webAppName')), '2023-01-01', 'full').identity.principalId]"
            },
            "hasPrivateEndpoint": {
              "type": "bool",
              "value": "[parameters('createPrivateEndpoint')]"
            },
            "privateEndpointId": {
              "type": "string",
              "value": "[if(parameters('createPrivateEndpoint'), resourceId('Microsoft.Network/privateEndpoints', format('{0}-pe', parameters('webAppName'))), '')]"
            },
            "privateEndpointName": {
              "type": "string",
              "value": "[if(parameters('createPrivateEndpoint'), format('{0}-pe', parameters('webAppName')), '')]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'appServicePlanDeployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'privateDnsZonesDeployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'virtualNetworkDeployment')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "adminPublicWebAppDeployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('general').location]"
          },
          "webAppName": {
            "value": "[parameters('webApps').apps.adminPublic]"
          },
          "appServicePlanId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'appServicePlanDeployment'), '2022-09-01').outputs.appServicePlanId.value]"
          },
          "enableVNetIntegration": {
            "value": "[parameters('featureFlags').enableVNetIntegration]"
          },
          "vnetIntegrationSubnetId": "[if(parameters('featureFlags').enableVNetIntegration, createObject('value', reference(resourceId('Microsoft.Resources/deployments', 'virtualNetworkDeployment'), '2022-09-01').outputs.vnetIntegrationSubnetId.value), createObject('value', ''))]",
          "tags": {
            "value": "[variables('commonTags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.37.4.10188",
              "templateHash": "8311683706504308824"
            }
          },
          "parameters": {
            "location": {
              "type": "string"
            },
            "webAppName": {
              "type": "string"
            },
            "appServicePlanId": {
              "type": "string"
            },
            "tags": {
              "type": "object",
              "defaultValue": {}
            },
            "enableVNetIntegration": {
              "type": "bool",
              "defaultValue": false
            },
            "vnetIntegrationSubnetId": {
              "type": "string",
              "defaultValue": ""
            },
            "linuxFxVersion": {
              "type": "string",
              "defaultValue": "DOTNET|8.0"
            },
            "alwaysOn": {
              "type": "bool",
              "defaultValue": true
            },
            "httpsOnly": {
              "type": "bool",
              "defaultValue": true
            },
            "minTlsVersion": {
              "type": "string",
              "defaultValue": "1.2"
            },
            "ftpsState": {
              "type": "string",
              "defaultValue": "Disabled"
            }
          },
          "resources": [
            {
              "type": "Microsoft.Web/sites",
              "apiVersion": "2023-01-01",
              "name": "[parameters('webAppName')]",
              "location": "[parameters('location')]",
              "kind": "app",
              "tags": "[parameters('tags')]",
              "identity": {
                "type": "SystemAssigned"
              },
              "properties": {
                "serverFarmId": "[parameters('appServicePlanId')]",
                "siteConfig": {
                  "linuxFxVersion": "[parameters('linuxFxVersion')]",
                  "alwaysOn": "[parameters('alwaysOn')]",
                  "ftpsState": "[parameters('ftpsState')]",
                  "minTlsVersion": "[parameters('minTlsVersion')]"
                },
                "publicNetworkAccess": "Enabled",
                "httpsOnly": "[parameters('httpsOnly')]",
                "virtualNetworkSubnetId": "[if(parameters('enableVNetIntegration'), parameters('vnetIntegrationSubnetId'), null())]"
              }
            }
          ],
          "outputs": {
            "webAppId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Web/sites', parameters('webAppName'))]"
            },
            "webAppName": {
              "type": "string",
              "value": "[parameters('webAppName')]"
            },
            "defaultHostName": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Web/sites', parameters('webAppName')), '2023-01-01').defaultHostName]"
            },
            "principalId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Web/sites', parameters('webAppName')), '2023-01-01', 'full').identity.principalId]"
            },
            "hasPrivateEndpoint": {
              "type": "bool",
              "value": false
            },
            "privateEndpointId": {
              "type": "string",
              "value": ""
            },
            "privateEndpointName": {
              "type": "string",
              "value": ""
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'appServicePlanDeployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'virtualNetworkDeployment')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "adminSiteWebAppDeployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('general').location]"
          },
          "webAppName": {
            "value": "[parameters('webApps').apps.adminSite]"
          },
          "appServicePlanId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'appServicePlanDeployment'), '2022-09-01').outputs.appServicePlanId.value]"
          },
          "createPrivateEndpoint": {
            "value": "[parameters('featureFlags').enablePrivateEndpoints]"
          },
          "privateEndpointSubnetId": "[if(parameters('featureFlags').enablePrivateEndpoints, createObject('value', reference(resourceId('Microsoft.Resources/deployments', 'virtualNetworkDeployment'), '2022-09-01').outputs.privateEndpointSubnetId.value), createObject('value', ''))]",
          "privateDnsZoneId": "[if(parameters('featureFlags').enablePrivateEndpoints, createObject('value', reference(resourceId('Microsoft.Resources/deployments', 'privateDnsZonesDeployment'), '2022-09-01').outputs.appServicePrivateDnsZoneId.value), createObject('value', ''))]",
          "enableVNetIntegration": {
            "value": "[parameters('featureFlags').enableVNetIntegration]"
          },
          "vnetIntegrationSubnetId": "[if(parameters('featureFlags').enableVNetIntegration, createObject('value', reference(resourceId('Microsoft.Resources/deployments', 'virtualNetworkDeployment'), '2022-09-01').outputs.vnetIntegrationSubnetId.value), createObject('value', ''))]",
          "tags": {
            "value": "[variables('commonTags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.37.4.10188",
              "templateHash": "17575558324173140573"
            }
          },
          "parameters": {
            "location": {
              "type": "string"
            },
            "webAppName": {
              "type": "string"
            },
            "appServicePlanId": {
              "type": "string"
            },
            "tags": {
              "type": "object",
              "defaultValue": {}
            },
            "linuxFxVersion": {
              "type": "string",
              "defaultValue": "DOTNET|8.0"
            },
            "alwaysOn": {
              "type": "bool",
              "defaultValue": true
            },
            "httpsOnly": {
              "type": "bool",
              "defaultValue": true
            },
            "minTlsVersion": {
              "type": "string",
              "defaultValue": "1.2"
            },
            "ftpsState": {
              "type": "string",
              "defaultValue": "FtpsOnly"
            },
            "createPrivateEndpoint": {
              "type": "bool",
              "defaultValue": false
            },
            "privateEndpointSubnetId": {
              "type": "string",
              "defaultValue": ""
            },
            "privateDnsZoneId": {
              "type": "string",
              "defaultValue": ""
            },
            "enableVNetIntegration": {
              "type": "bool",
              "defaultValue": false
            },
            "vnetIntegrationSubnetId": {
              "type": "string",
              "defaultValue": ""
            }
          },
          "resources": [
            {
              "type": "Microsoft.Web/sites",
              "apiVersion": "2023-01-01",
              "name": "[parameters('webAppName')]",
              "location": "[parameters('location')]",
              "kind": "app",
              "tags": "[parameters('tags')]",
              "identity": {
                "type": "SystemAssigned"
              },
              "properties": {
                "serverFarmId": "[parameters('appServicePlanId')]",
                "siteConfig": {
                  "linuxFxVersion": "[parameters('linuxFxVersion')]",
                  "alwaysOn": "[parameters('alwaysOn')]",
                  "ftpsState": "[parameters('ftpsState')]",
                  "minTlsVersion": "[parameters('minTlsVersion')]",
                  "ipSecurityRestrictions": [
                    {
                      "ipAddress": "10.0.0.0/8",
                      "action": "Allow",
                      "priority": 100,
                      "name": "AllowPrivateNetworks",
                      "description": "Allow access from private networks only"
                    }
                  ]
                },
                "publicNetworkAccess": "[if(parameters('createPrivateEndpoint'), 'Disabled', 'Enabled')]",
                "httpsOnly": "[parameters('httpsOnly')]",
                "virtualNetworkSubnetId": "[if(parameters('enableVNetIntegration'), parameters('vnetIntegrationSubnetId'), null())]"
              }
            },
            {
              "condition": "[parameters('createPrivateEndpoint')]",
              "type": "Microsoft.Network/privateEndpoints",
              "apiVersion": "2023-09-01",
              "name": "[format('{0}-pe', parameters('webAppName'))]",
              "location": "[parameters('location')]",
              "properties": {
                "subnet": {
                  "id": "[parameters('privateEndpointSubnetId')]"
                },
                "privateLinkServiceConnections": [
                  {
                    "name": "[format('{0}-pe-connection', parameters('webAppName'))]",
                    "properties": {
                      "privateLinkServiceId": "[resourceId('Microsoft.Web/sites', parameters('webAppName'))]",
                      "groupIds": [
                        "sites"
                      ]
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Web/sites', parameters('webAppName'))]"
              ]
            },
            {
              "condition": "[parameters('createPrivateEndpoint')]",
              "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
              "apiVersion": "2023-09-01",
              "name": "[format('{0}/{1}', format('{0}-pe', parameters('webAppName')), format('{0}-pe-dns-group', parameters('webAppName')))]",
              "properties": {
                "privateDnsZoneConfigs": [
                  {
                    "name": "config",
                    "properties": {
                      "privateDnsZoneId": "[parameters('privateDnsZoneId')]"
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/privateEndpoints', format('{0}-pe', parameters('webAppName')))]"
              ]
            }
          ],
          "outputs": {
            "webAppId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Web/sites', parameters('webAppName'))]"
            },
            "webAppName": {
              "type": "string",
              "value": "[parameters('webAppName')]"
            },
            "defaultHostName": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Web/sites', parameters('webAppName')), '2023-01-01').defaultHostName]"
            },
            "principalId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Web/sites', parameters('webAppName')), '2023-01-01', 'full').identity.principalId]"
            },
            "hasPrivateEndpoint": {
              "type": "bool",
              "value": "[parameters('createPrivateEndpoint')]"
            },
            "privateEndpointId": {
              "type": "string",
              "value": "[if(parameters('createPrivateEndpoint'), resourceId('Microsoft.Network/privateEndpoints', format('{0}-pe', parameters('webAppName'))), '')]"
            },
            "privateEndpointName": {
              "type": "string",
              "value": "[if(parameters('createPrivateEndpoint'), format('{0}-pe', parameters('webAppName')), '')]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'appServicePlanDeployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'privateDnsZonesDeployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'virtualNetworkDeployment')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "videoApiWebAppDeployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('general').location]"
          },
          "webAppName": {
            "value": "[parameters('webApps').apps.videoApi]"
          },
          "appServicePlanId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'appServicePlanDeployment'), '2022-09-01').outputs.appServicePlanId.value]"
          },
          "createPrivateEndpoint": {
            "value": "[parameters('featureFlags').enablePrivateEndpoints]"
          },
          "privateEndpointSubnetId": "[if(parameters('featureFlags').enablePrivateEndpoints, createObject('value', reference(resourceId('Microsoft.Resources/deployments', 'virtualNetworkDeployment'), '2022-09-01').outputs.privateEndpointSubnetId.value), createObject('value', ''))]",
          "privateDnsZoneId": "[if(parameters('featureFlags').enablePrivateEndpoints, createObject('value', reference(resourceId('Microsoft.Resources/deployments', 'privateDnsZonesDeployment'), '2022-09-01').outputs.appServicePrivateDnsZoneId.value), createObject('value', ''))]",
          "enableVNetIntegration": {
            "value": "[parameters('featureFlags').enableVNetIntegration]"
          },
          "vnetIntegrationSubnetId": "[if(parameters('featureFlags').enableVNetIntegration, createObject('value', reference(resourceId('Microsoft.Resources/deployments', 'virtualNetworkDeployment'), '2022-09-01').outputs.vnetIntegrationSubnetId.value), createObject('value', ''))]",
          "tags": {
            "value": "[variables('commonTags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.37.4.10188",
              "templateHash": "1552116376066307537"
            }
          },
          "parameters": {
            "location": {
              "type": "string"
            },
            "webAppName": {
              "type": "string"
            },
            "appServicePlanId": {
              "type": "string"
            },
            "tags": {
              "type": "object",
              "defaultValue": {}
            },
            "linuxFxVersion": {
              "type": "string",
              "defaultValue": "DOTNET|8.0"
            },
            "alwaysOn": {
              "type": "bool",
              "defaultValue": true
            },
            "httpsOnly": {
              "type": "bool",
              "defaultValue": true
            },
            "minTlsVersion": {
              "type": "string",
              "defaultValue": "1.2"
            },
            "ftpsState": {
              "type": "string",
              "defaultValue": "Disabled"
            },
            "createPrivateEndpoint": {
              "type": "bool",
              "defaultValue": false
            },
            "privateEndpointSubnetId": {
              "type": "string",
              "defaultValue": ""
            },
            "privateDnsZoneId": {
              "type": "string",
              "defaultValue": ""
            },
            "enableVNetIntegration": {
              "type": "bool",
              "defaultValue": false
            },
            "vnetIntegrationSubnetId": {
              "type": "string",
              "defaultValue": ""
            }
          },
          "resources": [
            {
              "type": "Microsoft.Web/sites",
              "apiVersion": "2023-01-01",
              "name": "[parameters('webAppName')]",
              "location": "[parameters('location')]",
              "kind": "app",
              "tags": "[parameters('tags')]",
              "identity": {
                "type": "SystemAssigned"
              },
              "properties": {
                "serverFarmId": "[parameters('appServicePlanId')]",
                "siteConfig": {
                  "linuxFxVersion": "[parameters('linuxFxVersion')]",
                  "alwaysOn": "[parameters('alwaysOn')]",
                  "ftpsState": "[parameters('ftpsState')]",
                  "minTlsVersion": "[parameters('minTlsVersion')]",
                  "cors": {
                    "allowedOrigins": [
                      "https://*.azurewebsites.net"
                    ],
                    "supportCredentials": false
                  }
                },
                "publicNetworkAccess": "[if(parameters('createPrivateEndpoint'), 'Disabled', 'Enabled')]",
                "httpsOnly": "[parameters('httpsOnly')]",
                "virtualNetworkSubnetId": "[if(parameters('enableVNetIntegration'), parameters('vnetIntegrationSubnetId'), null())]"
              }
            },
            {
              "condition": "[parameters('createPrivateEndpoint')]",
              "type": "Microsoft.Network/privateEndpoints",
              "apiVersion": "2023-09-01",
              "name": "[format('{0}-pe', parameters('webAppName'))]",
              "location": "[parameters('location')]",
              "properties": {
                "subnet": {
                  "id": "[parameters('privateEndpointSubnetId')]"
                },
                "privateLinkServiceConnections": [
                  {
                    "name": "[format('{0}-pe-connection', parameters('webAppName'))]",
                    "properties": {
                      "privateLinkServiceId": "[resourceId('Microsoft.Web/sites', parameters('webAppName'))]",
                      "groupIds": [
                        "sites"
                      ]
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Web/sites', parameters('webAppName'))]"
              ]
            },
            {
              "condition": "[parameters('createPrivateEndpoint')]",
              "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
              "apiVersion": "2023-09-01",
              "name": "[format('{0}/{1}', format('{0}-pe', parameters('webAppName')), format('{0}-pe-dns-group', parameters('webAppName')))]",
              "properties": {
                "privateDnsZoneConfigs": [
                  {
                    "name": "config",
                    "properties": {
                      "privateDnsZoneId": "[parameters('privateDnsZoneId')]"
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/privateEndpoints', format('{0}-pe', parameters('webAppName')))]"
              ]
            }
          ],
          "outputs": {
            "webAppId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Web/sites', parameters('webAppName'))]"
            },
            "webAppName": {
              "type": "string",
              "value": "[parameters('webAppName')]"
            },
            "defaultHostName": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Web/sites', parameters('webAppName')), '2023-01-01').defaultHostName]"
            },
            "principalId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Web/sites', parameters('webAppName')), '2023-01-01', 'full').identity.principalId]"
            },
            "hasPrivateEndpoint": {
              "type": "bool",
              "value": "[parameters('createPrivateEndpoint')]"
            },
            "privateEndpointId": {
              "type": "string",
              "value": "[if(parameters('createPrivateEndpoint'), resourceId('Microsoft.Network/privateEndpoints', format('{0}-pe', parameters('webAppName'))), '')]"
            },
            "privateEndpointName": {
              "type": "string",
              "value": "[if(parameters('createPrivateEndpoint'), format('{0}-pe', parameters('webAppName')), '')]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'appServicePlanDeployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'privateDnsZonesDeployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'virtualNetworkDeployment')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "musicApiWebAppDeployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('general').location]"
          },
          "webAppName": {
            "value": "[parameters('webApps').apps.musicApi]"
          },
          "appServicePlanId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'appServicePlanDeployment'), '2022-09-01').outputs.appServicePlanId.value]"
          },
          "createPrivateEndpoint": {
            "value": "[parameters('featureFlags').enablePrivateEndpoints]"
          },
          "privateEndpointSubnetId": "[if(parameters('featureFlags').enablePrivateEndpoints, createObject('value', reference(resourceId('Microsoft.Resources/deployments', 'virtualNetworkDeployment'), '2022-09-01').outputs.privateEndpointSubnetId.value), createObject('value', ''))]",
          "privateDnsZoneId": "[if(parameters('featureFlags').enablePrivateEndpoints, createObject('value', reference(resourceId('Microsoft.Resources/deployments', 'privateDnsZonesDeployment'), '2022-09-01').outputs.appServicePrivateDnsZoneId.value), createObject('value', ''))]",
          "enableVNetIntegration": {
            "value": "[parameters('featureFlags').enableVNetIntegration]"
          },
          "vnetIntegrationSubnetId": "[if(parameters('featureFlags').enableVNetIntegration, createObject('value', reference(resourceId('Microsoft.Resources/deployments', 'virtualNetworkDeployment'), '2022-09-01').outputs.vnetIntegrationSubnetId.value), createObject('value', ''))]",
          "tags": {
            "value": "[variables('commonTags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.37.4.10188",
              "templateHash": "974247158835693179"
            }
          },
          "parameters": {
            "location": {
              "type": "string"
            },
            "webAppName": {
              "type": "string"
            },
            "appServicePlanId": {
              "type": "string"
            },
            "tags": {
              "type": "object",
              "defaultValue": {}
            },
            "linuxFxVersion": {
              "type": "string",
              "defaultValue": "DOTNET|8.0"
            },
            "alwaysOn": {
              "type": "bool",
              "defaultValue": true
            },
            "httpsOnly": {
              "type": "bool",
              "defaultValue": true
            },
            "minTlsVersion": {
              "type": "string",
              "defaultValue": "1.2"
            },
            "ftpsState": {
              "type": "string",
              "defaultValue": "Disabled"
            },
            "createPrivateEndpoint": {
              "type": "bool",
              "defaultValue": false
            },
            "privateEndpointSubnetId": {
              "type": "string",
              "defaultValue": ""
            },
            "privateDnsZoneId": {
              "type": "string",
              "defaultValue": ""
            },
            "enableVNetIntegration": {
              "type": "bool",
              "defaultValue": false
            },
            "vnetIntegrationSubnetId": {
              "type": "string",
              "defaultValue": ""
            }
          },
          "resources": [
            {
              "type": "Microsoft.Web/sites",
              "apiVersion": "2023-01-01",
              "name": "[parameters('webAppName')]",
              "location": "[parameters('location')]",
              "kind": "app",
              "tags": "[parameters('tags')]",
              "identity": {
                "type": "SystemAssigned"
              },
              "properties": {
                "serverFarmId": "[parameters('appServicePlanId')]",
                "siteConfig": {
                  "linuxFxVersion": "[parameters('linuxFxVersion')]",
                  "alwaysOn": "[parameters('alwaysOn')]",
                  "ftpsState": "[parameters('ftpsState')]",
                  "minTlsVersion": "[parameters('minTlsVersion')]",
                  "cors": {
                    "allowedOrigins": [
                      "https://*.azurewebsites.net"
                    ],
                    "supportCredentials": true
                  }
                },
                "publicNetworkAccess": "[if(parameters('createPrivateEndpoint'), 'Disabled', 'Enabled')]",
                "httpsOnly": "[parameters('httpsOnly')]",
                "virtualNetworkSubnetId": "[if(parameters('enableVNetIntegration'), parameters('vnetIntegrationSubnetId'), null())]"
              }
            },
            {
              "condition": "[parameters('createPrivateEndpoint')]",
              "type": "Microsoft.Network/privateEndpoints",
              "apiVersion": "2023-09-01",
              "name": "[format('{0}-pe', parameters('webAppName'))]",
              "location": "[parameters('location')]",
              "properties": {
                "subnet": {
                  "id": "[parameters('privateEndpointSubnetId')]"
                },
                "privateLinkServiceConnections": [
                  {
                    "name": "[format('{0}-pe-connection', parameters('webAppName'))]",
                    "properties": {
                      "privateLinkServiceId": "[resourceId('Microsoft.Web/sites', parameters('webAppName'))]",
                      "groupIds": [
                        "sites"
                      ]
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Web/sites', parameters('webAppName'))]"
              ]
            },
            {
              "condition": "[parameters('createPrivateEndpoint')]",
              "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
              "apiVersion": "2023-09-01",
              "name": "[format('{0}/{1}', format('{0}-pe', parameters('webAppName')), format('{0}-pe-dns-group', parameters('webAppName')))]",
              "properties": {
                "privateDnsZoneConfigs": [
                  {
                    "name": "config",
                    "properties": {
                      "privateDnsZoneId": "[parameters('privateDnsZoneId')]"
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/privateEndpoints', format('{0}-pe', parameters('webAppName')))]"
              ]
            }
          ],
          "outputs": {
            "webAppId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Web/sites', parameters('webAppName'))]"
            },
            "webAppName": {
              "type": "string",
              "value": "[parameters('webAppName')]"
            },
            "defaultHostName": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Web/sites', parameters('webAppName')), '2023-01-01').defaultHostName]"
            },
            "principalId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Web/sites', parameters('webAppName')), '2023-01-01', 'full').identity.principalId]"
            },
            "hasPrivateEndpoint": {
              "type": "bool",
              "value": "[parameters('createPrivateEndpoint')]"
            },
            "privateEndpointId": {
              "type": "string",
              "value": "[if(parameters('createPrivateEndpoint'), resourceId('Microsoft.Network/privateEndpoints', format('{0}-pe', parameters('webAppName'))), '')]"
            },
            "privateEndpointName": {
              "type": "string",
              "value": "[if(parameters('createPrivateEndpoint'), format('{0}-pe', parameters('webAppName')), '')]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'appServicePlanDeployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'privateDnsZonesDeployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'virtualNetworkDeployment')]"
      ]
    },
    {
      "condition": "[parameters('featureFlags').enableFunctionApps]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "adminFunctionAppDeployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('general').location]"
          },
          "functionAppName": {
            "value": "[parameters('functions').apps.admin]"
          },
          "appServicePlanId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'appServicePlanDeployment'), '2022-09-01').outputs.appServicePlanId.value]"
          },
          "storageAccountName": {
            "value": "[parameters('storage').functionApps.name]"
          },
          "createPrivateEndpoint": {
            "value": "[parameters('featureFlags').enablePrivateEndpoints]"
          },
          "privateEndpointSubnetId": "[if(parameters('featureFlags').enablePrivateEndpoints, createObject('value', reference(resourceId('Microsoft.Resources/deployments', 'virtualNetworkDeployment'), '2022-09-01').outputs.privateEndpointSubnetId.value), createObject('value', ''))]",
          "privateDnsZoneId": "[if(parameters('featureFlags').enablePrivateEndpoints, createObject('value', reference(resourceId('Microsoft.Resources/deployments', 'privateDnsZonesDeployment'), '2022-09-01').outputs.appServicePrivateDnsZoneId.value), createObject('value', ''))]",
          "enableVNetIntegration": {
            "value": "[parameters('featureFlags').enableVNetIntegration]"
          },
          "vnetIntegrationSubnetId": "[if(parameters('featureFlags').enableVNetIntegration, createObject('value', reference(resourceId('Microsoft.Resources/deployments', 'virtualNetworkDeployment'), '2022-09-01').outputs.vnetIntegrationSubnetId.value), createObject('value', ''))]",
          "applicationInsightsConnectionString": "[if(parameters('featureFlags').enableApplicationInsights, createObject('value', reference(resourceId('Microsoft.Resources/deployments', 'applicationInsightsDeployment'), '2022-09-01').outputs.adminAppInsights.value.connectionString), createObject('value', ''))]",
          "tags": {
            "value": "[variables('commonTags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.37.4.10188",
              "templateHash": "11802645371773521418"
            }
          },
          "parameters": {
            "location": {
              "type": "string"
            },
            "functionAppName": {
              "type": "string"
            },
            "appServicePlanId": {
              "type": "string"
            },
            "storageAccountName": {
              "type": "string"
            },
            "createPrivateEndpoint": {
              "type": "bool"
            },
            "privateEndpointSubnetId": {
              "type": "string"
            },
            "privateDnsZoneId": {
              "type": "string"
            },
            "enableVNetIntegration": {
              "type": "bool"
            },
            "vnetIntegrationSubnetId": {
              "type": "string"
            },
            "linuxFxVersion": {
              "type": "string",
              "defaultValue": "DOTNET-ISOLATED|8.0"
            },
            "alwaysOn": {
              "type": "bool",
              "defaultValue": true
            },
            "applicationInsightsConnectionString": {
              "type": "string"
            },
            "additionalAppSettings": {
              "type": "object",
              "defaultValue": {}
            },
            "tags": {
              "type": "object"
            }
          },
          "resources": [
            {
              "type": "Microsoft.Web/sites/config",
              "apiVersion": "2024-04-01",
              "name": "[format('{0}/{1}', parameters('functionAppName'), 'appsettings')]",
              "properties": "[union(createObject('APPLICATIONINSIGHTS_AUTHENTICATION_STRING', 'Authorization=AAD', 'APPLICATIONINSIGHTS_CONNECTION_STRING', parameters('applicationInsightsConnectionString'), 'AzureWebJobsStorage__credential', 'managedidentity', 'AzureWebJobsStorage__blobServiceUri', format('https://{0}.blob.{1}', parameters('storageAccountName'), environment().suffixes.storage), 'AzureWebJobsStorage__queueServiceUri', format('https://{0}.queue.{1}', parameters('storageAccountName'), environment().suffixes.storage), 'AzureWebJobsStorage__tableServiceUri', format('https://{0}.table.{1}', parameters('storageAccountName'), environment().suffixes.storage), 'FUNCTIONS_EXTENSION_VERSION', '~4', 'FUNCTIONS_WORKER_RUNTIME', 'dotnet-isolated', 'WEBSITE_USE_PLACEHOLDER_DOTNETISOLATED', '1'), parameters('additionalAppSettings'))]",
              "dependsOn": [
                "[resourceId('Microsoft.Web/sites', parameters('functionAppName'))]"
              ]
            },
            {
              "type": "Microsoft.Web/sites",
              "apiVersion": "2024-04-01",
              "name": "[parameters('functionAppName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "kind": "functionapp,linux",
              "identity": {
                "type": "SystemAssigned"
              },
              "properties": {
                "serverFarmId": "[parameters('appServicePlanId')]",
                "httpsOnly": true,
                "publicNetworkAccess": "[if(parameters('createPrivateEndpoint'), 'Disabled', 'Enabled')]",
                "reserved": true,
                "siteConfig": {
                  "minTlsVersion": "1.2",
                  "use32BitWorkerProcess": false,
                  "ftpsState": "FtpsOnly",
                  "alwaysOn": "[parameters('alwaysOn')]",
                  "linuxFxVersion": "[parameters('linuxFxVersion')]"
                }
              }
            },
            {
              "condition": "[parameters('createPrivateEndpoint')]",
              "type": "Microsoft.Network/privateEndpoints",
              "apiVersion": "2023-09-01",
              "name": "[format('{0}-pe', parameters('functionAppName'))]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "subnet": {
                  "id": "[parameters('privateEndpointSubnetId')]"
                },
                "privateLinkServiceConnections": [
                  {
                    "name": "[format('{0}-pe-connection', parameters('functionAppName'))]",
                    "properties": {
                      "privateLinkServiceId": "[resourceId('Microsoft.Web/sites', parameters('functionAppName'))]",
                      "groupIds": [
                        "sites"
                      ]
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Web/sites', parameters('functionAppName'))]"
              ]
            },
            {
              "condition": "[parameters('createPrivateEndpoint')]",
              "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
              "apiVersion": "2023-09-01",
              "name": "[format('{0}/{1}', format('{0}-pe', parameters('functionAppName')), format('{0}-pe-dns-group', parameters('functionAppName')))]",
              "properties": {
                "privateDnsZoneConfigs": [
                  {
                    "name": "privatelink-azurewebsites-net",
                    "properties": {
                      "privateDnsZoneId": "[parameters('privateDnsZoneId')]"
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/privateEndpoints', format('{0}-pe', parameters('functionAppName')))]"
              ]
            },
            {
              "condition": "[parameters('enableVNetIntegration')]",
              "type": "Microsoft.Web/sites/networkConfig",
              "apiVersion": "2022-03-01",
              "name": "[format('{0}/{1}', parameters('functionAppName'), 'virtualNetwork')]",
              "properties": {
                "subnetResourceId": "[parameters('vnetIntegrationSubnetId')]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Web/sites', parameters('functionAppName'))]"
              ]
            }
          ],
          "outputs": {
            "functionAppId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Web/sites', parameters('functionAppName'))]"
            },
            "functionAppName": {
              "type": "string",
              "value": "[parameters('functionAppName')]"
            },
            "principalId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Web/sites', parameters('functionAppName')), '2024-04-01', 'full').identity.principalId]"
            },
            "defaultHostName": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Web/sites', parameters('functionAppName')), '2024-04-01').defaultHostName]"
            },
            "hasPrivateEndpoint": {
              "type": "bool",
              "value": "[parameters('createPrivateEndpoint')]"
            },
            "privateEndpointId": {
              "type": "string",
              "value": "[if(parameters('createPrivateEndpoint'), resourceId('Microsoft.Network/privateEndpoints', format('{0}-pe', parameters('functionAppName'))), '')]"
            },
            "privateEndpointName": {
              "type": "string",
              "value": "[if(parameters('createPrivateEndpoint'), format('{0}-pe', parameters('functionAppName')), '')]"
            },
            "functionAppUrl": {
              "type": "string",
              "value": "[format('https://{0}', reference(resourceId('Microsoft.Web/sites', parameters('functionAppName')), '2024-04-01').defaultHostName)]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'applicationInsightsDeployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'appServicePlanDeployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'privateDnsZonesDeployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'virtualNetworkDeployment')]"
      ]
    },
    {
      "condition": "[parameters('featureFlags').enableFunctionApps]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "customerFunctionAppDeployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('general').location]"
          },
          "functionAppName": {
            "value": "[parameters('functions').apps.customer]"
          },
          "appServicePlanId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'appServicePlanDeployment'), '2022-09-01').outputs.appServicePlanId.value]"
          },
          "storageAccountName": {
            "value": "[parameters('storage').functionApps.name]"
          },
          "createPrivateEndpoint": {
            "value": "[parameters('featureFlags').enablePrivateEndpoints]"
          },
          "privateEndpointSubnetId": "[if(parameters('featureFlags').enablePrivateEndpoints, createObject('value', reference(resourceId('Microsoft.Resources/deployments', 'virtualNetworkDeployment'), '2022-09-01').outputs.privateEndpointSubnetId.value), createObject('value', ''))]",
          "privateDnsZoneId": "[if(parameters('featureFlags').enablePrivateEndpoints, createObject('value', reference(resourceId('Microsoft.Resources/deployments', 'privateDnsZonesDeployment'), '2022-09-01').outputs.appServicePrivateDnsZoneId.value), createObject('value', ''))]",
          "enableVNetIntegration": {
            "value": "[parameters('featureFlags').enableVNetIntegration]"
          },
          "vnetIntegrationSubnetId": "[if(parameters('featureFlags').enableVNetIntegration, createObject('value', reference(resourceId('Microsoft.Resources/deployments', 'virtualNetworkDeployment'), '2022-09-01').outputs.vnetIntegrationSubnetId.value), createObject('value', ''))]",
          "applicationInsightsConnectionString": "[if(parameters('featureFlags').enableApplicationInsights, createObject('value', reference(resourceId('Microsoft.Resources/deployments', 'applicationInsightsDeployment'), '2022-09-01').outputs.customerAppInsights.value.connectionString), createObject('value', ''))]",
          "tags": {
            "value": "[variables('commonTags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.37.4.10188",
              "templateHash": "11802645371773521418"
            }
          },
          "parameters": {
            "location": {
              "type": "string"
            },
            "functionAppName": {
              "type": "string"
            },
            "appServicePlanId": {
              "type": "string"
            },
            "storageAccountName": {
              "type": "string"
            },
            "createPrivateEndpoint": {
              "type": "bool"
            },
            "privateEndpointSubnetId": {
              "type": "string"
            },
            "privateDnsZoneId": {
              "type": "string"
            },
            "enableVNetIntegration": {
              "type": "bool"
            },
            "vnetIntegrationSubnetId": {
              "type": "string"
            },
            "linuxFxVersion": {
              "type": "string",
              "defaultValue": "DOTNET-ISOLATED|8.0"
            },
            "alwaysOn": {
              "type": "bool",
              "defaultValue": true
            },
            "applicationInsightsConnectionString": {
              "type": "string"
            },
            "additionalAppSettings": {
              "type": "object",
              "defaultValue": {}
            },
            "tags": {
              "type": "object"
            }
          },
          "resources": [
            {
              "type": "Microsoft.Web/sites/config",
              "apiVersion": "2024-04-01",
              "name": "[format('{0}/{1}', parameters('functionAppName'), 'appsettings')]",
              "properties": "[union(createObject('APPLICATIONINSIGHTS_AUTHENTICATION_STRING', 'Authorization=AAD', 'APPLICATIONINSIGHTS_CONNECTION_STRING', parameters('applicationInsightsConnectionString'), 'AzureWebJobsStorage__credential', 'managedidentity', 'AzureWebJobsStorage__blobServiceUri', format('https://{0}.blob.{1}', parameters('storageAccountName'), environment().suffixes.storage), 'AzureWebJobsStorage__queueServiceUri', format('https://{0}.queue.{1}', parameters('storageAccountName'), environment().suffixes.storage), 'AzureWebJobsStorage__tableServiceUri', format('https://{0}.table.{1}', parameters('storageAccountName'), environment().suffixes.storage), 'FUNCTIONS_EXTENSION_VERSION', '~4', 'FUNCTIONS_WORKER_RUNTIME', 'dotnet-isolated', 'WEBSITE_USE_PLACEHOLDER_DOTNETISOLATED', '1'), parameters('additionalAppSettings'))]",
              "dependsOn": [
                "[resourceId('Microsoft.Web/sites', parameters('functionAppName'))]"
              ]
            },
            {
              "type": "Microsoft.Web/sites",
              "apiVersion": "2024-04-01",
              "name": "[parameters('functionAppName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "kind": "functionapp,linux",
              "identity": {
                "type": "SystemAssigned"
              },
              "properties": {
                "serverFarmId": "[parameters('appServicePlanId')]",
                "httpsOnly": true,
                "publicNetworkAccess": "[if(parameters('createPrivateEndpoint'), 'Disabled', 'Enabled')]",
                "reserved": true,
                "siteConfig": {
                  "minTlsVersion": "1.2",
                  "use32BitWorkerProcess": false,
                  "ftpsState": "FtpsOnly",
                  "alwaysOn": "[parameters('alwaysOn')]",
                  "linuxFxVersion": "[parameters('linuxFxVersion')]"
                }
              }
            },
            {
              "condition": "[parameters('createPrivateEndpoint')]",
              "type": "Microsoft.Network/privateEndpoints",
              "apiVersion": "2023-09-01",
              "name": "[format('{0}-pe', parameters('functionAppName'))]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "subnet": {
                  "id": "[parameters('privateEndpointSubnetId')]"
                },
                "privateLinkServiceConnections": [
                  {
                    "name": "[format('{0}-pe-connection', parameters('functionAppName'))]",
                    "properties": {
                      "privateLinkServiceId": "[resourceId('Microsoft.Web/sites', parameters('functionAppName'))]",
                      "groupIds": [
                        "sites"
                      ]
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Web/sites', parameters('functionAppName'))]"
              ]
            },
            {
              "condition": "[parameters('createPrivateEndpoint')]",
              "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
              "apiVersion": "2023-09-01",
              "name": "[format('{0}/{1}', format('{0}-pe', parameters('functionAppName')), format('{0}-pe-dns-group', parameters('functionAppName')))]",
              "properties": {
                "privateDnsZoneConfigs": [
                  {
                    "name": "privatelink-azurewebsites-net",
                    "properties": {
                      "privateDnsZoneId": "[parameters('privateDnsZoneId')]"
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/privateEndpoints', format('{0}-pe', parameters('functionAppName')))]"
              ]
            },
            {
              "condition": "[parameters('enableVNetIntegration')]",
              "type": "Microsoft.Web/sites/networkConfig",
              "apiVersion": "2022-03-01",
              "name": "[format('{0}/{1}', parameters('functionAppName'), 'virtualNetwork')]",
              "properties": {
                "subnetResourceId": "[parameters('vnetIntegrationSubnetId')]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Web/sites', parameters('functionAppName'))]"
              ]
            }
          ],
          "outputs": {
            "functionAppId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Web/sites', parameters('functionAppName'))]"
            },
            "functionAppName": {
              "type": "string",
              "value": "[parameters('functionAppName')]"
            },
            "principalId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Web/sites', parameters('functionAppName')), '2024-04-01', 'full').identity.principalId]"
            },
            "defaultHostName": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Web/sites', parameters('functionAppName')), '2024-04-01').defaultHostName]"
            },
            "hasPrivateEndpoint": {
              "type": "bool",
              "value": "[parameters('createPrivateEndpoint')]"
            },
            "privateEndpointId": {
              "type": "string",
              "value": "[if(parameters('createPrivateEndpoint'), resourceId('Microsoft.Network/privateEndpoints', format('{0}-pe', parameters('functionAppName'))), '')]"
            },
            "privateEndpointName": {
              "type": "string",
              "value": "[if(parameters('createPrivateEndpoint'), format('{0}-pe', parameters('functionAppName')), '')]"
            },
            "functionAppUrl": {
              "type": "string",
              "value": "[format('https://{0}', reference(resourceId('Microsoft.Web/sites', parameters('functionAppName')), '2024-04-01').defaultHostName)]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'applicationInsightsDeployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'appServicePlanDeployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'privateDnsZonesDeployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'virtualNetworkDeployment')]"
      ]
    },
    {
      "condition": "[parameters('featureFlags').enableFunctionApps]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "musicFunctionAppDeployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('general').location]"
          },
          "functionAppName": {
            "value": "[parameters('functions').apps.music]"
          },
          "appServicePlanId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'appServicePlanDeployment'), '2022-09-01').outputs.appServicePlanId.value]"
          },
          "storageAccountName": {
            "value": "[parameters('storage').functionApps.name]"
          },
          "createPrivateEndpoint": {
            "value": "[parameters('featureFlags').enablePrivateEndpoints]"
          },
          "privateEndpointSubnetId": "[if(parameters('featureFlags').enablePrivateEndpoints, createObject('value', reference(resourceId('Microsoft.Resources/deployments', 'virtualNetworkDeployment'), '2022-09-01').outputs.privateEndpointSubnetId.value), createObject('value', ''))]",
          "privateDnsZoneId": "[if(parameters('featureFlags').enablePrivateEndpoints, createObject('value', reference(resourceId('Microsoft.Resources/deployments', 'privateDnsZonesDeployment'), '2022-09-01').outputs.appServicePrivateDnsZoneId.value), createObject('value', ''))]",
          "enableVNetIntegration": {
            "value": "[parameters('featureFlags').enableVNetIntegration]"
          },
          "vnetIntegrationSubnetId": "[if(parameters('featureFlags').enableVNetIntegration, createObject('value', reference(resourceId('Microsoft.Resources/deployments', 'virtualNetworkDeployment'), '2022-09-01').outputs.vnetIntegrationSubnetId.value), createObject('value', ''))]",
          "applicationInsightsConnectionString": "[if(parameters('featureFlags').enableApplicationInsights, createObject('value', reference(resourceId('Microsoft.Resources/deployments', 'applicationInsightsDeployment'), '2022-09-01').outputs.musicAppInsights.value.connectionString), createObject('value', ''))]",
          "tags": {
            "value": "[variables('commonTags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.37.4.10188",
              "templateHash": "11802645371773521418"
            }
          },
          "parameters": {
            "location": {
              "type": "string"
            },
            "functionAppName": {
              "type": "string"
            },
            "appServicePlanId": {
              "type": "string"
            },
            "storageAccountName": {
              "type": "string"
            },
            "createPrivateEndpoint": {
              "type": "bool"
            },
            "privateEndpointSubnetId": {
              "type": "string"
            },
            "privateDnsZoneId": {
              "type": "string"
            },
            "enableVNetIntegration": {
              "type": "bool"
            },
            "vnetIntegrationSubnetId": {
              "type": "string"
            },
            "linuxFxVersion": {
              "type": "string",
              "defaultValue": "DOTNET-ISOLATED|8.0"
            },
            "alwaysOn": {
              "type": "bool",
              "defaultValue": true
            },
            "applicationInsightsConnectionString": {
              "type": "string"
            },
            "additionalAppSettings": {
              "type": "object",
              "defaultValue": {}
            },
            "tags": {
              "type": "object"
            }
          },
          "resources": [
            {
              "type": "Microsoft.Web/sites/config",
              "apiVersion": "2024-04-01",
              "name": "[format('{0}/{1}', parameters('functionAppName'), 'appsettings')]",
              "properties": "[union(createObject('APPLICATIONINSIGHTS_AUTHENTICATION_STRING', 'Authorization=AAD', 'APPLICATIONINSIGHTS_CONNECTION_STRING', parameters('applicationInsightsConnectionString'), 'AzureWebJobsStorage__credential', 'managedidentity', 'AzureWebJobsStorage__blobServiceUri', format('https://{0}.blob.{1}', parameters('storageAccountName'), environment().suffixes.storage), 'AzureWebJobsStorage__queueServiceUri', format('https://{0}.queue.{1}', parameters('storageAccountName'), environment().suffixes.storage), 'AzureWebJobsStorage__tableServiceUri', format('https://{0}.table.{1}', parameters('storageAccountName'), environment().suffixes.storage), 'FUNCTIONS_EXTENSION_VERSION', '~4', 'FUNCTIONS_WORKER_RUNTIME', 'dotnet-isolated', 'WEBSITE_USE_PLACEHOLDER_DOTNETISOLATED', '1'), parameters('additionalAppSettings'))]",
              "dependsOn": [
                "[resourceId('Microsoft.Web/sites', parameters('functionAppName'))]"
              ]
            },
            {
              "type": "Microsoft.Web/sites",
              "apiVersion": "2024-04-01",
              "name": "[parameters('functionAppName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "kind": "functionapp,linux",
              "identity": {
                "type": "SystemAssigned"
              },
              "properties": {
                "serverFarmId": "[parameters('appServicePlanId')]",
                "httpsOnly": true,
                "publicNetworkAccess": "[if(parameters('createPrivateEndpoint'), 'Disabled', 'Enabled')]",
                "reserved": true,
                "siteConfig": {
                  "minTlsVersion": "1.2",
                  "use32BitWorkerProcess": false,
                  "ftpsState": "FtpsOnly",
                  "alwaysOn": "[parameters('alwaysOn')]",
                  "linuxFxVersion": "[parameters('linuxFxVersion')]"
                }
              }
            },
            {
              "condition": "[parameters('createPrivateEndpoint')]",
              "type": "Microsoft.Network/privateEndpoints",
              "apiVersion": "2023-09-01",
              "name": "[format('{0}-pe', parameters('functionAppName'))]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "subnet": {
                  "id": "[parameters('privateEndpointSubnetId')]"
                },
                "privateLinkServiceConnections": [
                  {
                    "name": "[format('{0}-pe-connection', parameters('functionAppName'))]",
                    "properties": {
                      "privateLinkServiceId": "[resourceId('Microsoft.Web/sites', parameters('functionAppName'))]",
                      "groupIds": [
                        "sites"
                      ]
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Web/sites', parameters('functionAppName'))]"
              ]
            },
            {
              "condition": "[parameters('createPrivateEndpoint')]",
              "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
              "apiVersion": "2023-09-01",
              "name": "[format('{0}/{1}', format('{0}-pe', parameters('functionAppName')), format('{0}-pe-dns-group', parameters('functionAppName')))]",
              "properties": {
                "privateDnsZoneConfigs": [
                  {
                    "name": "privatelink-azurewebsites-net",
                    "properties": {
                      "privateDnsZoneId": "[parameters('privateDnsZoneId')]"
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/privateEndpoints', format('{0}-pe', parameters('functionAppName')))]"
              ]
            },
            {
              "condition": "[parameters('enableVNetIntegration')]",
              "type": "Microsoft.Web/sites/networkConfig",
              "apiVersion": "2022-03-01",
              "name": "[format('{0}/{1}', parameters('functionAppName'), 'virtualNetwork')]",
              "properties": {
                "subnetResourceId": "[parameters('vnetIntegrationSubnetId')]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Web/sites', parameters('functionAppName'))]"
              ]
            }
          ],
          "outputs": {
            "functionAppId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Web/sites', parameters('functionAppName'))]"
            },
            "functionAppName": {
              "type": "string",
              "value": "[parameters('functionAppName')]"
            },
            "principalId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Web/sites', parameters('functionAppName')), '2024-04-01', 'full').identity.principalId]"
            },
            "defaultHostName": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Web/sites', parameters('functionAppName')), '2024-04-01').defaultHostName]"
            },
            "hasPrivateEndpoint": {
              "type": "bool",
              "value": "[parameters('createPrivateEndpoint')]"
            },
            "privateEndpointId": {
              "type": "string",
              "value": "[if(parameters('createPrivateEndpoint'), resourceId('Microsoft.Network/privateEndpoints', format('{0}-pe', parameters('functionAppName'))), '')]"
            },
            "privateEndpointName": {
              "type": "string",
              "value": "[if(parameters('createPrivateEndpoint'), format('{0}-pe', parameters('functionAppName')), '')]"
            },
            "functionAppUrl": {
              "type": "string",
              "value": "[format('https://{0}', reference(resourceId('Microsoft.Web/sites', parameters('functionAppName')), '2024-04-01').defaultHostName)]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'applicationInsightsDeployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'appServicePlanDeployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'privateDnsZonesDeployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'virtualNetworkDeployment')]"
      ]
    },
    {
      "condition": "[parameters('featureFlags').enableFunctionApps]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "videoFunctionAppDeployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('general').location]"
          },
          "functionAppName": {
            "value": "[parameters('functions').apps.video]"
          },
          "appServicePlanId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'appServicePlanDeployment'), '2022-09-01').outputs.appServicePlanId.value]"
          },
          "storageAccountName": {
            "value": "[parameters('storage').functionApps.name]"
          },
          "createPrivateEndpoint": {
            "value": "[parameters('featureFlags').enablePrivateEndpoints]"
          },
          "privateEndpointSubnetId": "[if(parameters('featureFlags').enablePrivateEndpoints, createObject('value', reference(resourceId('Microsoft.Resources/deployments', 'virtualNetworkDeployment'), '2022-09-01').outputs.privateEndpointSubnetId.value), createObject('value', ''))]",
          "privateDnsZoneId": "[if(parameters('featureFlags').enablePrivateEndpoints, createObject('value', reference(resourceId('Microsoft.Resources/deployments', 'privateDnsZonesDeployment'), '2022-09-01').outputs.appServicePrivateDnsZoneId.value), createObject('value', ''))]",
          "enableVNetIntegration": {
            "value": "[parameters('featureFlags').enableVNetIntegration]"
          },
          "vnetIntegrationSubnetId": "[if(parameters('featureFlags').enableVNetIntegration, createObject('value', reference(resourceId('Microsoft.Resources/deployments', 'virtualNetworkDeployment'), '2022-09-01').outputs.vnetIntegrationSubnetId.value), createObject('value', ''))]",
          "applicationInsightsConnectionString": "[if(parameters('featureFlags').enableApplicationInsights, createObject('value', reference(resourceId('Microsoft.Resources/deployments', 'applicationInsightsDeployment'), '2022-09-01').outputs.videoAppInsights.value.connectionString), createObject('value', ''))]",
          "tags": {
            "value": "[variables('commonTags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.37.4.10188",
              "templateHash": "11802645371773521418"
            }
          },
          "parameters": {
            "location": {
              "type": "string"
            },
            "functionAppName": {
              "type": "string"
            },
            "appServicePlanId": {
              "type": "string"
            },
            "storageAccountName": {
              "type": "string"
            },
            "createPrivateEndpoint": {
              "type": "bool"
            },
            "privateEndpointSubnetId": {
              "type": "string"
            },
            "privateDnsZoneId": {
              "type": "string"
            },
            "enableVNetIntegration": {
              "type": "bool"
            },
            "vnetIntegrationSubnetId": {
              "type": "string"
            },
            "linuxFxVersion": {
              "type": "string",
              "defaultValue": "DOTNET-ISOLATED|8.0"
            },
            "alwaysOn": {
              "type": "bool",
              "defaultValue": true
            },
            "applicationInsightsConnectionString": {
              "type": "string"
            },
            "additionalAppSettings": {
              "type": "object",
              "defaultValue": {}
            },
            "tags": {
              "type": "object"
            }
          },
          "resources": [
            {
              "type": "Microsoft.Web/sites/config",
              "apiVersion": "2024-04-01",
              "name": "[format('{0}/{1}', parameters('functionAppName'), 'appsettings')]",
              "properties": "[union(createObject('APPLICATIONINSIGHTS_AUTHENTICATION_STRING', 'Authorization=AAD', 'APPLICATIONINSIGHTS_CONNECTION_STRING', parameters('applicationInsightsConnectionString'), 'AzureWebJobsStorage__credential', 'managedidentity', 'AzureWebJobsStorage__blobServiceUri', format('https://{0}.blob.{1}', parameters('storageAccountName'), environment().suffixes.storage), 'AzureWebJobsStorage__queueServiceUri', format('https://{0}.queue.{1}', parameters('storageAccountName'), environment().suffixes.storage), 'AzureWebJobsStorage__tableServiceUri', format('https://{0}.table.{1}', parameters('storageAccountName'), environment().suffixes.storage), 'FUNCTIONS_EXTENSION_VERSION', '~4', 'FUNCTIONS_WORKER_RUNTIME', 'dotnet-isolated', 'WEBSITE_USE_PLACEHOLDER_DOTNETISOLATED', '1'), parameters('additionalAppSettings'))]",
              "dependsOn": [
                "[resourceId('Microsoft.Web/sites', parameters('functionAppName'))]"
              ]
            },
            {
              "type": "Microsoft.Web/sites",
              "apiVersion": "2024-04-01",
              "name": "[parameters('functionAppName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "kind": "functionapp,linux",
              "identity": {
                "type": "SystemAssigned"
              },
              "properties": {
                "serverFarmId": "[parameters('appServicePlanId')]",
                "httpsOnly": true,
                "publicNetworkAccess": "[if(parameters('createPrivateEndpoint'), 'Disabled', 'Enabled')]",
                "reserved": true,
                "siteConfig": {
                  "minTlsVersion": "1.2",
                  "use32BitWorkerProcess": false,
                  "ftpsState": "FtpsOnly",
                  "alwaysOn": "[parameters('alwaysOn')]",
                  "linuxFxVersion": "[parameters('linuxFxVersion')]"
                }
              }
            },
            {
              "condition": "[parameters('createPrivateEndpoint')]",
              "type": "Microsoft.Network/privateEndpoints",
              "apiVersion": "2023-09-01",
              "name": "[format('{0}-pe', parameters('functionAppName'))]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "subnet": {
                  "id": "[parameters('privateEndpointSubnetId')]"
                },
                "privateLinkServiceConnections": [
                  {
                    "name": "[format('{0}-pe-connection', parameters('functionAppName'))]",
                    "properties": {
                      "privateLinkServiceId": "[resourceId('Microsoft.Web/sites', parameters('functionAppName'))]",
                      "groupIds": [
                        "sites"
                      ]
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Web/sites', parameters('functionAppName'))]"
              ]
            },
            {
              "condition": "[parameters('createPrivateEndpoint')]",
              "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
              "apiVersion": "2023-09-01",
              "name": "[format('{0}/{1}', format('{0}-pe', parameters('functionAppName')), format('{0}-pe-dns-group', parameters('functionAppName')))]",
              "properties": {
                "privateDnsZoneConfigs": [
                  {
                    "name": "privatelink-azurewebsites-net",
                    "properties": {
                      "privateDnsZoneId": "[parameters('privateDnsZoneId')]"
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/privateEndpoints', format('{0}-pe', parameters('functionAppName')))]"
              ]
            },
            {
              "condition": "[parameters('enableVNetIntegration')]",
              "type": "Microsoft.Web/sites/networkConfig",
              "apiVersion": "2022-03-01",
              "name": "[format('{0}/{1}', parameters('functionAppName'), 'virtualNetwork')]",
              "properties": {
                "subnetResourceId": "[parameters('vnetIntegrationSubnetId')]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Web/sites', parameters('functionAppName'))]"
              ]
            }
          ],
          "outputs": {
            "functionAppId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Web/sites', parameters('functionAppName'))]"
            },
            "functionAppName": {
              "type": "string",
              "value": "[parameters('functionAppName')]"
            },
            "principalId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Web/sites', parameters('functionAppName')), '2024-04-01', 'full').identity.principalId]"
            },
            "defaultHostName": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Web/sites', parameters('functionAppName')), '2024-04-01').defaultHostName]"
            },
            "hasPrivateEndpoint": {
              "type": "bool",
              "value": "[parameters('createPrivateEndpoint')]"
            },
            "privateEndpointId": {
              "type": "string",
              "value": "[if(parameters('createPrivateEndpoint'), resourceId('Microsoft.Network/privateEndpoints', format('{0}-pe', parameters('functionAppName'))), '')]"
            },
            "privateEndpointName": {
              "type": "string",
              "value": "[if(parameters('createPrivateEndpoint'), format('{0}-pe', parameters('functionAppName')), '')]"
            },
            "functionAppUrl": {
              "type": "string",
              "value": "[format('https://{0}', reference(resourceId('Microsoft.Web/sites', parameters('functionAppName')), '2024-04-01').defaultHostName)]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'applicationInsightsDeployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'appServicePlanDeployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'privateDnsZonesDeployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'virtualNetworkDeployment')]"
      ]
    },
    {
      "condition": "[parameters('featureFlags').enableFunctionApps]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "functionAppsStorageDeployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('general').location]"
          },
          "storageAccountName": {
            "value": "[parameters('storage').functionApps.name]"
          },
          "storageAccountType": {
            "value": "[parameters('storage').functionApps.type]"
          },
          "accessTier": {
            "value": "Hot"
          },
          "allowBlobPublicAccess": {
            "value": "[not(parameters('featureFlags').enablePrivateEndpoints)]"
          },
          "minimumTlsVersion": {
            "value": "TLS1_2"
          },
          "createPrivateEndpoint": {
            "value": "[parameters('featureFlags').enablePrivateEndpoints]"
          },
          "privateEndpointSubnetId": "[if(parameters('featureFlags').enablePrivateEndpoints, createObject('value', reference(resourceId('Microsoft.Resources/deployments', 'virtualNetworkDeployment'), '2022-09-01').outputs.privateEndpointSubnetId.value), createObject('value', ''))]",
          "privateDnsZoneIds": {
            "value": {
              "blob": "[if(and(parameters('featureFlags').enablePrivateEndpoints, parameters('featureFlags').enableFunctionApps), reference(resourceId('Microsoft.Resources/deployments', 'privateDnsZonesDeployment'), '2022-09-01').outputs.blobStoragePrivateDnsZoneId.value, '')]",
              "file": "",
              "queue": "",
              "table": ""
            }
          },
          "allowedIpRanges": {
            "value": []
          },
          "bypassAzureServices": {
            "value": true
          },
          "allowedSubnetIds": "[if(parameters('featureFlags').enableVNetIntegration, createObject('value', createArray(reference(resourceId('Microsoft.Resources/deployments', 'virtualNetworkDeployment'), '2022-09-01').outputs.vnetIntegrationSubnetId.value)), createObject('value', createArray()))]",
          "roleAssignments": {
            "value": []
          },
          "tags": {
            "value": "[union(variables('commonTags'), createObject('Purpose', 'FunctionAppsRuntimeStorage'))]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.37.4.10188",
              "templateHash": "10314731652381209871"
            }
          },
          "parameters": {
            "location": {
              "type": "string"
            },
            "storageAccountName": {
              "type": "string"
            },
            "storageAccountType": {
              "type": "string"
            },
            "accessTier": {
              "type": "string"
            },
            "allowBlobPublicAccess": {
              "type": "bool"
            },
            "minimumTlsVersion": {
              "type": "string"
            },
            "createPrivateEndpoint": {
              "type": "bool"
            },
            "privateEndpointSubnetId": {
              "type": "string"
            },
            "privateDnsZoneIds": {
              "type": "object",
              "defaultValue": {
                "blob": "",
                "file": "",
                "queue": "",
                "table": ""
              }
            },
            "allowedIpRanges": {
              "type": "array"
            },
            "bypassAzureServices": {
              "type": "bool"
            },
            "allowedSubnetIds": {
              "type": "array"
            },
            "tags": {
              "type": "object"
            },
            "roleAssignments": {
              "type": "array"
            }
          },
          "variables": {
            "functionContainers": [
              "azure-webjobs-hosts",
              "azure-webjobs-secrets",
              "scm-releases",
              "deployments"
            ],
            "storageServices": [
              {
                "name": "blob",
                "dnsZoneId": "[parameters('privateDnsZoneIds').blob]"
              },
              {
                "name": "file",
                "dnsZoneId": "[parameters('privateDnsZoneIds').file]"
              },
              {
                "name": "queue",
                "dnsZoneId": "[parameters('privateDnsZoneIds').queue]"
              },
              {
                "name": "table",
                "dnsZoneId": "[parameters('privateDnsZoneIds').table]"
              }
            ]
          },
          "resources": [
            {
              "type": "Microsoft.Storage/storageAccounts",
              "apiVersion": "2023-01-01",
              "name": "[parameters('storageAccountName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "sku": {
                "name": "[parameters('storageAccountType')]"
              },
              "kind": "StorageV2",
              "identity": {
                "type": "SystemAssigned"
              },
              "properties": {
                "accessTier": "[parameters('accessTier')]",
                "allowBlobPublicAccess": "[parameters('allowBlobPublicAccess')]",
                "allowSharedKeyAccess": true,
                "defaultToOAuthAuthentication": false,
                "minimumTlsVersion": "[parameters('minimumTlsVersion')]",
                "supportsHttpsTrafficOnly": true,
                "publicNetworkAccess": "[if(parameters('createPrivateEndpoint'), 'Disabled', 'Enabled')]",
                "networkAcls": {
                  "copy": [
                    {
                      "name": "ipRules",
                      "count": "[length(parameters('allowedIpRanges'))]",
                      "input": {
                        "value": "[parameters('allowedIpRanges')[copyIndex('ipRules')]]",
                        "action": "Allow"
                      }
                    },
                    {
                      "name": "virtualNetworkRules",
                      "count": "[length(parameters('allowedSubnetIds'))]",
                      "input": {
                        "id": "[parameters('allowedSubnetIds')[copyIndex('virtualNetworkRules')]]",
                        "action": "Allow"
                      }
                    }
                  ],
                  "bypass": "[if(parameters('bypassAzureServices'), 'AzureServices', 'None')]",
                  "defaultAction": "[if(or(greater(length(parameters('allowedIpRanges')), 0), greater(length(parameters('allowedSubnetIds')), 0)), 'Deny', 'Allow')]"
                }
              }
            },
            {
              "type": "Microsoft.Storage/storageAccounts/blobServices",
              "apiVersion": "2023-01-01",
              "name": "[format('{0}/{1}', parameters('storageAccountName'), 'default')]",
              "properties": {
                "cors": {
                  "corsRules": [
                    {
                      "allowedOrigins": [
                        "*"
                      ],
                      "allowedMethods": [
                        "GET",
                        "POST",
                        "PUT",
                        "DELETE",
                        "HEAD",
                        "OPTIONS"
                      ],
                      "maxAgeInSeconds": 3600,
                      "exposedHeaders": [
                        "*"
                      ],
                      "allowedHeaders": [
                        "*"
                      ]
                    }
                  ]
                },
                "deleteRetentionPolicy": {
                  "enabled": true,
                  "days": 7
                },
                "containerDeleteRetentionPolicy": {
                  "enabled": true,
                  "days": 7
                },
                "changeFeed": {
                  "enabled": false
                },
                "restorePolicy": {
                  "enabled": false
                },
                "isVersioningEnabled": false
              },
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName'))]"
              ]
            },
            {
              "copy": {
                "name": "functionContainers_resource",
                "count": "[length(variables('functionContainers'))]"
              },
              "type": "Microsoft.Storage/storageAccounts/blobServices/containers",
              "apiVersion": "2023-01-01",
              "name": "[format('{0}/{1}/{2}', parameters('storageAccountName'), 'default', variables('functionContainers')[copyIndex()])]",
              "properties": {
                "publicAccess": "None",
                "metadata": {
                  "purpose": "function-apps"
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts/blobServices', parameters('storageAccountName'), 'default')]"
              ]
            },
            {
              "type": "Microsoft.Storage/storageAccounts/fileServices",
              "apiVersion": "2023-01-01",
              "name": "[format('{0}/{1}', parameters('storageAccountName'), 'default')]",
              "properties": {
                "cors": {
                  "corsRules": []
                },
                "shareDeleteRetentionPolicy": {
                  "enabled": true,
                  "days": 7
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName'))]"
              ]
            },
            {
              "copy": {
                "name": "privateEndpoints",
                "count": "[length(variables('storageServices'))]"
              },
              "condition": "[and(parameters('createPrivateEndpoint'), not(empty(variables('storageServices')[copyIndex()].dnsZoneId)))]",
              "type": "Microsoft.Network/privateEndpoints",
              "apiVersion": "2023-09-01",
              "name": "[format('{0}-{1}-pe', parameters('storageAccountName'), variables('storageServices')[copyIndex()].name)]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "subnet": {
                  "id": "[parameters('privateEndpointSubnetId')]"
                },
                "privateLinkServiceConnections": [
                  {
                    "name": "[format('{0}-{1}-pe-connection', parameters('storageAccountName'), variables('storageServices')[copyIndex()].name)]",
                    "properties": {
                      "privateLinkServiceId": "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName'))]",
                      "groupIds": [
                        "[variables('storageServices')[copyIndex()].name]"
                      ]
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName'))]"
              ]
            },
            {
              "copy": {
                "name": "privateDnsZoneGroups",
                "count": "[length(variables('storageServices'))]"
              },
              "condition": "[and(parameters('createPrivateEndpoint'), not(empty(variables('storageServices')[copyIndex()].dnsZoneId)))]",
              "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
              "apiVersion": "2023-09-01",
              "name": "[format('{0}/{1}', format('{0}-{1}-pe', parameters('storageAccountName'), variables('storageServices')[copyIndex()].name), 'default')]",
              "properties": {
                "privateDnsZoneConfigs": [
                  {
                    "name": "[format('{0}-config', variables('storageServices')[copyIndex()].name)]",
                    "properties": {
                      "privateDnsZoneId": "[variables('storageServices')[copyIndex()].dnsZoneId]"
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/privateEndpoints', format('{0}-{1}-pe', parameters('storageAccountName'), variables('storageServices')[copyIndex()].name))]"
              ]
            },
            {
              "copy": {
                "name": "roleAssignment",
                "count": "[length(parameters('roleAssignments'))]"
              },
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Storage/storageAccounts/{0}', parameters('storageAccountName'))]",
              "name": "[guid(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName')), parameters('roleAssignments')[copyIndex()].principalId, 'ba92f5b4-2d11-453d-a403-e96b0029c9fe')]",
              "properties": {
                "principalId": "[parameters('roleAssignments')[copyIndex()].principalId]",
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'ba92f5b4-2d11-453d-a403-e96b0029c9fe')]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName'))]"
              ]
            }
          ],
          "outputs": {
            "storageAccountId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName'))]"
            },
            "storageAccountName": {
              "type": "string",
              "value": "[parameters('storageAccountName')]"
            },
            "primaryEndpoints": {
              "type": "object",
              "value": "[reference(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName')), '2023-01-01').primaryEndpoints]"
            },
            "privateEndpoints": {
              "type": "array",
              "copy": {
                "count": "[length(variables('storageServices'))]",
                "input": {
                  "name": "[variables('storageServices')[copyIndex()].name]",
                  "id": "[if(and(parameters('createPrivateEndpoint'), not(empty(variables('storageServices')[copyIndex()].dnsZoneId))), resourceId('Microsoft.Network/privateEndpoints', format('{0}-{1}-pe', parameters('storageAccountName'), variables('storageServices')[copyIndex()].name)), '')]",
                  "hasPrivateEndpoint": "[and(parameters('createPrivateEndpoint'), not(empty(variables('storageServices')[copyIndex()].dnsZoneId)))]"
                }
              }
            },
            "hasPrivateEndpoints": {
              "type": "bool",
              "value": "[parameters('createPrivateEndpoint')]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'privateDnsZonesDeployment')]",
        "[resourceId('Microsoft.Resources/deployments', 'virtualNetworkDeployment')]"
      ]
    },
    {
      "condition": "[parameters('featureFlags').enableTestVM]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "testVMDeployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('general').location]"
          },
          "vmName": {
            "value": "test-vm"
          },
          "vmSize": {
            "value": "Standard_B1s"
          },
          "adminUsername": {
            "value": "[parameters('testVm').adminUsername]"
          },
          "adminPassword": {
            "value": "[parameters('vmAdminPassword')]"
          },
          "subnetId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'virtualNetworkDeployment'), '2022-09-01').outputs.testVMSubnetId.value]"
          },
          "includePublicIP": {
            "value": true
          },
          "tags": {
            "value": "[variables('commonTags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.37.4.10188",
              "templateHash": "9007766073568181120"
            }
          },
          "parameters": {
            "location": {
              "type": "string"
            },
            "vmName": {
              "type": "string"
            },
            "vmSize": {
              "type": "string",
              "defaultValue": "Standard_B1s"
            },
            "adminUsername": {
              "type": "string"
            },
            "adminPassword": {
              "type": "securestring"
            },
            "subnetId": {
              "type": "string"
            },
            "includePublicIP": {
              "type": "bool",
              "defaultValue": true
            },
            "computerName": {
              "type": "string",
              "defaultValue": "testvm"
            },
            "tags": {
              "type": "object",
              "defaultValue": {}
            }
          },
          "resources": [
            {
              "condition": "[parameters('includePublicIP')]",
              "type": "Microsoft.Network/publicIPAddresses",
              "apiVersion": "2023-09-01",
              "name": "[format('{0}-pip', parameters('vmName'))]",
              "location": "[parameters('location')]",
              "sku": {
                "name": "Standard",
                "tier": "Regional"
              },
              "properties": {
                "publicIPAllocationMethod": "Static"
              },
              "tags": "[parameters('tags')]"
            },
            {
              "type": "Microsoft.Network/networkSecurityGroups",
              "apiVersion": "2023-09-01",
              "name": "[format('{0}-nsg', parameters('vmName'))]",
              "location": "[parameters('location')]",
              "properties": {
                "securityRules": [
                  {
                    "name": "AllowRDPInbound",
                    "properties": {
                      "protocol": "Tcp",
                      "sourcePortRange": "*",
                      "destinationPortRange": "3389",
                      "sourceAddressPrefix": "*",
                      "destinationAddressPrefix": "*",
                      "access": "Allow",
                      "priority": 1000,
                      "direction": "Inbound"
                    }
                  },
                  {
                    "name": "AllowHTTPOutbound",
                    "properties": {
                      "protocol": "Tcp",
                      "sourcePortRange": "*",
                      "destinationPortRange": "80",
                      "sourceAddressPrefix": "*",
                      "destinationAddressPrefix": "*",
                      "access": "Allow",
                      "priority": 1000,
                      "direction": "Outbound"
                    }
                  },
                  {
                    "name": "AllowHTTPSOutbound",
                    "properties": {
                      "protocol": "Tcp",
                      "sourcePortRange": "*",
                      "destinationPortRange": "443",
                      "sourceAddressPrefix": "*",
                      "destinationAddressPrefix": "*",
                      "access": "Allow",
                      "priority": 1010,
                      "direction": "Outbound"
                    }
                  }
                ]
              },
              "tags": "[parameters('tags')]"
            },
            {
              "type": "Microsoft.Network/networkInterfaces",
              "apiVersion": "2023-09-01",
              "name": "[format('{0}-nic', parameters('vmName'))]",
              "location": "[parameters('location')]",
              "properties": {
                "ipConfigurations": [
                  {
                    "name": "ipconfig1",
                    "properties": {
                      "privateIPAllocationMethod": "Dynamic",
                      "subnet": {
                        "id": "[parameters('subnetId')]"
                      },
                      "publicIPAddress": "[if(parameters('includePublicIP'), createObject('id', resourceId('Microsoft.Network/publicIPAddresses', format('{0}-pip', parameters('vmName')))), null())]"
                    }
                  }
                ],
                "networkSecurityGroup": {
                  "id": "[resourceId('Microsoft.Network/networkSecurityGroups', format('{0}-nsg', parameters('vmName')))]"
                }
              },
              "tags": "[parameters('tags')]",
              "dependsOn": [
                "[resourceId('Microsoft.Network/networkSecurityGroups', format('{0}-nsg', parameters('vmName')))]",
                "[resourceId('Microsoft.Network/publicIPAddresses', format('{0}-pip', parameters('vmName')))]"
              ]
            },
            {
              "type": "Microsoft.Compute/virtualMachines",
              "apiVersion": "2023-09-01",
              "name": "[parameters('vmName')]",
              "location": "[parameters('location')]",
              "properties": {
                "hardwareProfile": {
                  "vmSize": "[parameters('vmSize')]"
                },
                "osProfile": {
                  "computerName": "[parameters('computerName')]",
                  "adminUsername": "[parameters('adminUsername')]",
                  "adminPassword": "[parameters('adminPassword')]",
                  "windowsConfiguration": {
                    "enableAutomaticUpdates": true,
                    "provisionVMAgent": true
                  }
                },
                "storageProfile": {
                  "imageReference": {
                    "publisher": "MicrosoftWindowsServer",
                    "offer": "WindowsServer",
                    "sku": "2022-datacenter",
                    "version": "latest"
                  },
                  "osDisk": {
                    "createOption": "FromImage",
                    "managedDisk": {
                      "storageAccountType": "Premium_LRS"
                    }
                  }
                },
                "networkProfile": {
                  "networkInterfaces": [
                    {
                      "id": "[resourceId('Microsoft.Network/networkInterfaces', format('{0}-nic', parameters('vmName')))]"
                    }
                  ]
                }
              },
              "tags": "[parameters('tags')]",
              "dependsOn": [
                "[resourceId('Microsoft.Network/networkInterfaces', format('{0}-nic', parameters('vmName')))]"
              ]
            }
          ],
          "outputs": {
            "vmId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Compute/virtualMachines', parameters('vmName'))]"
            },
            "vmName": {
              "type": "string",
              "value": "[parameters('vmName')]"
            },
            "vmPrivateIP": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Network/networkInterfaces', format('{0}-nic', parameters('vmName'))), '2023-09-01').ipConfigurations[0].properties.privateIPAddress]"
            },
            "vmNSGId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Network/networkSecurityGroups', format('{0}-nsg', parameters('vmName')))]"
            },
            "hasPublicIP": {
              "type": "bool",
              "value": "[parameters('includePublicIP')]"
            },
            "vmPublicIPResourceId": {
              "type": "string",
              "value": "[if(parameters('includePublicIP'), resourceId('Microsoft.Network/publicIPAddresses', format('{0}-pip', parameters('vmName'))), '')]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'virtualNetworkDeployment')]"
      ]
    }
  ],
  "outputs": {
    "sqlServerInfo": {
      "type": "object",
      "value": "[if(parameters('featureFlags').enableSqlServer, createObject('serverName', reference(resourceId('Microsoft.Resources/deployments', 'sqlServerDeployment'), '2022-09-01').outputs.sqlServerName.value, 'serverFqdn', reference(resourceId('Microsoft.Resources/deployments', 'sqlServerDeployment'), '2022-09-01').outputs.sqlServerFqdn.value, 'databaseNames', createArray(reference(resourceId('Microsoft.Resources/deployments', 'customerDatabaseDeployment'), '2022-09-01').outputs.databaseName.value, reference(resourceId('Microsoft.Resources/deployments', 'adminDatabaseDeployment'), '2022-09-01').outputs.databaseName.value, reference(resourceId('Microsoft.Resources/deployments', 'videoDatabaseDeployment'), '2022-09-01').outputs.databaseName.value, reference(resourceId('Microsoft.Resources/deployments', 'musicDatabaseDeployment'), '2022-09-01').outputs.databaseName.value)), createObject('serverName', '', 'serverFqdn', '', 'databaseNames', createArray()))]"
    },
    "webAppUrls": {
      "type": "array",
      "value": [
        {
          "name": "[parameters('webApps').apps.customerPublic]",
          "url": "[format('http://{0}.azurewebsites.net', parameters('webApps').apps.customerPublic)]"
        },
        {
          "name": "[parameters('webApps').apps.customerSite]",
          "url": "[format('http://{0}.azurewebsites.net', parameters('webApps').apps.customerSite)]"
        },
        {
          "name": "[parameters('webApps').apps.adminPublic]",
          "url": "[format('http://{0}.azurewebsites.net', parameters('webApps').apps.adminPublic)]"
        },
        {
          "name": "[parameters('webApps').apps.adminSite]",
          "url": "[format('http://{0}.azurewebsites.net', parameters('webApps').apps.adminSite)]"
        },
        {
          "name": "[parameters('webApps').apps.videoApi]",
          "url": "[format('http://{0}.azurewebsites.net', parameters('webApps').apps.videoApi)]"
        },
        {
          "name": "[parameters('webApps').apps.musicApi]",
          "url": "[format('http://{0}.azurewebsites.net', parameters('webApps').apps.musicApi)]"
        }
      ]
    },
    "testVMInfo": {
      "type": "object",
      "value": "[if(parameters('featureFlags').enableTestVM, createObject('vmName', reference(resourceId('Microsoft.Resources/deployments', 'testVMDeployment'), '2022-09-01').outputs.vmName.value, 'vmPrivateIP', reference(resourceId('Microsoft.Resources/deployments', 'testVMDeployment'), '2022-09-01').outputs.vmPrivateIP.value, 'hasPublicIP', reference(resourceId('Microsoft.Resources/deployments', 'testVMDeployment'), '2022-09-01').outputs.hasPublicIP.value, 'publicIPResourceId', reference(resourceId('Microsoft.Resources/deployments', 'testVMDeployment'), '2022-09-01').outputs.vmPublicIPResourceId.value), createObject('vmName', '', 'vmPrivateIP', '', 'hasPublicIP', false(), 'publicIPResourceId', ''))]"
    },
    "webAppsInfo": {
      "type": "array",
      "value": [
        {
          "index": 0,
          "name": "[reference(resourceId('Microsoft.Resources/deployments', 'customerPublicWebAppDeployment'), '2022-09-01').outputs.webAppName.value]",
          "id": "[reference(resourceId('Microsoft.Resources/deployments', 'customerPublicWebAppDeployment'), '2022-09-01').outputs.webAppId.value]",
          "defaultHostName": "[reference(resourceId('Microsoft.Resources/deployments', 'customerPublicWebAppDeployment'), '2022-09-01').outputs.defaultHostName.value]",
          "hasPrivateEndpoint": false,
          "privateEndpointId": "",
          "privateDnsName": "",
          "publicUrl": "[format('https://{0}', reference(resourceId('Microsoft.Resources/deployments', 'customerPublicWebAppDeployment'), '2022-09-01').outputs.defaultHostName.value)]",
          "isPublicAccessEnabled": true
        },
        {
          "index": 1,
          "name": "[reference(resourceId('Microsoft.Resources/deployments', 'customerSiteWebAppDeployment'), '2022-09-01').outputs.webAppName.value]",
          "id": "[reference(resourceId('Microsoft.Resources/deployments', 'customerSiteWebAppDeployment'), '2022-09-01').outputs.webAppId.value]",
          "defaultHostName": "[reference(resourceId('Microsoft.Resources/deployments', 'customerSiteWebAppDeployment'), '2022-09-01').outputs.defaultHostName.value]",
          "hasPrivateEndpoint": "[reference(resourceId('Microsoft.Resources/deployments', 'customerSiteWebAppDeployment'), '2022-09-01').outputs.hasPrivateEndpoint.value]",
          "privateEndpointId": "",
          "privateDnsName": "[format('{0}.privatelink.azurewebsites.net', reference(resourceId('Microsoft.Resources/deployments', 'customerSiteWebAppDeployment'), '2022-09-01').outputs.webAppName.value)]",
          "publicUrl": "[format('https://{0}', reference(resourceId('Microsoft.Resources/deployments', 'customerSiteWebAppDeployment'), '2022-09-01').outputs.defaultHostName.value)]",
          "isPublicAccessEnabled": false
        },
        {
          "index": 2,
          "name": "[reference(resourceId('Microsoft.Resources/deployments', 'adminPublicWebAppDeployment'), '2022-09-01').outputs.webAppName.value]",
          "id": "[reference(resourceId('Microsoft.Resources/deployments', 'adminPublicWebAppDeployment'), '2022-09-01').outputs.webAppId.value]",
          "defaultHostName": "[reference(resourceId('Microsoft.Resources/deployments', 'adminPublicWebAppDeployment'), '2022-09-01').outputs.defaultHostName.value]",
          "hasPrivateEndpoint": false,
          "privateEndpointId": "",
          "privateDnsName": "",
          "publicUrl": "[format('https://{0}', reference(resourceId('Microsoft.Resources/deployments', 'adminPublicWebAppDeployment'), '2022-09-01').outputs.defaultHostName.value)]",
          "isPublicAccessEnabled": true
        },
        {
          "index": 3,
          "name": "[reference(resourceId('Microsoft.Resources/deployments', 'adminSiteWebAppDeployment'), '2022-09-01').outputs.webAppName.value]",
          "id": "[reference(resourceId('Microsoft.Resources/deployments', 'adminSiteWebAppDeployment'), '2022-09-01').outputs.webAppId.value]",
          "defaultHostName": "[reference(resourceId('Microsoft.Resources/deployments', 'adminSiteWebAppDeployment'), '2022-09-01').outputs.defaultHostName.value]",
          "hasPrivateEndpoint": "[reference(resourceId('Microsoft.Resources/deployments', 'adminSiteWebAppDeployment'), '2022-09-01').outputs.hasPrivateEndpoint.value]",
          "privateEndpointId": "",
          "privateDnsName": "[format('{0}.privatelink.azurewebsites.net', reference(resourceId('Microsoft.Resources/deployments', 'adminSiteWebAppDeployment'), '2022-09-01').outputs.webAppName.value)]",
          "publicUrl": "[format('https://{0}', reference(resourceId('Microsoft.Resources/deployments', 'adminSiteWebAppDeployment'), '2022-09-01').outputs.defaultHostName.value)]",
          "isPublicAccessEnabled": false
        },
        {
          "index": 4,
          "name": "[reference(resourceId('Microsoft.Resources/deployments', 'videoApiWebAppDeployment'), '2022-09-01').outputs.webAppName.value]",
          "id": "[reference(resourceId('Microsoft.Resources/deployments', 'videoApiWebAppDeployment'), '2022-09-01').outputs.webAppId.value]",
          "defaultHostName": "[reference(resourceId('Microsoft.Resources/deployments', 'videoApiWebAppDeployment'), '2022-09-01').outputs.defaultHostName.value]",
          "hasPrivateEndpoint": "[reference(resourceId('Microsoft.Resources/deployments', 'videoApiWebAppDeployment'), '2022-09-01').outputs.hasPrivateEndpoint.value]",
          "privateEndpointId": "",
          "privateDnsName": "[format('{0}.privatelink.azurewebsites.net', reference(resourceId('Microsoft.Resources/deployments', 'videoApiWebAppDeployment'), '2022-09-01').outputs.webAppName.value)]",
          "publicUrl": "[format('https://{0}', reference(resourceId('Microsoft.Resources/deployments', 'videoApiWebAppDeployment'), '2022-09-01').outputs.defaultHostName.value)]",
          "isPublicAccessEnabled": false
        },
        {
          "index": 5,
          "name": "[reference(resourceId('Microsoft.Resources/deployments', 'musicApiWebAppDeployment'), '2022-09-01').outputs.webAppName.value]",
          "id": "[reference(resourceId('Microsoft.Resources/deployments', 'musicApiWebAppDeployment'), '2022-09-01').outputs.webAppId.value]",
          "defaultHostName": "[reference(resourceId('Microsoft.Resources/deployments', 'musicApiWebAppDeployment'), '2022-09-01').outputs.defaultHostName.value]",
          "hasPrivateEndpoint": "[reference(resourceId('Microsoft.Resources/deployments', 'musicApiWebAppDeployment'), '2022-09-01').outputs.hasPrivateEndpoint.value]",
          "privateEndpointId": "",
          "privateDnsName": "[format('{0}.privatelink.azurewebsites.net', reference(resourceId('Microsoft.Resources/deployments', 'musicApiWebAppDeployment'), '2022-09-01').outputs.webAppName.value)]",
          "publicUrl": "[format('https://{0}', reference(resourceId('Microsoft.Resources/deployments', 'musicApiWebAppDeployment'), '2022-09-01').outputs.defaultHostName.value)]",
          "isPublicAccessEnabled": false
        }
      ]
    },
    "internalDnsNames": {
      "type": "array",
      "value": []
    },
    "keyVaultInfo": {
      "type": "object",
      "value": "[if(parameters('featureFlags').enableKeyVault, createObject('keyVaultId', reference(resourceId('Microsoft.Resources/deployments', 'keyVaultDeployment'), '2022-09-01').outputs.keyVaultId.value, 'keyVaultName', reference(resourceId('Microsoft.Resources/deployments', 'keyVaultDeployment'), '2022-09-01').outputs.keyVaultName.value, 'keyVaultUri', reference(resourceId('Microsoft.Resources/deployments', 'keyVaultDeployment'), '2022-09-01').outputs.keyVaultUri.value, 'resourceGroup', reference(resourceId('Microsoft.Resources/deployments', 'keyVaultDeployment'), '2022-09-01').outputs.keyVaultResourceGroup.value), createObject('keyVaultId', '', 'keyVaultName', '', 'keyVaultUri', '', 'resourceGroup', ''))]"
    },
    "appConfigInfo": {
      "type": "object",
      "value": "[if(parameters('featureFlags').enableAppConfiguration, createObject('appConfigId', reference(resourceId('Microsoft.Resources/deployments', 'appConfigurationDeployment'), '2022-09-01').outputs.appConfigId.value, 'appConfigName', reference(resourceId('Microsoft.Resources/deployments', 'appConfigurationDeployment'), '2022-09-01').outputs.appConfigName.value, 'endpoint', reference(resourceId('Microsoft.Resources/deployments', 'appConfigurationDeployment'), '2022-09-01').outputs.endpoint.value, 'hasPrivateEndpoint', reference(resourceId('Microsoft.Resources/deployments', 'appConfigurationDeployment'), '2022-09-01').outputs.hasPrivateEndpoint.value, 'privateEndpointId', reference(resourceId('Microsoft.Resources/deployments', 'appConfigurationDeployment'), '2022-09-01').outputs.privateEndpointId.value, 'privateEndpointName', reference(resourceId('Microsoft.Resources/deployments', 'appConfigurationDeployment'), '2022-09-01').outputs.privateEndpointName.value), createObject('appConfigId', '', 'appConfigName', '', 'endpoint', '', 'hasPrivateEndpoint', false(), 'privateEndpointId', '', 'privateEndpointName', ''))]"
    },
    "storageAccountInfo": {
      "type": "object",
      "value": "[if(parameters('featureFlags').enableStorageAccount, createObject('storageAccountId', reference(resourceId('Microsoft.Resources/deployments', 'blobStorageDeployment'), '2022-09-01').outputs.storageAccountId.value, 'storageAccountName', reference(resourceId('Microsoft.Resources/deployments', 'blobStorageDeployment'), '2022-09-01').outputs.storageAccountName.value, 'blobEndpoint', reference(resourceId('Microsoft.Resources/deployments', 'blobStorageDeployment'), '2022-09-01').outputs.storageAccountPrimaryBlobEndpoint.value, 'containerNames', reference(resourceId('Microsoft.Resources/deployments', 'blobStorageDeployment'), '2022-09-01').outputs.containerNames.value, 'hasPrivateEndpoint', reference(resourceId('Microsoft.Resources/deployments', 'blobStorageDeployment'), '2022-09-01').outputs.hasPrivateEndpoint.value, 'privateEndpoints', reference(resourceId('Microsoft.Resources/deployments', 'blobStorageDeployment'), '2022-09-01').outputs.privateEndpoints.value), createObject('storageAccountId', '', 'storageAccountName', '', 'blobEndpoint', '', 'containerNames', createArray(), 'hasPrivateEndpoint', false(), 'privateEndpoints', createArray()))]"
    },
    "functionAppsStorageInfo": {
      "type": "object",
      "value": "[if(parameters('featureFlags').enableFunctionApps, createObject('storageAccountId', reference(resourceId('Microsoft.Resources/deployments', 'functionAppsStorageDeployment'), '2022-09-01').outputs.storageAccountId.value, 'storageAccountName', reference(resourceId('Microsoft.Resources/deployments', 'functionAppsStorageDeployment'), '2022-09-01').outputs.storageAccountName.value, 'primaryEndpoints', reference(resourceId('Microsoft.Resources/deployments', 'functionAppsStorageDeployment'), '2022-09-01').outputs.primaryEndpoints.value, 'hasPrivateEndpoint', reference(resourceId('Microsoft.Resources/deployments', 'functionAppsStorageDeployment'), '2022-09-01').outputs.hasPrivateEndpoints.value, 'privateEndpoints', reference(resourceId('Microsoft.Resources/deployments', 'functionAppsStorageDeployment'), '2022-09-01').outputs.privateEndpoints.value), createObject('storageAccountId', '', 'storageAccountName', '', 'primaryEndpoints', createObject(), 'hasPrivateEndpoint', false(), 'privateEndpoints', createArray()))]"
    },
    "cosmosDbInfo": {
      "type": "object",
      "value": "[if(parameters('featureFlags').enableCosmosDb, createObject('cosmosAccountId', reference(resourceId('Microsoft.Resources/deployments', 'cosmosDbAccountDeployment'), '2022-09-01').outputs.cosmosAccountId.value, 'cosmosAccountName', reference(resourceId('Microsoft.Resources/deployments', 'cosmosDbAccountDeployment'), '2022-09-01').outputs.cosmosAccountName.value, 'cosmosAccountEndpoint', reference(resourceId('Microsoft.Resources/deployments', 'cosmosDbAccountDeployment'), '2022-09-01').outputs.cosmosAccountEndpoint.value, 'databaseNames', createArray(parameters('cosmos').databases.admin.name, parameters('cosmos').databases.customer.name, parameters('cosmos').databases.music.name, parameters('cosmos').databases.video.name), 'adminDatabase', createObject('databaseId', reference(resourceId('Microsoft.Resources/deployments', 'cosmosAdminDatabaseDeployment'), '2022-09-01').outputs.databaseId.value, 'databaseName', reference(resourceId('Microsoft.Resources/deployments', 'cosmosAdminDatabaseDeployment'), '2022-09-01').outputs.databaseName.value, 'containerNames', createArray(reference(resourceId('Microsoft.Resources/deployments', 'cosmosAdminDatabaseDeployment'), '2022-09-01').outputs.adminContainerName.value)), 'customerDatabase', createObject('databaseId', reference(resourceId('Microsoft.Resources/deployments', 'cosmosCustomerDatabaseDeployment'), '2022-09-01').outputs.databaseId.value, 'databaseName', reference(resourceId('Microsoft.Resources/deployments', 'cosmosCustomerDatabaseDeployment'), '2022-09-01').outputs.databaseName.value, 'containerNames', createArray(reference(resourceId('Microsoft.Resources/deployments', 'cosmosCustomerDatabaseDeployment'), '2022-09-01').outputs.customerContainerName.value)), 'musicDatabase', createObject('databaseId', reference(resourceId('Microsoft.Resources/deployments', 'cosmosMusicDatabaseDeployment'), '2022-09-01').outputs.databaseId.value, 'databaseName', reference(resourceId('Microsoft.Resources/deployments', 'cosmosMusicDatabaseDeployment'), '2022-09-01').outputs.databaseName.value, 'containerNames', createArray(reference(resourceId('Microsoft.Resources/deployments', 'cosmosMusicDatabaseDeployment'), '2022-09-01').outputs.musicContainerName.value)), 'videoDatabase', createObject('databaseId', reference(resourceId('Microsoft.Resources/deployments', 'cosmosVideoDatabaseDeployment'), '2022-09-01').outputs.databaseId.value, 'databaseName', reference(resourceId('Microsoft.Resources/deployments', 'cosmosVideoDatabaseDeployment'), '2022-09-01').outputs.databaseName.value, 'containerNames', createArray(reference(resourceId('Microsoft.Resources/deployments', 'cosmosVideoDatabaseDeployment'), '2022-09-01').outputs.videoContainerName.value)), 'hasPrivateEndpoint', reference(resourceId('Microsoft.Resources/deployments', 'cosmosDbAccountDeployment'), '2022-09-01').outputs.hasPrivateEndpoint.value, 'privateEndpointId', reference(resourceId('Microsoft.Resources/deployments', 'cosmosDbAccountDeployment'), '2022-09-01').outputs.privateEndpointId.value, 'privateEndpointName', reference(resourceId('Microsoft.Resources/deployments', 'cosmosDbAccountDeployment'), '2022-09-01').outputs.privateEndpointName.value), createObject('cosmosAccountId', '', 'cosmosAccountName', '', 'cosmosAccountEndpoint', '', 'databaseNames', createArray(), 'adminDatabase', createObject(), 'customerDatabase', createObject(), 'musicDatabase', createObject(), 'videoDatabase', createObject(), 'hasPrivateEndpoint', false(), 'privateEndpointId', '', 'privateEndpointName', ''))]"
    },
    "functionAppsInfo": {
      "type": "object",
      "value": "[if(parameters('featureFlags').enableFunctionApps, createObject('adminFunctionApp', createObject('functionAppId', reference(resourceId('Microsoft.Resources/deployments', 'adminFunctionAppDeployment'), '2022-09-01').outputs.functionAppId.value, 'functionAppName', reference(resourceId('Microsoft.Resources/deployments', 'adminFunctionAppDeployment'), '2022-09-01').outputs.functionAppName.value, 'functionAppUrl', reference(resourceId('Microsoft.Resources/deployments', 'adminFunctionAppDeployment'), '2022-09-01').outputs.functionAppUrl.value, 'hasPrivateEndpoint', false()), 'customerFunctionApp', createObject('functionAppId', reference(resourceId('Microsoft.Resources/deployments', 'customerFunctionAppDeployment'), '2022-09-01').outputs.functionAppId.value, 'functionAppName', reference(resourceId('Microsoft.Resources/deployments', 'customerFunctionAppDeployment'), '2022-09-01').outputs.functionAppName.value, 'functionAppUrl', reference(resourceId('Microsoft.Resources/deployments', 'customerFunctionAppDeployment'), '2022-09-01').outputs.functionAppUrl.value, 'hasPrivateEndpoint', false()), 'musicFunctionApp', createObject('functionAppId', reference(resourceId('Microsoft.Resources/deployments', 'musicFunctionAppDeployment'), '2022-09-01').outputs.functionAppId.value, 'functionAppName', reference(resourceId('Microsoft.Resources/deployments', 'musicFunctionAppDeployment'), '2022-09-01').outputs.functionAppName.value, 'functionAppUrl', reference(resourceId('Microsoft.Resources/deployments', 'musicFunctionAppDeployment'), '2022-09-01').outputs.functionAppUrl.value, 'hasPrivateEndpoint', false()), 'videoFunctionApp', createObject('functionAppId', reference(resourceId('Microsoft.Resources/deployments', 'videoFunctionAppDeployment'), '2022-09-01').outputs.functionAppId.value, 'functionAppName', reference(resourceId('Microsoft.Resources/deployments', 'videoFunctionAppDeployment'), '2022-09-01').outputs.functionAppName.value, 'functionAppUrl', reference(resourceId('Microsoft.Resources/deployments', 'videoFunctionAppDeployment'), '2022-09-01').outputs.functionAppUrl.value, 'hasPrivateEndpoint', false())), createObject('adminFunctionApp', createObject(), 'customerFunctionApp', createObject(), 'musicFunctionApp', createObject(), 'videoFunctionApp', createObject()))]"
    },
    "serviceBusInfo": {
      "type": "object",
      "value": "[if(parameters('featureFlags').enableServiceBus, createObject('namespaceName', reference(resourceId('Microsoft.Resources/deployments', 'serviceBusNamespaceDeployment'), '2022-09-01').outputs.serviceBusNamespaceName.value, 'namespaceId', reference(resourceId('Microsoft.Resources/deployments', 'serviceBusNamespaceDeployment'), '2022-09-01').outputs.serviceBusNamespaceId.value, 'hostName', reference(resourceId('Microsoft.Resources/deployments', 'serviceBusNamespaceDeployment'), '2022-09-01').outputs.serviceBusNamespaceHostName.value, 'hasPrivateEndpoint', reference(resourceId('Microsoft.Resources/deployments', 'serviceBusNamespaceDeployment'), '2022-09-01').outputs.hasPrivateEndpoint.value, 'privateEndpointId', reference(resourceId('Microsoft.Resources/deployments', 'serviceBusNamespaceDeployment'), '2022-09-01').outputs.privateEndpointId.value, 'privateEndpointName', reference(resourceId('Microsoft.Resources/deployments', 'serviceBusNamespaceDeployment'), '2022-09-01').outputs.privateEndpointName.value, 'topicNames', parameters('serviceBus').topics, 'queueNames', parameters('serviceBus').queues, 'subscriptionNames', parameters('serviceBus').subscriptions), createObject('namespaceName', '', 'namespaceId', '', 'hostName', '', 'hasPrivateEndpoint', false(), 'privateEndpointId', '', 'privateEndpointName', '', 'topicNames', createArray(), 'queueNames', createArray(), 'subscriptionNames', createArray()))]"
    },
    "applicationInsightsInfo": {
      "type": "object",
      "value": "[if(parameters('featureFlags').enableApplicationInsights, createObject('logAnalyticsWorkspaceId', reference(resourceId('Microsoft.Resources/deployments', 'logAnalyticsWorkspaceDeployment'), '2022-09-01').outputs.workspaceId.value, 'logAnalyticsWorkspaceName', reference(resourceId('Microsoft.Resources/deployments', 'logAnalyticsWorkspaceDeployment'), '2022-09-01').outputs.workspaceName.value, 'webApps', createObject('customerSite', createObject('appInsightsId', reference(resourceId('Microsoft.Resources/deployments', 'applicationInsightsDeployment'), '2022-09-01').outputs.customerAppInsights.value.applicationInsightsId, 'appInsightsName', reference(resourceId('Microsoft.Resources/deployments', 'applicationInsightsDeployment'), '2022-09-01').outputs.customerAppInsights.value.applicationInsightsName, 'connectionString', reference(resourceId('Microsoft.Resources/deployments', 'applicationInsightsDeployment'), '2022-09-01').outputs.customerAppInsights.value.connectionString, 'instrumentationKey', reference(resourceId('Microsoft.Resources/deployments', 'applicationInsightsDeployment'), '2022-09-01').outputs.customerAppInsights.value.instrumentationKey), 'adminSite', createObject('appInsightsId', reference(resourceId('Microsoft.Resources/deployments', 'applicationInsightsDeployment'), '2022-09-01').outputs.adminAppInsights.value.applicationInsightsId, 'appInsightsName', reference(resourceId('Microsoft.Resources/deployments', 'applicationInsightsDeployment'), '2022-09-01').outputs.adminAppInsights.value.applicationInsightsName, 'connectionString', reference(resourceId('Microsoft.Resources/deployments', 'applicationInsightsDeployment'), '2022-09-01').outputs.adminAppInsights.value.connectionString, 'instrumentationKey', reference(resourceId('Microsoft.Resources/deployments', 'applicationInsightsDeployment'), '2022-09-01').outputs.adminAppInsights.value.instrumentationKey), 'videoApi', createObject('appInsightsId', reference(resourceId('Microsoft.Resources/deployments', 'applicationInsightsDeployment'), '2022-09-01').outputs.videoAppInsights.value.applicationInsightsId, 'appInsightsName', reference(resourceId('Microsoft.Resources/deployments', 'applicationInsightsDeployment'), '2022-09-01').outputs.videoAppInsights.value.applicationInsightsName, 'connectionString', reference(resourceId('Microsoft.Resources/deployments', 'applicationInsightsDeployment'), '2022-09-01').outputs.videoAppInsights.value.connectionString, 'instrumentationKey', reference(resourceId('Microsoft.Resources/deployments', 'applicationInsightsDeployment'), '2022-09-01').outputs.videoAppInsights.value.instrumentationKey), 'musicApi', createObject('appInsightsId', reference(resourceId('Microsoft.Resources/deployments', 'applicationInsightsDeployment'), '2022-09-01').outputs.musicAppInsights.value.applicationInsightsId, 'appInsightsName', reference(resourceId('Microsoft.Resources/deployments', 'applicationInsightsDeployment'), '2022-09-01').outputs.musicAppInsights.value.applicationInsightsName, 'connectionString', reference(resourceId('Microsoft.Resources/deployments', 'applicationInsightsDeployment'), '2022-09-01').outputs.musicAppInsights.value.connectionString, 'instrumentationKey', reference(resourceId('Microsoft.Resources/deployments', 'applicationInsightsDeployment'), '2022-09-01').outputs.musicAppInsights.value.instrumentationKey))), createObject('logAnalyticsWorkspaceId', '', 'logAnalyticsWorkspaceName', '', 'webApps', createObject()))]"
    }
  }
}